{
  "slug": "prometheus",
  "meta": {
    "title": "Prometheus",
    "description": "Prometheus 監視システム、メトリクス収集とアラート設定",
    "order": 1,
    "tags": [
      "Prometheus",
      "監視",
      "メトリクス",
      "アラート"
    ]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "コアコンセプト",
      "items": [
        "Prometheus はオープンソースの監視とアラートシステム",
        "Pull モードで主動的にメトリクスデータを収集",
        "時系列データベースに保存、効率的なクエリ",
        "PromQL 強力なクエリ言語"
      ]
    },
    {
      "type": "flow",
      "title": "アーキテクチャコンポーネント",
      "direction": "horizontal",
      "steps": [
        {
          "label": "Targets",
          "description": "アプリ/Exporter",
          "color": "bg-blue-500"
        },
        {
          "label": "Prometheus",
          "description": "収集・保存",
          "color": "bg-orange-500"
        },
        {
          "label": "Alertmanager",
          "description": "アラート管理",
          "color": "bg-red-500"
        },
        {
          "label": "Grafana",
          "description": "可視化",
          "color": "bg-green-500"
        }
      ]
    },
    {
      "type": "cards",
      "title": "メトリクスタイプ",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "Counter",
          "badge": "カウンター",
          "badgeColor": "blue",
          "points": [
            "増加のみ",
            "リクエスト数、エラー数",
            "rate() で増加率を計算"
          ]
        },
        {
          "title": "Gauge",
          "badge": "ゲージ",
          "badgeColor": "green",
          "points": [
            "増減可能",
            "CPU、メモリ使用量",
            "現在値クエリ"
          ]
        },
        {
          "title": "Histogram",
          "badge": "ヒストグラム",
          "badgeColor": "purple",
          "points": [
            "分布統計",
            "リクエストレイテンシ分布",
            "histogram_quantile()"
          ]
        },
        {
          "title": "Summary",
          "badge": "サマリー",
          "badgeColor": "amber",
          "points": [
            "クライアント側で分位数計算",
            "事前定義パーセンタイル",
            "集約不可"
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "prometheus.yml 設定",
      "language": "yaml",
      "code": "global:\n  scrape_interval: 15s\n  evaluation_interval: 15s\n\nalerting:\n  alertmanagers:\n    - static_configs:\n        - targets: ['alertmanager:9093']\n\nrule_files:\n  - \"alerts/*.yml\"\n\nscrape_configs:\n  - job_name: 'prometheus'\n    static_configs:\n      - targets: ['localhost:9090']\n\n  - job_name: 'node'\n    static_configs:\n      - targets: ['node-exporter:9100']\n\n  - job_name: 'kubernetes-pods'\n    kubernetes_sd_configs:\n      - role: pod\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]\n        action: keep\n        regex: true"
    },
    {
      "type": "codeBlock",
      "title": "PromQL クエリ",
      "language": "promql",
      "code": "# リクエストレート (毎秒)\nrate(http_requests_total[5m])\n\n# エラー率\nsum(rate(http_requests_total{status=~\"5..\"}[5m])) \n/ sum(rate(http_requests_total[5m]))\n\n# P99 レイテンシ\nhistogram_quantile(0.99, \n  sum(rate(http_request_duration_seconds_bucket[5m])) by (le)\n)\n\n# CPU 使用率\n100 - (avg by(instance) (irate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)\n\n# メモリ使用率\n(1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100"
    },
    {
      "type": "codeBlock",
      "title": "アラートルール",
      "language": "yaml",
      "code": "groups:\n  - name: application\n    rules:\n      - alert: HighErrorRate\n        expr: |\n          sum(rate(http_requests_total{status=~\"5..\"}[5m])) \n          / sum(rate(http_requests_total[5m])) > 0.05\n        for: 5m\n        labels:\n          severity: critical\n        annotations:\n          summary: \"High error rate detected\"\n          description: \"Error rate is {{ $value | humanizePercentage }}\"\n\n      - alert: HighLatency\n        expr: |\n          histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 1\n        for: 10m\n        labels:\n          severity: warning\n        annotations:\n          summary: \"High latency detected\""
    },
    {
      "type": "table",
      "title": "よく使う Exporter",
      "highlightFirst": true,
      "headers": [
        "Exporter",
        "用途",
        "ポート"
      ],
      "rows": [
        [
          "node_exporter",
          "ホストメトリクス",
          "9100"
        ],
        [
          "blackbox_exporter",
          "プローブ検出",
          "9115"
        ],
        [
          "mysql_exporter",
          "MySQL メトリクス",
          "9104"
        ],
        [
          "redis_exporter",
          "Redis メトリクス",
          "9121"
        ],
        [
          "nginx_exporter",
          "Nginx メトリクス",
          "9113"
        ]
      ]
    },
    {
      "type": "list",
      "title": "ベストプラクティス",
      "style": "check",
      "items": [
        {
          "label": "適切なラベル",
          "description": "高カーディナリティラベルによる性能問題を回避"
        },
        {
          "label": "Recording Rules",
          "description": "よく使うクエリを事前計算し、性能向上"
        },
        {
          "label": "フェデレーション",
          "description": "大規模デプロイには階層アーキテクチャを使用"
        },
        {
          "label": "永続化ストレージ",
          "description": "長期メトリクスデータをリモートストレージに保存"
        }
      ]
    }
  ],
  "relatedTopics": [
    "Grafana",
    "Kubernetes",
    "アラート"
  ]
}