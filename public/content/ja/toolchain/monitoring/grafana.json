{
  "slug": "grafana",
  "meta": {
    "title": "Grafana",
    "description": "Grafana 可視化プラットフォーム、ダッシュボード設計とアラート設定",
    "order": 2,
    "tags": [
      "toolchain",
      "monitoring",
      "grafana",
      "visualization"
    ]
  },
  "content": "<h1>Grafana</h1>\n<h2>Grafana 概要</h2>\n<p>Grafana はオープンソースのデータ可視化・監視プラットフォームで、複数のデータソースをサポートし、豊富なグラフとアラート機能を提供します。</p>\n<pre><code>Grafana 特性\n├── マルチデータソース - Prometheus, InfluxDB, Elasticsearch\n├── 豊富なグラフ - 時系列グラフ、テーブル、ヒートマップ\n├── ダッシュボード - ドラッグ＆ドロップ、テンプレート化\n├── アラート - マルチチャネル通知\n├── 権限 - チーム、ロール管理\n└── プラグイン - 拡張エコシステム\n</code></pre>\n<h2>データソース設定</h2>\n<h3>Prometheus データソース</h3>\n<pre><code class=\"language-yaml\"># provisioning/datasources/prometheus.yaml\napiVersion: 1\n\ndatasources:\n  - name: Prometheus\n    type: prometheus\n    access: proxy\n    url: http://prometheus:9090\n    isDefault: true\n    jsonData:\n      timeInterval: \"15s\"\n      httpMethod: POST\n\n  - name: Prometheus-Prod\n    type: prometheus\n    access: proxy\n    url: http://prometheus-prod:9090\n    jsonData:\n      timeInterval: \"15s\"\n</code></pre>\n<h3>その他のデータソース</h3>\n<pre><code class=\"language-yaml\">datasources:\n  # Elasticsearch\n  - name: Elasticsearch\n    type: elasticsearch\n    url: http://elasticsearch:9200\n    database: \"logs-*\"\n    jsonData:\n      esVersion: \"8.0.0\"\n      timeField: \"@timestamp\"\n\n  # InfluxDB\n  - name: InfluxDB\n    type: influxdb\n    url: http://influxdb:8086\n    jsonData:\n      version: Flux\n      organization: myorg\n      defaultBucket: metrics\n\n  # MySQL\n  - name: MySQL\n    type: mysql\n    url: mysql:3306\n    database: metrics\n    user: grafana\n    secureJsonData:\n      password: $MYSQL_PASSWORD\n</code></pre>\n<h2>ダッシュボード設計</h2>\n<h3>JSON モデル</h3>\n<pre><code class=\"language-json\">{\n  \"dashboard\": {\n    \"title\": \"Application Dashboard\",\n    \"tags\": [\"application\", \"monitoring\"],\n    \"timezone\": \"browser\",\n    \"refresh\": \"30s\",\n    \"time\": {\n      \"from\": \"now-1h\",\n      \"to\": \"now\"\n    },\n    \"panels\": [\n      {\n        \"title\": \"Request Rate\",\n        \"type\": \"timeseries\",\n        \"gridPos\": {\"x\": 0, \"y\": 0, \"w\": 12, \"h\": 8},\n        \"targets\": [\n          {\n            \"expr\": \"sum(rate(http_requests_total[5m])) by (service)\",\n            \"legendFormat\": \"{{service}}\"\n          }\n        ],\n        \"fieldConfig\": {\n          \"defaults\": {\n            \"unit\": \"reqps\",\n            \"custom\": {\n              \"lineWidth\": 2,\n              \"fillOpacity\": 10\n            }\n          }\n        }\n      },\n      {\n        \"title\": \"Error Rate\",\n        \"type\": \"stat\",\n        \"gridPos\": {\"x\": 12, \"y\": 0, \"w\": 6, \"h\": 4},\n        \"targets\": [\n          {\n            \"expr\": \"sum(rate(http_requests_total{status=~\\\"5..\\\"}[5m])) / sum(rate(http_requests_total[5m])) * 100\"\n          }\n        ],\n        \"fieldConfig\": {\n          \"defaults\": {\n            \"unit\": \"percent\",\n            \"thresholds\": {\n              \"steps\": [\n                {\"value\": null, \"color\": \"green\"},\n                {\"value\": 1, \"color\": \"yellow\"},\n                {\"value\": 5, \"color\": \"red\"}\n              ]\n            }\n          }\n        }\n      }\n    ]\n  }\n}\n</code></pre>\n<h3>変数テンプレート</h3>\n<pre><code class=\"language-json\">{\n  \"templating\": {\n    \"list\": [\n      {\n        \"name\": \"datasource\",\n        \"type\": \"datasource\",\n        \"query\": \"prometheus\"\n      },\n      {\n        \"name\": \"service\",\n        \"type\": \"query\",\n        \"datasource\": \"$datasource\",\n        \"query\": \"label_values(http_requests_total, service)\",\n        \"multi\": true,\n        \"includeAll\": true\n      },\n      {\n        \"name\": \"instance\",\n        \"type\": \"query\",\n        \"datasource\": \"$datasource\",\n        \"query\": \"label_values(http_requests_total{service=~\\\"$service\\\"}, instance)\",\n        \"multi\": true\n      },\n      {\n        \"name\": \"interval\",\n        \"type\": \"interval\",\n        \"options\": [\n          {\"text\": \"1m\", \"value\": \"1m\"},\n          {\"text\": \"5m\", \"value\": \"5m\"},\n          {\"text\": \"10m\", \"value\": \"10m\"}\n        ],\n        \"auto\": true,\n        \"auto_min\": \"10s\"\n      }\n    ]\n  }\n}\n</code></pre>\n<h2>一般的なパネル</h2>\n<h3>時系列グラフ</h3>\n<pre><code class=\"language-json\">{\n  \"title\": \"Response Time\",\n  \"type\": \"timeseries\",\n  \"targets\": [\n    {\n      \"expr\": \"histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket{service=\\\"$service\\\"}[$interval])) by (le))\",\n      \"legendFormat\": \"P50\"\n    },\n    {\n      \"expr\": \"histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service=\\\"$service\\\"}[$interval])) by (le))\",\n      \"legendFormat\": \"P95\"\n    },\n    {\n      \"expr\": \"histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{service=\\\"$service\\\"}[$interval])) by (le))\",\n      \"legendFormat\": \"P99\"\n    }\n  ],\n  \"fieldConfig\": {\n    \"defaults\": {\n      \"unit\": \"s\",\n      \"custom\": {\n        \"drawStyle\": \"line\",\n        \"lineInterpolation\": \"smooth\"\n      }\n    }\n  }\n}\n</code></pre>\n<h3>テーブル</h3>\n<pre><code class=\"language-json\">{\n  \"title\": \"Top Endpoints\",\n  \"type\": \"table\",\n  \"targets\": [\n    {\n      \"expr\": \"topk(10, sum(rate(http_requests_total[$interval])) by (path))\",\n      \"format\": \"table\",\n      \"instant\": true\n    }\n  ],\n  \"transformations\": [\n    {\n      \"id\": \"organize\",\n      \"options\": {\n        \"renameByName\": {\n          \"path\": \"Endpoint\",\n          \"Value\": \"Requests/s\"\n        }\n      }\n    }\n  ]\n}\n</code></pre>\n<h3>ヒートマップ</h3>\n<pre><code class=\"language-json\">{\n  \"title\": \"Request Latency Heatmap\",\n  \"type\": \"heatmap\",\n  \"targets\": [\n    {\n      \"expr\": \"sum(increase(http_request_duration_seconds_bucket[$interval])) by (le)\",\n      \"format\": \"heatmap\"\n    }\n  ],\n  \"options\": {\n    \"calculate\": false,\n    \"yAxis\": {\n      \"unit\": \"s\"\n    },\n    \"color\": {\n      \"scheme\": \"Oranges\"\n    }\n  }\n}\n</code></pre>\n<h2>アラート設定</h2>\n<h3>Grafana アラート</h3>\n<pre><code class=\"language-yaml\"># provisioning/alerting/rules.yaml\napiVersion: 1\n\ngroups:\n  - orgId: 1\n    name: Application Alerts\n    folder: Alerts\n    interval: 1m\n    rules:\n      - uid: high-error-rate\n        title: High Error Rate\n        condition: C\n        data:\n          - refId: A\n            relativeTimeRange:\n              from: 300\n              to: 0\n            datasourceUid: prometheus\n            model:\n              expr: sum(rate(http_requests_total{status=~\"5..\"}[5m])) / sum(rate(http_requests_total[5m]))\n          - refId: B\n            relativeTimeRange:\n              from: 300\n              to: 0\n            datasourceUid: __expr__\n            model:\n              type: reduce\n              expression: A\n              reducer: last\n          - refId: C\n            datasourceUid: __expr__\n            model:\n              type: threshold\n              expression: B\n              conditions:\n                - evaluator:\n                    type: gt\n                    params: [0.05]\n        for: 5m\n        labels:\n          severity: critical\n        annotations:\n          summary: \"High error rate detected\"\n</code></pre>\n<h3>通知チャネル</h3>\n<pre><code class=\"language-yaml\"># provisioning/alerting/contactpoints.yaml\napiVersion: 1\n\ncontactPoints:\n  - orgId: 1\n    name: slack-alerts\n    receivers:\n      - uid: slack\n        type: slack\n        settings:\n          url: https://hooks.slack.com/services/xxx\n          recipient: \"#alerts\"\n\n  - orgId: 1\n    name: pagerduty\n    receivers:\n      - uid: pagerduty\n        type: pagerduty\n        settings:\n          integrationKey: xxx\n          severity: critical\n</code></pre>\n<h2>ダッシュボード as コード</h2>\n<pre><code class=\"language-yaml\"># provisioning/dashboards/dashboards.yaml\napiVersion: 1\n\nproviders:\n  - name: 'default'\n    orgId: 1\n    folder: ''\n    type: file\n    disableDeletion: false\n    updateIntervalSeconds: 10\n    options:\n      path: /var/lib/grafana/dashboards\n</code></pre>\n<h2>まとめ</h2>\n<p>Grafana のポイント：</p>\n<ol>\n<li><strong>データソース</strong> - 複数データソースサポート、統一可視化</li>\n<li><strong>パネル</strong> - 時系列グラフ、テーブル、ヒートマップ等</li>\n<li><strong>変数</strong> - 動的フィルタリング、テンプレート化ダッシュボード</li>\n<li><strong>アラート</strong> - マルチチャネル通知、ルール管理</li>\n<li><strong>Provisioning</strong> - 設定 as コード</li>\n</ol>\n"
}