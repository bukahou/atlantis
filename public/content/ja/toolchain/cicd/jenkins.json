{
  "slug": "jenkins",
  "meta": {
    "title": "Jenkins",
    "description": "Jenkins 継続的インテグレーション、Pipeline と自動デプロイ",
    "order": 2,
    "tags": [
      "toolchain",
      "cicd",
      "jenkins",
      "automation"
    ]
  },
  "content": "<h1>Jenkins</h1>\n<h2>Jenkins 概要</h2>\n<p>Jenkins はオープンソースの自動化サーバーで、ソフトウェアプロジェクトのビルド、テスト、デプロイの継続的インテグレーションと継続的デリバリーをサポートします。</p>\n<pre><code>Jenkins アーキテクチャ\n├── Master - 制御ノード\n│   ├── タスクスケジューリング\n│   ├── 設定管理\n│   └── Web インターフェース\n├── Agent - 実行ノード\n│   ├── ビルド実行\n│   └── 分散ビルド\n└── Plugin - プラグインエコシステム\n    ├── ソースコード管理\n    ├── ビルドツール\n    └── デプロイ統合\n</code></pre>\n<h2>Pipeline</h2>\n<h3>宣言的 Pipeline</h3>\n<pre><code class=\"language-groovy\">// Jenkinsfile\npipeline {\n    agent any\n\n    environment {\n        GO_VERSION = '1.21'\n        DOCKER_REGISTRY = 'registry.example.com'\n    }\n\n    options {\n        timeout(time: 1, unit: 'HOURS')\n        disableConcurrentBuilds()\n        buildDiscarder(logRotator(numToKeepStr: '10'))\n    }\n\n    stages {\n        stage('Checkout') {\n            steps {\n                checkout scm\n            }\n        }\n\n        stage('Build') {\n            steps {\n                sh 'go build -o app ./...'\n            }\n        }\n\n        stage('Test') {\n            steps {\n                sh 'go test -v -coverprofile=coverage.out ./...'\n            }\n            post {\n                always {\n                    publishCoverage adapters: [coberturaAdapter('coverage.xml')]\n                }\n            }\n        }\n\n        stage('Docker Build') {\n            when {\n                branch 'main'\n            }\n            steps {\n                script {\n                    docker.build(\"${DOCKER_REGISTRY}/myapp:${BUILD_NUMBER}\")\n                }\n            }\n        }\n\n        stage('Deploy') {\n            when {\n                branch 'main'\n            }\n            steps {\n                script {\n                    docker.withRegistry(\"https://${DOCKER_REGISTRY}\", 'docker-credentials') {\n                        docker.image(\"${DOCKER_REGISTRY}/myapp:${BUILD_NUMBER}\").push()\n                    }\n                }\n            }\n        }\n    }\n\n    post {\n        success {\n            slackSend(color: 'good', message: \"Build ${BUILD_NUMBER} succeeded\")\n        }\n        failure {\n            slackSend(color: 'danger', message: \"Build ${BUILD_NUMBER} failed\")\n        }\n    }\n}\n</code></pre>\n<h3>スクリプト式 Pipeline</h3>\n<pre><code class=\"language-groovy\">node {\n    def app\n\n    stage('Clone') {\n        checkout scm\n    }\n\n    stage('Build') {\n        app = docker.build(\"myapp:${env.BUILD_ID}\")\n    }\n\n    stage('Test') {\n        app.inside {\n            sh 'go test ./...'\n        }\n    }\n\n    stage('Push') {\n        docker.withRegistry('https://registry.example.com', 'docker-credentials') {\n            app.push(\"${env.BUILD_NUMBER}\")\n            app.push(\"latest\")\n        }\n    }\n\n    stage('Deploy') {\n        if (env.BRANCH_NAME == 'main') {\n            sh 'kubectl set image deployment/myapp myapp=myapp:${BUILD_NUMBER}'\n        }\n    }\n}\n</code></pre>\n<h2>マルチブランチ Pipeline</h2>\n<pre><code class=\"language-groovy\">// マルチブランチ設定\npipeline {\n    agent any\n\n    stages {\n        stage('Build') {\n            steps {\n                echo \"Building branch: ${env.BRANCH_NAME}\"\n                sh 'make build'\n            }\n        }\n\n        stage('Test') {\n            steps {\n                sh 'make test'\n            }\n        }\n\n        stage('Deploy to Staging') {\n            when {\n                branch 'develop'\n            }\n            steps {\n                sh 'make deploy-staging'\n            }\n        }\n\n        stage('Deploy to Production') {\n            when {\n                branch 'main'\n            }\n            steps {\n                input message: 'Deploy to production?'\n                sh 'make deploy-production'\n            }\n        }\n    }\n}\n</code></pre>\n<h2>並列ビルド</h2>\n<pre><code class=\"language-groovy\">pipeline {\n    agent any\n\n    stages {\n        stage('Parallel Tests') {\n            parallel {\n                stage('Unit Tests') {\n                    steps {\n                        sh 'go test -v ./pkg/...'\n                    }\n                }\n                stage('Integration Tests') {\n                    steps {\n                        sh 'go test -v ./integration/...'\n                    }\n                }\n                stage('E2E Tests') {\n                    agent {\n                        docker {\n                            image 'cypress/browsers:latest'\n                        }\n                    }\n                    steps {\n                        sh 'npm run test:e2e'\n                    }\n                }\n            }\n        }\n\n        stage('Build Matrix') {\n            matrix {\n                axes {\n                    axis {\n                        name 'PLATFORM'\n                        values 'linux', 'darwin', 'windows'\n                    }\n                    axis {\n                        name 'ARCH'\n                        values 'amd64', 'arm64'\n                    }\n                }\n                excludes {\n                    exclude {\n                        axis {\n                            name 'PLATFORM'\n                            values 'windows'\n                        }\n                        axis {\n                            name 'ARCH'\n                            values 'arm64'\n                        }\n                    }\n                }\n                stages {\n                    stage('Build') {\n                        steps {\n                            sh \"GOOS=${PLATFORM} GOARCH=${ARCH} go build -o app-${PLATFORM}-${ARCH}\"\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n</code></pre>\n<h2>共有ライブラリ</h2>\n<pre><code class=\"language-groovy\">// vars/buildGo.groovy\ndef call(Map config = [:]) {\n    def goVersion = config.goVersion ?: '1.21'\n\n    pipeline {\n        agent any\n\n        tools {\n            go \"go-${goVersion}\"\n        }\n\n        stages {\n            stage('Build') {\n                steps {\n                    sh 'go build ./...'\n                }\n            }\n            stage('Test') {\n                steps {\n                    sh 'go test -v ./...'\n                }\n            }\n        }\n    }\n}\n\n// 共有ライブラリ使用\n@Library('my-shared-lib') _\n\nbuildGo(goVersion: '1.21')\n</code></pre>\n<h2>認証情報管理</h2>\n<pre><code class=\"language-groovy\">pipeline {\n    agent any\n\n    stages {\n        stage('Deploy') {\n            steps {\n                // ユーザー名パスワード\n                withCredentials([usernamePassword(\n                    credentialsId: 'docker-hub',\n                    usernameVariable: 'DOCKER_USER',\n                    passwordVariable: 'DOCKER_PASS'\n                )]) {\n                    sh 'docker login -u $DOCKER_USER -p $DOCKER_PASS'\n                }\n\n                // SSH キー\n                withCredentials([sshUserPrivateKey(\n                    credentialsId: 'ssh-key',\n                    keyFileVariable: 'SSH_KEY'\n                )]) {\n                    sh 'ssh -i $SSH_KEY user@server \"deploy.sh\"'\n                }\n\n                // Secret ファイル\n                withCredentials([file(\n                    credentialsId: 'kubeconfig',\n                    variable: 'KUBECONFIG'\n                )]) {\n                    sh 'kubectl apply -f manifests/'\n                }\n            }\n        }\n    }\n}\n</code></pre>\n<h2>エージェント設定</h2>\n<pre><code class=\"language-groovy\">pipeline {\n    agent {\n        // Docker エージェント\n        docker {\n            image 'golang:1.21'\n            args '-v /var/run/docker.sock:/var/run/docker.sock'\n        }\n    }\n\n    // または Kubernetes エージェント\n    agent {\n        kubernetes {\n            yaml '''\n                apiVersion: v1\n                kind: Pod\n                spec:\n                  containers:\n                  - name: golang\n                    image: golang:1.21\n                    command:\n                    - sleep\n                    args:\n                    - infinity\n                  - name: docker\n                    image: docker:dind\n                    securityContext:\n                      privileged: true\n            '''\n            defaultContainer 'golang'\n        }\n    }\n\n    stages {\n        stage('Build') {\n            steps {\n                container('golang') {\n                    sh 'go build ./...'\n                }\n            }\n        }\n    }\n}\n</code></pre>\n<h2>まとめ</h2>\n<p>Jenkins のポイント：</p>\n<ol>\n<li><strong>Pipeline</strong> - 宣言的/スクリプト式、コードとして設定</li>\n<li><strong>マルチブランチ</strong> - 自動ブランチ検出、差別化ビルド</li>\n<li><strong>並列</strong> - マトリックスビルド、並列テスト</li>\n<li><strong>共有ライブラリ</strong> - ビルドロジック再利用</li>\n<li><strong>認証情報</strong> - 機密情報の安全な管理</li>\n</ol>\n"
}