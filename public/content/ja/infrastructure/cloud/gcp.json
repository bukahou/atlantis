{
  "slug": "gcp",
  "meta": {
    "title": "GCP クラウドサービス基礎",
    "description": "Google Cloud Platform コアサービスの紹介と実践ガイド",
    "order": 2,
    "tags": [
      "gcp",
      "cloud",
      "compute-engine",
      "gcs"
    ]
  },
  "content": "<h1>GCP クラウドサービス基礎</h1>\n<h2>GCP とは</h2>\n<p>Google Cloud Platform (GCP) は、Google が提供するクラウドコンピューティングプラットフォームで、データ分析、機械学習、グローバルネットワークインフラで知られています。</p>\n<pre><code>GCP グローバルインフラストラクチャ\n├── Regions (リージョン) - 40+\n│   └── Zones (ゾーン) - 121+\n├── Edge PoPs - 200+\n└── CDN Nodes - グローバル分散\n</code></pre>\n<h2>コアコンピューティングサービス</h2>\n<h3>Compute Engine (仮想マシン)</h3>\n<p>Compute Engine は、カスタマイズ可能な仮想マシンインスタンスを提供します。</p>\n<h4>マシンタイプ</h4>\n<table>\n<thead>\n<tr>\n<th>シリーズ</th>\n<th>用途</th>\n<th>特徴</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>E2</strong></td>\n<td>汎用ワークロード</td>\n<td>コスト最適化</td>\n</tr>\n<tr>\n<td><strong>N2/N2D</strong></td>\n<td>バランス型</td>\n<td>高性能</td>\n</tr>\n<tr>\n<td><strong>C2/C2D</strong></td>\n<td>コンピューティング集約型</td>\n<td>最高シングルコア性能</td>\n</tr>\n<tr>\n<td><strong>M2/M3</strong></td>\n<td>メモリ集約型</td>\n<td>最大12TBメモリ</td>\n</tr>\n<tr>\n<td><strong>A2/G2</strong></td>\n<td>GPU アクセラレーション</td>\n<td>ML/AI ワークロード</td>\n</tr>\n</tbody>\n</table>\n<h4>VM インスタンスの作成</h4>\n<pre><code class=\"language-bash\"># gcloud で インスタンスを作成\ngcloud compute instances create my-instance \\\n  --zone=asia-northeast1-a \\\n  --machine-type=e2-medium \\\n  --image-family=debian-12 \\\n  --image-project=debian-cloud \\\n  --boot-disk-size=20GB \\\n  --tags=http-server,https-server\n\n# GPU 付きインスタンス\ngcloud compute instances create gpu-instance \\\n  --zone=asia-northeast1-a \\\n  --machine-type=n1-standard-4 \\\n  --accelerator=type=nvidia-tesla-t4,count=1 \\\n  --image-family=debian-12 \\\n  --image-project=debian-cloud \\\n  --maintenance-policy=TERMINATE\n</code></pre>\n<h4>インスタンスグループとオートスケーリング</h4>\n<pre><code class=\"language-bash\"># インスタンステンプレートの作成\ngcloud compute instance-templates create my-template \\\n  --machine-type=e2-medium \\\n  --image-family=debian-12 \\\n  --image-project=debian-cloud\n\n# マネージドインスタンスグループの作成\ngcloud compute instance-groups managed create my-group \\\n  --base-instance-name=my-vm \\\n  --template=my-template \\\n  --size=3 \\\n  --zone=asia-northeast1-a\n\n# オートスケーリングの設定\ngcloud compute instance-groups managed set-autoscaling my-group \\\n  --zone=asia-northeast1-a \\\n  --min-num-replicas=2 \\\n  --max-num-replicas=10 \\\n  --target-cpu-utilization=0.7\n</code></pre>\n<h3>Cloud Functions (サーバーレス)</h3>\n<pre><code class=\"language-python\"># main.py - Cloud Functions の例\nimport functions_framework\n\n@functions_framework.http\ndef hello_http(request):\n    name = request.args.get('name', 'World')\n    return f'Hello, {name}!'\n\n@functions_framework.cloud_event\ndef hello_pubsub(cloud_event):\n    import base64\n    data = base64.b64decode(cloud_event.data[\"message\"][\"data\"])\n    print(f\"Received message: {data}\")\n</code></pre>\n<pre><code class=\"language-bash\"># HTTP 関数のデプロイ\ngcloud functions deploy hello-http \\\n  --gen2 \\\n  --runtime=python311 \\\n  --trigger-http \\\n  --allow-unauthenticated \\\n  --region=asia-northeast1\n\n# Pub/Sub トリガー関数のデプロイ\ngcloud functions deploy hello-pubsub \\\n  --gen2 \\\n  --runtime=python311 \\\n  --trigger-topic=my-topic \\\n  --region=asia-northeast1\n</code></pre>\n<h3>Cloud Run (コンテナ化サーバーレス)</h3>\n<pre><code class=\"language-bash\"># Cloud Run にコンテナをデプロイ\ngcloud run deploy my-service \\\n  --image=gcr.io/my-project/my-image:latest \\\n  --platform=managed \\\n  --region=asia-northeast1 \\\n  --allow-unauthenticated \\\n  --memory=512Mi \\\n  --cpu=1 \\\n  --min-instances=0 \\\n  --max-instances=100\n\n# トラフィック分割の設定\ngcloud run services update-traffic my-service \\\n  --to-revisions=my-service-v2=50,my-service-v1=50 \\\n  --region=asia-northeast1\n</code></pre>\n<h2>ストレージサービス</h2>\n<h3>Cloud Storage (オブジェクトストレージ)</h3>\n<p>GCS は、複数のストレージクラスを持つ統合オブジェクトストレージを提供します。</p>\n<pre><code>ストレージクラス\n├── Standard - ホットデータ、頻繁アクセス\n├── Nearline - 月1回未満のアクセス\n├── Coldline - 四半期1回未満のアクセス\n└── Archive - 年1回未満のアクセス\n</code></pre>\n<h4>操作例</h4>\n<pre><code class=\"language-bash\"># バケットの作成\ngsutil mb -l asia-northeast1 gs://my-bucket-name\n\n# ファイルのアップロード\ngsutil cp file.txt gs://my-bucket-name/\n\n# ディレクトリの同期\ngsutil -m rsync -r ./local-dir gs://my-bucket-name/remote-dir\n\n# ライフサイクルの設定\ngsutil lifecycle set lifecycle.json gs://my-bucket-name\n\n# CORS の設定\ngsutil cors set cors.json gs://my-bucket-name\n</code></pre>\n<pre><code class=\"language-json\">// lifecycle.json\n{\n  \"rule\": [\n    {\n      \"action\": {\"type\": \"SetStorageClass\", \"storageClass\": \"NEARLINE\"},\n      \"condition\": {\"age\": 30}\n    },\n    {\n      \"action\": {\"type\": \"Delete\"},\n      \"condition\": {\"age\": 365}\n    }\n  ]\n}\n</code></pre>\n<h3>Persistent Disk</h3>\n<pre><code class=\"language-bash\"># SSD 永続ディスクの作成\ngcloud compute disks create my-disk \\\n  --size=100GB \\\n  --type=pd-ssd \\\n  --zone=asia-northeast1-a\n\n# インスタンスにアタッチ\ngcloud compute instances attach-disk my-instance \\\n  --disk=my-disk \\\n  --zone=asia-northeast1-a\n\n# スナップショットの作成\ngcloud compute disks snapshot my-disk \\\n  --snapshot-names=my-snapshot \\\n  --zone=asia-northeast1-a\n</code></pre>\n<h2>ネットワークサービス</h2>\n<h3>VPC ネットワーク</h3>\n<pre><code>GCP VPC の特徴\n├── グローバル VPC - リージョン間統一ネットワーク\n├── 自動モード - サブネット自動作成\n├── カスタムモード - CIDR の完全制御\n└── 共有 VPC - プロジェクト間ネットワーク\n</code></pre>\n<pre><code class=\"language-bash\"># カスタム VPC の作成\ngcloud compute networks create my-vpc \\\n  --subnet-mode=custom\n\n# サブネットの作成\ngcloud compute networks subnets create my-subnet \\\n  --network=my-vpc \\\n  --region=asia-northeast1 \\\n  --range=10.0.0.0/24\n\n# ファイアウォールルールの作成\ngcloud compute firewall-rules create allow-http \\\n  --network=my-vpc \\\n  --allow=tcp:80,tcp:443 \\\n  --source-ranges=0.0.0.0/0 \\\n  --target-tags=http-server\n</code></pre>\n<h3>Cloud Load Balancing</h3>\n<pre><code class=\"language-bash\"># ヘルスチェックの作成\ngcloud compute health-checks create http my-health-check \\\n  --port=80 \\\n  --request-path=/health\n\n# バックエンドサービスの作成\ngcloud compute backend-services create my-backend \\\n  --protocol=HTTP \\\n  --health-checks=my-health-check \\\n  --global\n\n# バックエンドインスタンスグループの追加\ngcloud compute backend-services add-backend my-backend \\\n  --instance-group=my-group \\\n  --instance-group-zone=asia-northeast1-a \\\n  --global\n\n# URL マップの作成\ngcloud compute url-maps create my-lb \\\n  --default-service=my-backend\n\n# HTTP プロキシの作成\ngcloud compute target-http-proxies create my-proxy \\\n  --url-map=my-lb\n\n# 転送ルールの作成\ngcloud compute forwarding-rules create my-forwarding-rule \\\n  --global \\\n  --target-http-proxy=my-proxy \\\n  --ports=80\n</code></pre>\n<h3>Cloud DNS</h3>\n<pre><code class=\"language-bash\"># マネージドゾーンの作成\ngcloud dns managed-zones create my-zone \\\n  --dns-name=example.com. \\\n  --description=\"My DNS zone\"\n\n# A レコードの追加\ngcloud dns record-sets transaction start --zone=my-zone\ngcloud dns record-sets transaction add 1.2.3.4 \\\n  --name=www.example.com. \\\n  --ttl=300 \\\n  --type=A \\\n  --zone=my-zone\ngcloud dns record-sets transaction execute --zone=my-zone\n</code></pre>\n<h2>データベースサービス</h2>\n<h3>Cloud SQL</h3>\n<pre><code class=\"language-bash\"># PostgreSQL インスタンスの作成\ngcloud sql instances create my-db \\\n  --database-version=POSTGRES_15 \\\n  --tier=db-custom-2-4096 \\\n  --region=asia-northeast1 \\\n  --root-password=MyPassword123 \\\n  --availability-type=REGIONAL\n\n# データベースの作成\ngcloud sql databases create mydb --instance=my-db\n\n# ユーザーの作成\ngcloud sql users create myuser \\\n  --instance=my-db \\\n  --password=UserPassword123\n</code></pre>\n<h3>Firestore / Datastore</h3>\n<pre><code class=\"language-python\">from google.cloud import firestore\n\n# クライアントの初期化\ndb = firestore.Client()\n\n# ドキュメントの追加\ndoc_ref = db.collection('users').document('user123')\ndoc_ref.set({\n    'name': 'John Doe',\n    'email': 'john@example.com',\n    'created_at': firestore.SERVER_TIMESTAMP\n})\n\n# データのクエリ\nusers_ref = db.collection('users')\ndocs = users_ref.where('name', '==', 'John Doe').stream()\nfor doc in docs:\n    print(f'{doc.id} => {doc.to_dict()}')\n</code></pre>\n<h3>BigQuery (データウェアハウス)</h3>\n<pre><code class=\"language-sql\">-- データセットの作成\nCREATE SCHEMA my_dataset;\n\n-- テーブルの作成\nCREATE TABLE my_dataset.users (\n  user_id STRING,\n  name STRING,\n  email STRING,\n  created_at TIMESTAMP\n);\n\n-- クエリ (PB級データ対応)\nSELECT\n  DATE(created_at) as date,\n  COUNT(*) as user_count\nFROM my_dataset.users\nWHERE created_at >= '2024-01-01'\nGROUP BY date\nORDER BY date;\n</code></pre>\n<pre><code class=\"language-bash\"># GCS からデータをロード\nbq load \\\n  --source_format=CSV \\\n  my_dataset.users \\\n  gs://my-bucket/users.csv \\\n  user_id:STRING,name:STRING,email:STRING\n</code></pre>\n<h2>IAM とセキュリティ</h2>\n<h3>ロールと権限</h3>\n<pre><code class=\"language-bash\"># プロジェクトレベルのロールを付与\ngcloud projects add-iam-policy-binding my-project \\\n  --member=user:user@example.com \\\n  --role=roles/compute.admin\n\n# リソースレベルの権限を付与\ngcloud storage buckets add-iam-policy-binding gs://my-bucket \\\n  --member=serviceAccount:sa@my-project.iam.gserviceaccount.com \\\n  --role=roles/storage.objectViewer\n\n# サービスアカウントの作成\ngcloud iam service-accounts create my-sa \\\n  --display-name=\"My Service Account\"\n\n# キーの作成\ngcloud iam service-accounts keys create key.json \\\n  --iam-account=my-sa@my-project.iam.gserviceaccount.com\n</code></pre>\n<h3>カスタムロール</h3>\n<pre><code class=\"language-yaml\"># custom-role.yaml\ntitle: \"Custom Storage Reader\"\ndescription: \"Custom role for reading storage\"\nstage: \"GA\"\nincludedPermissions:\n  - storage.objects.get\n  - storage.objects.list\n  - storage.buckets.get\n</code></pre>\n<pre><code class=\"language-bash\">gcloud iam roles create customStorageReader \\\n  --project=my-project \\\n  --file=custom-role.yaml\n</code></pre>\n<h2>GKE (Kubernetes Engine)</h2>\n<pre><code class=\"language-bash\"># GKE クラスタの作成\ngcloud container clusters create my-cluster \\\n  --zone=asia-northeast1-a \\\n  --num-nodes=3 \\\n  --machine-type=e2-medium \\\n  --enable-autoscaling \\\n  --min-nodes=1 \\\n  --max-nodes=5\n\n# クラスタ認証情報の取得\ngcloud container clusters get-credentials my-cluster \\\n  --zone=asia-northeast1-a\n\n# アプリケーションのデプロイ\nkubectl apply -f deployment.yaml\n</code></pre>\n<h2>コスト管理</h2>\n<pre><code class=\"language-bash\"># 請求データを BigQuery にエクスポート\ngcloud billing accounts list\n\n# 予算アラートの設定\ngcloud billing budgets create \\\n  --billing-account=ACCOUNT_ID \\\n  --display-name=\"Monthly Budget\" \\\n  --budget-amount=1000USD \\\n  --threshold-rules=percent=50 \\\n  --threshold-rules=percent=90\n</code></pre>\n<h2>まとめ</h2>\n<p>GCP コアサービスのポイント：</p>\n<ol>\n<li><strong>コンピューティング</strong>: Compute Engine, Cloud Functions, Cloud Run, GKE</li>\n<li><strong>ストレージ</strong>: Cloud Storage, Persistent Disk, Filestore</li>\n<li><strong>データベース</strong>: Cloud SQL, Firestore, Bigtable, Spanner</li>\n<li><strong>データ分析</strong>: BigQuery, Dataflow, Pub/Sub</li>\n<li><strong>ネットワーク</strong>: VPC, Cloud Load Balancing, Cloud CDN</li>\n<li><strong>AI/ML</strong>: Vertex AI, AutoML, Vision AI</li>\n</ol>\n"
}