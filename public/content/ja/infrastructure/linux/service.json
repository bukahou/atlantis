{
  "slug": "service",
  "meta": {
    "title": "サービス管理",
    "description": "Linux サービス管理：systemd アーキテクチャ、Unit 設定とシステムブート",
    "order": 6,
    "tags": [
      "Linux",
      "systemd",
      "サービス",
      "init"
    ]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "コアコンセプト",
      "items": [
        "systemd は現代 Linux の init システムおよびサービスマネージャー",
        "Unit は systemd が管理する基本単位",
        "サービスの並列起動で起動時間を大幅に短縮",
        "ログ、タイマー、ネットワークなどの統一管理を提供"
      ]
    },
    {
      "type": "comparison",
      "title": "systemd vs SysVinit",
      "columns": [
        {
          "title": "systemd",
          "color": "from-blue-500 to-cyan-500",
          "items": [
            {
              "label": "起動方式",
              "description": "依存関係に基づく並列起動"
            },
            {
              "label": "設定形式",
              "description": "宣言型 Unit ファイル"
            },
            {
              "label": "サービス管理",
              "description": "systemctl コマンド"
            },
            {
              "label": "ログシステム",
              "description": "journald バイナリログ"
            },
            {
              "label": "依存関係管理",
              "description": "自動依存関係解決"
            }
          ]
        },
        {
          "title": "SysVinit",
          "color": "from-amber-500 to-orange-500",
          "items": [
            {
              "label": "起動方式",
              "description": "順番に逐次起動"
            },
            {
              "label": "設定形式",
              "description": "Shell スクリプト"
            },
            {
              "label": "サービス管理",
              "description": "service/chkconfig"
            },
            {
              "label": "ログシステム",
              "description": "syslog テキストログ"
            },
            {
              "label": "依存関係管理",
              "description": "手動で順序管理"
            }
          ]
        }
      ]
    },
    {
      "type": "cards",
      "title": "Unit タイプ",
      "layout": "grid",
      "columns": 3,
      "items": [
        {
          "title": ".service",
          "badge": "サービス",
          "badgeColor": "blue",
          "points": [
            "バックグラウンドサービスプロセス",
            "最もよく使われるタイプ",
            "例: nginx.service"
          ]
        },
        {
          "title": ".socket",
          "badge": "ソケット",
          "badgeColor": "green",
          "points": [
            "Socket 駆動",
            "オンデマンドでサービス起動",
            "リソース節約"
          ]
        },
        {
          "title": ".timer",
          "badge": "タイマー",
          "badgeColor": "amber",
          "points": [
            "cron の代替",
            "定期的にサービスをトリガー",
            "より柔軟なスケジューリング"
          ]
        },
        {
          "title": ".target",
          "badge": "ターゲット",
          "badgeColor": "purple",
          "points": [
            "サービスグループ",
            "ランレベルに類似",
            "例: multi-user.target"
          ]
        },
        {
          "title": ".mount",
          "badge": "マウント",
          "badgeColor": "cyan",
          "points": [
            "ファイルシステムマウント",
            "自動生成",
            "/etc/fstab に対応"
          ]
        },
        {
          "title": ".path",
          "badge": "パス",
          "badgeColor": "red",
          "points": [
            "パス監視",
            "ファイル変更でトリガー",
            "inotify 機構"
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "systemctl よく使うコマンド",
      "language": "bash",
      "code": "# サービス制御\nsystemctl start nginx      # サービス起動\nsystemctl stop nginx       # サービス停止\nsystemctl restart nginx    # サービス再起動\nsystemctl reload nginx     # 設定リロード\nsystemctl status nginx     # 状態確認\n\n# 自動起動設定\nsystemctl enable nginx     # 自動起動有効\nsystemctl disable nginx    # 自動起動無効\nsystemctl is-enabled nginx # 自動起動確認\n\n# サービス一覧\nsystemctl list-units --type=service          # ロード済みサービス\nsystemctl list-units --type=service --all    # 全サービス\nsystemctl list-unit-files --type=service     # サービスファイル\n\n# 依存関係\nsystemctl list-dependencies nginx\nsystemctl list-dependencies --reverse nginx  # 逆依存\n\n# システム状態\nsystemctl is-system-running  # システム状態\nsystemctl --failed           # 失敗したサービス"
    },
    {
      "type": "flow",
      "title": "systemd 起動フロー",
      "direction": "vertical",
      "steps": [
        {
          "label": "カーネル起動",
          "description": "initramfs ロード",
          "color": "bg-gray-500"
        },
        {
          "label": "systemd (PID 1)",
          "description": "システム初期化",
          "color": "bg-blue-500"
        },
        {
          "label": "default.target",
          "description": "デフォルトターゲット",
          "color": "bg-cyan-500"
        },
        {
          "label": "依存関係解決",
          "description": "依存ツリー構築",
          "color": "bg-purple-500"
        },
        {
          "label": "並列起動",
          "description": "全サービス起動",
          "color": "bg-green-500"
        },
        {
          "label": "ユーザーログイン",
          "description": "getty/display-manager",
          "color": "bg-amber-500"
        }
      ]
    },
    {
      "type": "table",
      "title": "ランターゲット (Target)",
      "highlightFirst": true,
      "headers": [
        "Target",
        "説明",
        "対応ランレベル"
      ],
      "rows": [
        [
          "poweroff.target",
          "シャットダウン",
          "0"
        ],
        [
          "rescue.target",
          "レスキューモード",
          "1 (シングルユーザー)"
        ],
        [
          "multi-user.target",
          "マルチユーザーコマンドライン",
          "3"
        ],
        [
          "graphical.target",
          "グラフィカルインターフェース",
          "5"
        ],
        [
          "reboot.target",
          "再起動",
          "6"
        ],
        [
          "emergency.target",
          "緊急モード",
          "-"
        ]
      ]
    },
    {
      "type": "codeBlock",
      "title": "Unit ファイル構造",
      "language": "ini",
      "code": "# /etc/systemd/system/myapp.service\n[Unit]\nDescription=My Application Service\nAfter=network.target          # ネットワーク起動後\nWants=postgresql.service      # 弱依存\nRequires=redis.service        # 強依存\n\n[Service]\nType=simple                   # サービスタイプ\nUser=myapp                    # 実行ユーザー\nGroup=myapp                   # 実行グループ\nWorkingDirectory=/opt/myapp   # 作業ディレクトリ\nExecStart=/opt/myapp/bin/server  # 起動コマンド\nExecReload=/bin/kill -HUP $MAINPID  # リロードコマンド\nRestart=on-failure            # 失敗時に再起動\nRestartSec=5                  # 再起動間隔\n\n# リソース制限\nLimitNOFILE=65535\nLimitNPROC=4096\n\n# セキュリティ強化\nNoNewPrivileges=true\nProtectSystem=strict\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.target    # インストールターゲット"
    },
    {
      "type": "table",
      "title": "Service タイプ",
      "highlightFirst": true,
      "headers": [
        "Type",
        "説明",
        "適用シナリオ"
      ],
      "rows": [
        [
          "simple",
          "メインプロセスがサービスプロセス",
          "ほとんどのデーモン"
        ],
        [
          "forking",
          "fork 後に親プロセスが終了",
          "従来型デーモン"
        ],
        [
          "oneshot",
          "一回限りの実行",
          "起動スクリプト"
        ],
        [
          "notify",
          "準備完了時に systemd に通知",
          "sd_notify 対応"
        ],
        [
          "idle",
          "アイドル時に起動",
          "低優先度タスク"
        ]
      ]
    },
    {
      "type": "codeBlock",
      "title": "journalctl ログ確認",
      "language": "bash",
      "code": "# 基本表示\njournalctl                    # 全ログ\njournalctl -f                 # リアルタイム追跡\njournalctl -n 50              # 最新 50 件\n\n# サービスでフィルタ\njournalctl -u nginx           # nginx サービスログ\njournalctl -u nginx -f        # リアルタイム追跡\njournalctl -u nginx --since today\n\n# 時間でフィルタ\njournalctl --since \"2024-01-01\"\njournalctl --since \"1 hour ago\"\njournalctl --since \"09:00\" --until \"10:00\"\n\n# 優先度でフィルタ\njournalctl -p err             # エラー以上\njournalctl -p warning         # 警告以上\n\n# カーネルログ\njournalctl -k                 # dmesg と同等\njournalctl -k -b              # 今回起動のカーネルログ\n\n# 出力形式\njournalctl -o json-pretty     # JSON 形式\njournalctl -o short-iso       # ISO 時間形式"
    },
    {
      "type": "codeBlock",
      "title": "タイマータスク (Timer)",
      "language": "ini",
      "code": "# /etc/systemd/system/backup.timer\n[Unit]\nDescription=Daily Backup Timer\n\n[Timer]\nOnCalendar=*-*-* 02:00:00     # 毎日深夜 2 時\nPersistent=true               # 時間を逃しても実行\nRandomizedDelaySec=300        # ランダム遅延 0-5 分\n\n[Install]\nWantedBy=timers.target\n\n# /etc/systemd/system/backup.service\n[Unit]\nDescription=Backup Service\n\n[Service]\nType=oneshot\nExecStart=/usr/local/bin/backup.sh\n\n# タイマー有効化\n# systemctl enable --now backup.timer\n# systemctl list-timers"
    },
    {
      "type": "cards",
      "title": "高度な機能",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "Socket 駆動",
          "badge": "オンデマンド",
          "badgeColor": "blue",
          "points": [
            "ポート監視、オンデマンドでサービス起動",
            "アイドル時はリソース消費なし",
            "TCP/UDP/Unix Socket 対応"
          ]
        },
        {
          "title": "リソース制御",
          "badge": "cgroup",
          "badgeColor": "green",
          "points": [
            "CPUQuota で CPU 制限",
            "MemoryMax でメモリ制限",
            "IOWeight で I/O 優先度制御"
          ]
        },
        {
          "title": "セキュリティサンドボックス",
          "badge": "分離",
          "badgeColor": "purple",
          "points": [
            "PrivateTmp 専用 /tmp",
            "ProtectSystem 読み取り専用システム",
            "NoNewPrivileges 権限昇格禁止"
          ]
        },
        {
          "title": "依存関係管理",
          "badge": "順序",
          "badgeColor": "amber",
          "points": [
            "After/Before 順序制御",
            "Requires 強依存",
            "Wants 弱依存"
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "リソース制限設定",
      "language": "ini",
      "code": "[Service]\n# CPU 制限\nCPUQuota=200%              # 最大 2 CPU コア使用\nCPUWeight=100              # CPU ウェイト (1-10000)\n\n# メモリ制限\nMemoryMax=2G               # 最大メモリ\nMemoryHigh=1.5G            # 高水位警告\n\n# I/O 制限\nIOWeight=100               # I/O ウェイト\nIOReadBandwidthMax=/dev/sda 100M\nIOWriteBandwidthMax=/dev/sda 50M\n\n# プロセス制限\nTasksMax=512               # 最大プロセス/スレッド数\n\n# リソース使用確認\n# systemctl show nginx --property=MemoryCurrent\n# systemd-cgtop"
    },
    {
      "type": "list",
      "title": "サービス管理のベストプラクティス",
      "style": "check",
      "items": [
        {
          "label": "systemctl でサービス管理",
          "description": "service コマンドを置き換え"
        },
        {
          "label": "リソース制限を設定",
          "description": "単一サービスのリソース枯渇を防止"
        },
        {
          "label": "セキュリティオプション有効化",
          "description": "PrivateTmp, ProtectSystem"
        },
        {
          "label": "Timer で cron を置き換え",
          "description": "より良いログと依存関係管理"
        },
        {
          "label": "失敗サービスを監視",
          "description": "systemctl --failed"
        }
      ]
    }
  ],
  "relatedTopics": [
    "Linux カーネル",
    "プロセス管理",
    "ログ管理"
  ]
}