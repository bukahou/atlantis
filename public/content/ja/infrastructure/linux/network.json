{
  "slug": "network",
  "meta": {
    "title": "Linux ネットワーク",
    "description": "Linux ネットワークスタック：設定、診断とパフォーマンスチューニング",
    "order": 5,
    "tags": [
      "Linux",
      "ネットワーク",
      "iptables",
      "ネットワークチューニング"
    ]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "コアコンセプト",
      "items": [
        "Linux ネットワークスタックは完全な TCP/IP プロトコルを実装",
        "Netfilter フレームワークがパケットフィルタリング機能を提供",
        "iproute2 は現代のネットワーク設定ツールセット",
        "カーネルパラメータチューニングでネットワーク性能を最適化"
      ]
    },
    {
      "type": "flow",
      "title": "Linux ネットワークスタック",
      "direction": "vertical",
      "steps": [
        {
          "label": "アプリケーション",
          "description": "Socket API",
          "color": "bg-blue-500"
        },
        {
          "label": "トランスポート層",
          "description": "TCP/UDP",
          "color": "bg-cyan-500"
        },
        {
          "label": "ネットワーク層",
          "description": "IP/ルーティング/Netfilter",
          "color": "bg-purple-500"
        },
        {
          "label": "リンク層",
          "description": "ARP/ブリッジ",
          "color": "bg-amber-500"
        },
        {
          "label": "デバイスドライバ",
          "description": "NIC ドライバ",
          "color": "bg-orange-500"
        },
        {
          "label": "ハードウェア",
          "description": "NIC",
          "color": "bg-gray-500"
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "ネットワーク設定 (iproute2)",
      "language": "bash",
      "code": "# ネットワークインターフェース確認\nip link show\nip addr show\nip -s link   # 統計情報付き\n\n# IP アドレス設定\nip addr add 192.168.1.10/24 dev eth0\nip addr del 192.168.1.10/24 dev eth0\n\n# インターフェース有効/無効化\nip link set eth0 up\nip link set eth0 down\n\n# ルート管理\nip route show\nip route add 10.0.0.0/8 via 192.168.1.1\nip route add default via 192.168.1.1\n\n# ARP テーブル\nip neigh show\nip neigh add 192.168.1.1 lladdr aa:bb:cc:dd:ee:ff dev eth0"
    },
    {
      "type": "cards",
      "title": "Netfilter/iptables",
      "layout": "grid",
      "columns": 3,
      "items": [
        {
          "title": "filter テーブル",
          "badge": "フィルタ",
          "badgeColor": "blue",
          "points": [
            "INPUT 入力",
            "OUTPUT 出力",
            "FORWARD 転送",
            "デフォルトテーブル"
          ]
        },
        {
          "title": "nat テーブル",
          "badge": "変換",
          "badgeColor": "green",
          "points": [
            "PREROUTING DNAT",
            "POSTROUTING SNAT",
            "OUTPUT ローカル",
            "アドレス変換"
          ]
        },
        {
          "title": "mangle テーブル",
          "badge": "変更",
          "badgeColor": "amber",
          "points": [
            "パケット変更",
            "TTL/TOS/Mark",
            "QoS マーキング",
            "高度な用途"
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "iptables よく使うルール",
      "language": "bash",
      "code": "# ルール確認\niptables -L -n -v\niptables -t nat -L -n\n\n# 許可/拒否ルール\niptables -A INPUT -p tcp --dport 22 -j ACCEPT\niptables -A INPUT -p tcp --dport 80 -j ACCEPT\niptables -A INPUT -j DROP\n\n# NAT ルール\n# SNAT (内部から外部へのアクセス)\niptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE\n\n# DNAT (ポートフォワーディング)\niptables -t nat -A PREROUTING -p tcp --dport 8080 -j DNAT --to 192.168.1.10:80\n\n# ルール保存\niptables-save > /etc/iptables.rules\niptables-restore < /etc/iptables.rules"
    },
    {
      "type": "codeBlock",
      "title": "ネットワーク診断ツール",
      "language": "bash",
      "code": "# 疎通性テスト\nping -c 4 8.8.8.8\ntraceroute 8.8.8.8\nmtr 8.8.8.8\n\n# ポートテスト\ntelnet 192.168.1.1 80\nnc -zv 192.168.1.1 80\nss -tlnp                  # リッスンポート\nss -antp                  # すべての TCP 接続\n\n# DNS 診断\ndig example.com\nnslookup example.com\n\n# パケットキャプチャ\ntcpdump -i eth0 -n port 80\ntcpdump -i any -w capture.pcap"
    },
    {
      "type": "table",
      "title": "ネットワークカーネルパラメータ",
      "highlightFirst": true,
      "headers": [
        "パラメータ",
        "デフォルト",
        "説明"
      ],
      "rows": [
        [
          "net.ipv4.ip_forward",
          "0",
          "IP フォワーディング有効化"
        ],
        [
          "net.core.somaxconn",
          "128",
          "Socket リッスンキュー"
        ],
        [
          "net.ipv4.tcp_max_syn_backlog",
          "128",
          "SYN キューサイズ"
        ],
        [
          "net.core.netdev_max_backlog",
          "1000",
          "NIC 受信キュー"
        ],
        [
          "net.ipv4.tcp_tw_reuse",
          "0",
          "TIME_WAIT 再利用"
        ],
        [
          "net.ipv4.tcp_fin_timeout",
          "60",
          "FIN タイムアウト時間"
        ]
      ]
    },
    {
      "type": "codeBlock",
      "title": "ネットワークパフォーマンスチューニング",
      "language": "bash",
      "code": "# 高並行サーバー最適化\ncat >> /etc/sysctl.conf << EOF\n# TCP 接続再利用を有効化\nnet.ipv4.tcp_tw_reuse = 1\n\n# 接続キュー拡大\nnet.core.somaxconn = 65535\nnet.ipv4.tcp_max_syn_backlog = 65535\nnet.core.netdev_max_backlog = 65535\n\n# ポート範囲拡大\nnet.ipv4.ip_local_port_range = 1024 65535\n\n# TCP バッファ拡大\nnet.core.rmem_max = 16777216\nnet.core.wmem_max = 16777216\nnet.ipv4.tcp_rmem = 4096 87380 16777216\nnet.ipv4.tcp_wmem = 4096 65536 16777216\n\n# TCP Fast Open 有効化\nnet.ipv4.tcp_fastopen = 3\nEOF\n\nsysctl -p"
    },
    {
      "type": "cards",
      "title": "ネットワーク名前空間と仮想化",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "Network Namespace",
          "badge": "分離",
          "badgeColor": "blue",
          "points": [
            "独立したネットワークスタック",
            "コンテナネットワークの基盤",
            "ip netns で管理"
          ]
        },
        {
          "title": "仮想ネットワークデバイス",
          "badge": "仮想",
          "badgeColor": "green",
          "points": [
            "veth pair ペア",
            "bridge ブリッジ",
            "tun/tap デバイス"
          ]
        }
      ]
    },
    {
      "type": "list",
      "title": "ネットワークのベストプラクティス",
      "style": "check",
      "items": [
        {
          "label": "iproute2 を使用",
          "description": "ifconfig/route など旧ツールを置き換え"
        },
        {
          "label": "適切なファイアウォール設定",
          "description": "最小権限の原則"
        },
        {
          "label": "カーネルパラメータチューニング",
          "description": "シナリオに応じて TCP スタックを最適化"
        },
        {
          "label": "TCP Fast Open 有効化",
          "description": "ハンドシェイク遅延を削減"
        }
      ]
    }
  ],
  "relatedTopics": [
    "Linux カーネル",
    "ネットワークセキュリティ",
    "パフォーマンスチューニング"
  ]
}