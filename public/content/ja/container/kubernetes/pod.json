{
  "slug": "pod",
  "meta": {
    "title": "Kubernetes Pod 詳解",
    "description": "Pod の概念、ライフサイクル、設定とベストプラクティス",
    "order": 1,
    "tags": [
      "kubernetes",
      "pod",
      "container"
    ]
  },
  "content": "<h1>Kubernetes Pod 詳解</h1>\n<h2>Pod の概念</h2>\n<p>Pod は Kubernetes における最小のデプロイ単位で、1つ以上のコンテナを含み、ネットワークとストレージリソースを共有します。</p>\n<pre><code>Pod 構造\n┌─────────────────────────────────────────┐\n│ Pod                                     │\n│  ┌─────────────┐  ┌─────────────┐       │\n│  │ Container 1 │  │ Container 2 │       │\n│  │  (App)      │  │  (Sidecar)  │       │\n│  └──────┬──────┘  └──────┬──────┘       │\n│         │                │              │\n│  ┌──────┴────────────────┴──────┐       │\n│  │     Shared Network (localhost)│       │\n│  │     Shared Volumes            │       │\n│  └───────────────────────────────┘       │\n│                                         │\n│  IP: 10.244.1.5                         │\n└─────────────────────────────────────────┘\n</code></pre>\n<h2>Pod 基本設定</h2>\n<h3>最もシンプルな Pod</h3>\n<pre><code class=\"language-yaml\">apiVersion: v1\nkind: Pod\nmetadata:\n  name: nginx-pod\n  labels:\n    app: nginx\nspec:\n  containers:\n    - name: nginx\n      image: nginx:1.25\n      ports:\n        - containerPort: 80\n</code></pre>\n<h3>完全な設定例</h3>\n<pre><code class=\"language-yaml\">apiVersion: v1\nkind: Pod\nmetadata:\n  name: webapp\n  namespace: production\n  labels:\n    app: webapp\n    version: v1\n  annotations:\n    description: \"Web application pod\"\nspec:\n  # コンテナ設定\n  containers:\n    - name: webapp\n      image: myapp:1.0\n      ports:\n        - name: http\n          containerPort: 8080\n          protocol: TCP\n\n      # 環境変数\n      env:\n        - name: DB_HOST\n          value: \"mysql.default.svc.cluster.local\"\n        - name: DB_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: db-secret\n              key: password\n        - name: POD_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n\n      # リソース制限\n      resources:\n        requests:\n          memory: \"128Mi\"\n          cpu: \"100m\"\n        limits:\n          memory: \"256Mi\"\n          cpu: \"500m\"\n\n      # プローブ設定\n      livenessProbe:\n        httpGet:\n          path: /health\n          port: 8080\n        initialDelaySeconds: 15\n        periodSeconds: 10\n\n      readinessProbe:\n        httpGet:\n          path: /ready\n          port: 8080\n        initialDelaySeconds: 5\n        periodSeconds: 5\n\n      # ボリュームマウント\n      volumeMounts:\n        - name: config-volume\n          mountPath: /etc/config\n        - name: data-volume\n          mountPath: /data\n\n  # ボリューム定義\n  volumes:\n    - name: config-volume\n      configMap:\n        name: app-config\n    - name: data-volume\n      persistentVolumeClaim:\n        claimName: app-pvc\n\n  # スケジューリング設定\n  nodeSelector:\n    disktype: ssd\n\n  # 再起動ポリシー\n  restartPolicy: Always\n\n  # サービスアカウント\n  serviceAccountName: webapp-sa\n</code></pre>\n<h2>Pod ライフサイクル</h2>\n<h3>ライフサイクルフェーズ</h3>\n<pre><code>Pod Phases\n├── Pending   - スケジューリング待ちまたはイメージプル中\n├── Running   - 少なくとも1つのコンテナが実行中\n├── Succeeded - すべてのコンテナが正常終了\n├── Failed    - 少なくとも1つのコンテナが失敗\n└── Unknown   - 状態を取得できない\n</code></pre>\n<h3>コンテナ状態</h3>\n<pre><code class=\"language-yaml\"># コンテナ状態の確認\nkubectl get pod webapp -o jsonpath='{.status.containerStatuses[*]}'\n</code></pre>\n<pre><code>Container States\n├── Waiting    - 起動待ち\n│   └── reason: ContainerCreating, ImagePullBackOff, CrashLoopBackOff\n├── Running    - 実行中\n│   └── startedAt: 2024-01-01T00:00:00Z\n└── Terminated - 終了済み\n    └── reason: Completed, Error, OOMKilled\n</code></pre>\n<h3>ライフサイクルフック</h3>\n<pre><code class=\"language-yaml\">spec:\n  containers:\n    - name: app\n      image: myapp:1.0\n      lifecycle:\n        postStart:\n          exec:\n            command: [\"/bin/sh\", \"-c\", \"echo 'Started' >> /var/log/app.log\"]\n        preStop:\n          httpGet:\n            path: /shutdown\n            port: 8080\n</code></pre>\n<h2>プローブ詳解</h2>\n<h3>3種類のプローブ</h3>\n<pre><code class=\"language-yaml\">spec:\n  containers:\n    - name: app\n      image: myapp:1.0\n\n      # Liveness プローブ - コンテナが実行中か確認\n      livenessProbe:\n        httpGet:\n          path: /healthz\n          port: 8080\n          httpHeaders:\n            - name: X-Custom-Header\n              value: Awesome\n        initialDelaySeconds: 15\n        periodSeconds: 10\n        timeoutSeconds: 3\n        failureThreshold: 3\n        successThreshold: 1\n\n      # Readiness プローブ - トラフィックを受信できるか確認\n      readinessProbe:\n        tcpSocket:\n          port: 8080\n        initialDelaySeconds: 5\n        periodSeconds: 5\n\n      # Startup プローブ - アプリケーションの起動完了を確認\n      startupProbe:\n        exec:\n          command:\n            - cat\n            - /tmp/healthy\n        initialDelaySeconds: 0\n        periodSeconds: 5\n        failureThreshold: 30  # 150秒の起動時間を許容\n</code></pre>\n<h2>マルチコンテナ Pod パターン</h2>\n<h3>Sidecar パターン</h3>\n<pre><code class=\"language-yaml\">apiVersion: v1\nkind: Pod\nmetadata:\n  name: app-with-sidecar\nspec:\n  containers:\n    # メインコンテナ\n    - name: app\n      image: myapp:1.0\n      volumeMounts:\n        - name: logs\n          mountPath: /var/log/app\n\n    # Sidecar: ログ収集\n    - name: log-collector\n      image: fluentd:latest\n      volumeMounts:\n        - name: logs\n          mountPath: /var/log/app\n          readOnly: true\n\n  volumes:\n    - name: logs\n      emptyDir: {}\n</code></pre>\n<h3>Init Containers</h3>\n<pre><code class=\"language-yaml\">apiVersion: v1\nkind: Pod\nmetadata:\n  name: app-with-init\nspec:\n  # Init コンテナは順番に実行\n  initContainers:\n    # 1. データベースの準備を待つ\n    - name: wait-for-db\n      image: busybox:1.36\n      command: ['sh', '-c',\n        'until nc -z mysql 3306; do echo waiting for mysql; sleep 2; done']\n\n    # 2. 設定の初期化\n    - name: init-config\n      image: busybox:1.36\n      command: ['sh', '-c', 'cp /config-template/* /config/']\n      volumeMounts:\n        - name: config-template\n          mountPath: /config-template\n        - name: config\n          mountPath: /config\n\n  # メインコンテナ\n  containers:\n    - name: app\n      image: myapp:1.0\n      volumeMounts:\n        - name: config\n          mountPath: /etc/app\n\n  volumes:\n    - name: config-template\n      configMap:\n        name: app-config\n    - name: config\n      emptyDir: {}\n</code></pre>\n<h2>リソース管理</h2>\n<h3>CPU とメモリ</h3>\n<pre><code class=\"language-yaml\">spec:\n  containers:\n    - name: app\n      image: myapp:1.0\n      resources:\n        # リクエスト量 - スケジューリングの基準\n        requests:\n          memory: \"256Mi\"\n          cpu: \"250m\"      # 0.25 コア\n        # リミット量 - ハードリミット\n        limits:\n          memory: \"512Mi\"\n          cpu: \"1\"         # 1 コア\n</code></pre>\n<h3>QoS クラス</h3>\n<pre><code>QoS Classes (サービス品質)\n├── Guaranteed - requests = limits (優先保護)\n├── Burstable  - requests &#x3C; limits (弾力性)\n└── BestEffort - リソース設定なし (ベストエフォート、最初に退避)\n</code></pre>\n<h2>スケジューリング制御</h2>\n<h3>Node Affinity</h3>\n<pre><code class=\"language-yaml\">spec:\n  affinity:\n    nodeAffinity:\n      # 必須要件\n      requiredDuringSchedulingIgnoredDuringExecution:\n        nodeSelectorTerms:\n          - matchExpressions:\n              - key: kubernetes.io/arch\n                operator: In\n                values:\n                  - amd64\n                  - arm64\n      # 優先度\n      preferredDuringSchedulingIgnoredDuringExecution:\n        - weight: 100\n          preference:\n            matchExpressions:\n              - key: disktype\n                operator: In\n                values:\n                  - ssd\n</code></pre>\n<h3>Pod Anti-Affinity</h3>\n<pre><code class=\"language-yaml\">spec:\n  affinity:\n    podAntiAffinity:\n      preferredDuringSchedulingIgnoredDuringExecution:\n        - weight: 100\n          podAffinityTerm:\n            labelSelector:\n              matchLabels:\n                app: webapp\n            topologyKey: kubernetes.io/hostname\n</code></pre>\n<h2>よく使うコマンド</h2>\n<pre><code class=\"language-bash\"># Pod の作成\nkubectl apply -f pod.yaml\n\n# Pod の確認\nkubectl get pods -o wide\nkubectl get pods -l app=nginx\n\n# 詳細の確認\nkubectl describe pod nginx-pod\n\n# ログの確認\nkubectl logs nginx-pod\nkubectl logs nginx-pod -c sidecar  # マルチコンテナ\nkubectl logs -f nginx-pod          # リアルタイム追跡\n\n# コンテナに入る\nkubectl exec -it nginx-pod -- /bin/bash\n\n# ポートフォワード\nkubectl port-forward nginx-pod 8080:80\n\n# Pod の削除\nkubectl delete pod nginx-pod\n</code></pre>\n<h2>ベストプラクティス</h2>\n<ol>\n<li><strong>リソース制限を必ず設定</strong> - リソース枯渇を防止</li>\n<li><strong>ヘルスチェックを設定</strong> - サービス可用性を確保</li>\n<li><strong>ラベルで整理</strong> - 管理と選択を容易に</li>\n<li><strong>latest タグを避ける</strong> - 再現可能なデプロイを確保</li>\n<li><strong>Init Container を使用</strong> - 初期化ロジックを分離</li>\n<li><strong>Pod Anti-Affinity を設定</strong> - 可用性を向上</li>\n<li><strong>適切な再起動ポリシー</strong> - ワークロードタイプに応じて選択</li>\n</ol>\n"
}