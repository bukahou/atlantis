{
  "slug": "deployment",
  "meta": {
    "title": "Deployment デプロイ",
    "description": "宣言的デプロイ、ローリングアップデートとロールバック",
    "order": 3,
    "tags": [
      "Kubernetes",
      "Deployment",
      "デプロイ"
    ]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "コアコンセプト",
      "items": [
        "Deployment は Pod のレプリカと更新を管理",
        "宣言的設定により、自動的に期待状態へ調整",
        "ローリングアップデートとロールバックをサポート",
        "ReplicaSet を通じてレプリカを管理"
      ]
    },
    {
      "type": "text",
      "title": "Deployment とは",
      "content": "Deployment は Kubernetes で最も一般的に使用されるワークロードコントローラーであり、宣言的な Pod 更新機能を提供します。期待する状態を記述するだけで、Deployment Controller が自動的に実際の状態を期待状態に調整し、ローリングアップデートやロールバックなどの高度な機能をサポートします。"
    },
    {
      "type": "codeBlock",
      "title": "Deployment 設定例",
      "language": "yaml",
      "code": "apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: web-app\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: web\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxSurge: 1        # 期待レプリカ数を超える最大数\n      maxUnavailable: 0  # 利用不可の最大レプリカ数\n  template:\n    metadata:\n      labels:\n        app: web\n    spec:\n      containers:\n      - name: web\n        image: nginx:1.24\n        ports:\n        - containerPort: 80\n        resources:\n          requests:\n            cpu: 100m\n            memory: 128Mi\n          limits:\n            cpu: 200m\n            memory: 256Mi"
    },
    {
      "type": "flow",
      "title": "ローリングアップデートのプロセス",
      "subtitle": "段階的に古い Pod を置き換え",
      "direction": "horizontal",
      "steps": [
        {
          "label": "v1: 3 Pods",
          "description": "現在の状態",
          "color": "bg-gray-500"
        },
        {
          "label": "v2: 1 Pod",
          "description": "新バージョンを作成",
          "color": "bg-blue-500"
        },
        {
          "label": "v1: 2 + v2: 1",
          "description": "段階的に置き換え",
          "color": "bg-purple-500"
        },
        {
          "label": "v1: 1 + v2: 2",
          "description": "置き換えを継続",
          "color": "bg-cyan-500"
        },
        {
          "label": "v2: 3 Pods",
          "description": "更新完了",
          "color": "bg-green-500"
        }
      ]
    },
    {
      "type": "comparison",
      "title": "更新戦略",
      "columns": [
        {
          "title": "RollingUpdate",
          "color": "from-green-500 to-emerald-500",
          "items": [
            {
              "label": "方式",
              "description": "段階的に更新"
            },
            {
              "label": "中断",
              "description": "ダウンタイムなし"
            },
            {
              "label": "パラメータ",
              "description": "maxSurge, maxUnavailable"
            },
            {
              "label": "推奨",
              "description": "本番環境で推奨"
            }
          ]
        },
        {
          "title": "Recreate",
          "color": "from-red-500 to-orange-500",
          "items": [
            {
              "label": "方式",
              "description": "削除後に作成"
            },
            {
              "label": "中断",
              "description": "ダウンタイムあり"
            },
            {
              "label": "パラメータ",
              "description": "なし"
            },
            {
              "label": "推奨",
              "description": "複数バージョン共存不可の場合"
            }
          ]
        }
      ]
    },
    {
      "type": "table",
      "title": "Deployment 操作コマンド",
      "highlightFirst": true,
      "headers": [
        "コマンド",
        "説明"
      ],
      "rows": [
        [
          "kubectl apply -f deployment.yaml",
          "Deployment を作成/更新"
        ],
        [
          "kubectl scale deploy/web --replicas=5",
          "スケーリング"
        ],
        [
          "kubectl set image deploy/web web=nginx:1.25",
          "イメージを更新"
        ],
        [
          "kubectl rollout status deploy/web",
          "更新ステータスを確認"
        ],
        [
          "kubectl rollout history deploy/web",
          "更新履歴を確認"
        ],
        [
          "kubectl rollout undo deploy/web",
          "前のバージョンにロールバック"
        ],
        [
          "kubectl rollout undo deploy/web --to-revision=2",
          "指定バージョンにロールバック"
        ]
      ]
    },
    {
      "type": "cards",
      "title": "重要な設定",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "レプリカ管理",
          "badge": "Replicas",
          "badgeColor": "blue",
          "points": [
            "replicas - 期待レプリカ数",
            "kubectl scale で動的調整",
            "HPA による自動スケーリング"
          ]
        },
        {
          "title": "更新戦略",
          "badge": "Strategy",
          "badgeColor": "green",
          "points": [
            "maxSurge - 最大超過数",
            "maxUnavailable - 最大利用不可数",
            "minReadySeconds - 準備完了待機時間"
          ]
        },
        {
          "title": "ロールバック機構",
          "badge": "Rollback",
          "badgeColor": "amber",
          "points": [
            "revisionHistoryLimit - 履歴バージョン数",
            "rollout undo - 迅速なロールバック",
            "ReplicaSet を自動保存"
          ]
        },
        {
          "title": "ラベルセレクター",
          "badge": "Selector",
          "badgeColor": "purple",
          "points": [
            "matchLabels - 完全一致",
            "matchExpressions - 式による指定",
            "不変、作成後は変更不可"
          ]
        }
      ]
    },
    {
      "type": "list",
      "title": "ベストプラクティス",
      "style": "check",
      "items": [
        {
          "label": "リソースクォータを設定",
          "description": "すべてのコンテナに requests と limits を設定"
        },
        {
          "label": "ヘルスチェックを設定",
          "description": "新しい Pod が準備完了後にトラフィックを受信"
        },
        {
          "label": "更新履歴を保持",
          "description": "適切な revisionHistoryLimit を設定"
        },
        {
          "label": "カナリアリリースを使用",
          "description": "Service と連携してトラフィックを段階的に移行"
        },
        {
          "label": "更新プロセスを監視",
          "description": "kubectl rollout status で追跡"
        }
      ]
    }
  ],
  "relatedTopics": [
    "ReplicaSet",
    "HPA",
    "Service"
  ]
}