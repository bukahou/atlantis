{
  "slug": "multistage",
  "meta": {
    "title": "マルチステージビルド",
    "description": "Docker マルチステージビルドでイメージサイズとセキュリティを最適化",
    "order": 3,
    "tags": [
      "Docker",
      "マルチステージビルド",
      "イメージ最適化"
    ]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "コア概念",
      "items": [
        "マルチステージビルドでビルド環境と実行環境を分離",
        "最終イメージには実行に必要なファイルのみ含む",
        "イメージサイズを大幅に削減",
        "セキュリティ向上、ビルドツールを除去"
      ]
    },
    {
      "type": "flow",
      "title": "マルチステージビルドフロー",
      "direction": "horizontal",
      "steps": [
        {
          "label": "ビルドステージ",
          "description": "コンパイル/パッケージング",
          "color": "bg-blue-500"
        },
        {
          "label": "COPY --from",
          "description": "成果物をコピー",
          "color": "bg-purple-500"
        },
        {
          "label": "実行ステージ",
          "description": "最小イメージ",
          "color": "bg-green-500"
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "Go アプリケーションのマルチステージビルド",
      "language": "dockerfile",
      "code": "# ビルドステージ\nFROM golang:1.21-alpine AS builder\n\nWORKDIR /app\nCOPY go.mod go.sum ./\nRUN go mod download\n\nCOPY . .\nRUN CGO_ENABLED=0 GOOS=linux go build -o /app/server ./cmd/server\n\n# 実行ステージ\nFROM alpine:3.18\n\n# セキュリティ：非 root ユーザーを使用\nRUN adduser -D -g '' appuser\nUSER appuser\n\nWORKDIR /app\nCOPY --from=builder /app/server .\n\nEXPOSE 8080\nCMD [\"./server\"]\n\n# 最終イメージ：約15MB vs ビルドイメージ 約300MB"
    },
    {
      "type": "codeBlock",
      "title": "Node.js アプリケーションのマルチステージビルド",
      "language": "dockerfile",
      "code": "# 依存関係インストールステージ\nFROM node:18-alpine AS deps\nWORKDIR /app\nCOPY package*.json ./\nRUN npm ci --only=production\n\n# ビルドステージ\nFROM node:18-alpine AS builder\nWORKDIR /app\nCOPY package*.json ./\nRUN npm ci\nCOPY . .\nRUN npm run build\n\n# 実行ステージ\nFROM node:18-alpine AS runner\nWORKDIR /app\n\nENV NODE_ENV=production\n\n# 必要なファイルのみコピー\nCOPY --from=deps /app/node_modules ./node_modules\nCOPY --from=builder /app/dist ./dist\nCOPY --from=builder /app/package.json ./\n\nUSER node\nEXPOSE 3000\nCMD [\"node\", \"dist/index.js\"]"
    },
    {
      "type": "codeBlock",
      "title": "React 静的サイトビルド",
      "language": "dockerfile",
      "code": "# ビルドステージ\nFROM node:18-alpine AS builder\nWORKDIR /app\n\nCOPY package*.json ./\nRUN npm ci\n\nCOPY . .\nRUN npm run build\n\n# Nginx 実行ステージ\nFROM nginx:alpine\n\n# ビルド成果物をコピー\nCOPY --from=builder /app/dist /usr/share/nginx/html\n\n# カスタム nginx 設定\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE 80\nCMD [\"nginx\", \"-g\", \"daemon off;\"]\n\n# 最終イメージ：約25MB（静的ファイル + nginx のみ）"
    },
    {
      "type": "comparison",
      "title": "イメージサイズ比較",
      "columns": [
        {
          "title": "シングルステージビルド",
          "color": "from-red-500 to-orange-500",
          "items": [
            {
              "label": "Go アプリ",
              "description": "約300MB"
            },
            {
              "label": "Node.js",
              "description": "約500MB"
            },
            {
              "label": "含む",
              "description": "ビルドツール、ソースコード"
            }
          ]
        },
        {
          "title": "マルチステージビルド",
          "color": "from-green-500 to-emerald-500",
          "items": [
            {
              "label": "Go アプリ",
              "description": "約15MB"
            },
            {
              "label": "Node.js",
              "description": "約150MB"
            },
            {
              "label": "含む",
              "description": "ランタイム依存のみ"
            }
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "高度なテクニック：条件付きビルド",
      "language": "dockerfile",
      "code": "# ベースステージ\nFROM golang:1.21-alpine AS base\nWORKDIR /app\nCOPY go.mod go.sum ./\nRUN go mod download\nCOPY . .\n\n# 開発ステージ（オプション）\nFROM base AS development\nRUN go install github.com/cosmtrek/air@latest\nCMD [\"air\"]\n\n# テストステージ\nFROM base AS test\nRUN go test -v ./...\n\n# 本番ビルド\nFROM base AS builder\nRUN CGO_ENABLED=0 go build -ldflags=\"-s -w\" -o /server\n\n# 本番実行\nFROM gcr.io/distroless/static-debian11 AS production\nCOPY --from=builder /server /\nCMD [\"/server\"]\n\n# 使用法：docker build --target production -t app:prod ."
    },
    {
      "type": "table",
      "title": "よく使うベースイメージ",
      "highlightFirst": true,
      "headers": [
        "イメージ",
        "サイズ",
        "適用シナリオ"
      ],
      "rows": [
        [
          "scratch",
          "0MB",
          "静的コンパイルバイナリ（Go/Rust）"
        ],
        [
          "distroless",
          "約2MB",
          "shell なし、高セキュリティ"
        ],
        [
          "alpine",
          "約5MB",
          "shell/ツールが必要"
        ],
        [
          "debian-slim",
          "約25MB",
          "glibc が必要"
        ]
      ]
    },
    {
      "type": "list",
      "title": "ベストプラクティス",
      "style": "check",
      "items": [
        {
          "label": "ビルドステージに名前を付ける",
          "description": "AS で命名し、可読性を向上"
        },
        {
          "label": "キャッシュを活用",
          "description": "依存ファイルを先にコピーし、ソースコードは後で"
        },
        {
          "label": "distroless を使用",
          "description": "本番環境では shell なしイメージを使用"
        },
        {
          "label": "バイナリを圧縮",
          "description": "Go では -ldflags=\"-s -w\" を使用"
        },
        {
          "label": "非 root で実行",
          "description": "USER 命令でユーザーを切り替え"
        }
      ]
    }
  ],
  "relatedTopics": [
    "Docker 基礎",
    "CI/CD",
    "セキュリティ"
  ]
}