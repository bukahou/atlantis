{
  "slug": "graphql",
  "meta": {
    "title": "GraphQL",
    "description": "GraphQL クエリ言語、Schema 設計とベストプラクティス",
    "order": 2,
    "tags": [
      "api",
      "graphql",
      "query",
      "backend"
    ]
  },
  "content": "<h1>GraphQL</h1>\n<h2>GraphQL 概要</h2>\n<p>GraphQL は API のためのクエリ言語で、クライアントが必要なデータを正確にリクエストでき、過剰取得や不足取得を回避できます。</p>\n<pre><code>GraphQL の特徴\n├── 精確なクエリ - クライアントが返却フィールドを指定\n├── 単一エンドポイント - すべてのリクエストが 1 つのエンドポイント\n├── 強い型付け - Schema で型システム定義\n├── イントロスペクション - API 自己記述能力\n└── リアルタイムサブスクリプション - リアルタイムデータ配信\n</code></pre>\n<h2>Schema 定義</h2>\n<h3>型システム</h3>\n<pre><code class=\"language-graphql\"># スカラー型\nscalar DateTime\nscalar JSON\n\n# 列挙型\nenum UserRole {\n  ADMIN\n  USER\n  GUEST\n}\n\nenum PostStatus {\n  DRAFT\n  PUBLISHED\n  ARCHIVED\n}\n\n# オブジェクト型\ntype User {\n  id: ID!\n  name: String!\n  email: String!\n  role: UserRole!\n  posts: [Post!]!\n  createdAt: DateTime!\n}\n\ntype Post {\n  id: ID!\n  title: String!\n  content: String!\n  status: PostStatus!\n  author: User!\n  comments: [Comment!]!\n  createdAt: DateTime!\n  updatedAt: DateTime!\n}\n\ntype Comment {\n  id: ID!\n  content: String!\n  author: User!\n  post: Post!\n  createdAt: DateTime!\n}\n\n# インターフェース型\ninterface Node {\n  id: ID!\n}\n\ntype User implements Node {\n  id: ID!\n  name: String!\n}\n\n# ユニオン型\nunion SearchResult = User | Post | Comment\n</code></pre>\n<h3>入力型</h3>\n<pre><code class=\"language-graphql\"># 入力型\ninput CreateUserInput {\n  name: String!\n  email: String!\n  password: String!\n  role: UserRole = USER\n}\n\ninput UpdateUserInput {\n  name: String\n  email: String\n}\n\ninput PostFilterInput {\n  status: PostStatus\n  authorId: ID\n  search: String\n}\n\ninput PaginationInput {\n  page: Int = 1\n  limit: Int = 20\n}\n</code></pre>\n<h3>Query と Mutation</h3>\n<pre><code class=\"language-graphql\">type Query {\n  # 単一リソース\n  user(id: ID!): User\n  post(id: ID!): Post\n\n  # 一覧クエリ\n  users(filter: UserFilterInput, pagination: PaginationInput): UserConnection!\n  posts(filter: PostFilterInput, pagination: PaginationInput): PostConnection!\n\n  # 検索\n  search(query: String!): [SearchResult!]!\n\n  # 現在のユーザー\n  me: User\n}\n\ntype Mutation {\n  # ユーザー操作\n  createUser(input: CreateUserInput!): User!\n  updateUser(id: ID!, input: UpdateUserInput!): User!\n  deleteUser(id: ID!): Boolean!\n\n  # 記事操作\n  createPost(input: CreatePostInput!): Post!\n  updatePost(id: ID!, input: UpdatePostInput!): Post!\n  deletePost(id: ID!): Boolean!\n  publishPost(id: ID!): Post!\n}\n\ntype Subscription {\n  postCreated: Post!\n  commentAdded(postId: ID!): Comment!\n}\n</code></pre>\n<h2>クエリ例</h2>\n<h3>基本クエリ</h3>\n<pre><code class=\"language-graphql\"># シンプルクエリ\nquery GetUser {\n  user(id: \"123\") {\n    id\n    name\n    email\n  }\n}\n\n# ネストクエリ\nquery GetUserWithPosts {\n  user(id: \"123\") {\n    name\n    posts {\n      title\n      status\n      comments {\n        content\n        author {\n          name\n        }\n      }\n    }\n  }\n}\n\n# エイリアス\nquery GetUsers {\n  admin: user(id: \"1\") { name }\n  guest: user(id: \"2\") { name }\n}\n\n# フラグメント\nfragment UserFields on User {\n  id\n  name\n  email\n}\n\nquery GetUsers {\n  user1: user(id: \"1\") { ...UserFields }\n  user2: user(id: \"2\") { ...UserFields }\n}\n</code></pre>\n<h3>変数</h3>\n<pre><code class=\"language-graphql\"># 変数付きクエリ\nquery GetUser($id: ID!) {\n  user(id: $id) {\n    id\n    name\n    email\n  }\n}\n\n# 変数\n{\n  \"id\": \"123\"\n}\n\n# デフォルト値付き\nquery GetPosts($status: PostStatus = PUBLISHED, $limit: Int = 10) {\n  posts(filter: { status: $status }, pagination: { limit: $limit }) {\n    edges {\n      node {\n        title\n      }\n    }\n  }\n}\n</code></pre>\n<h3>Mutation</h3>\n<pre><code class=\"language-graphql\">mutation CreateUser($input: CreateUserInput!) {\n  createUser(input: $input) {\n    id\n    name\n    email\n  }\n}\n\n# 変数\n{\n  \"input\": {\n    \"name\": \"Alice\",\n    \"email\": \"alice@example.com\",\n    \"password\": \"secret123\"\n  }\n}\n</code></pre>\n<h2>ページネーション</h2>\n<h3>Relay スタイルページネーション</h3>\n<pre><code class=\"language-graphql\">type UserConnection {\n  edges: [UserEdge!]!\n  pageInfo: PageInfo!\n  totalCount: Int!\n}\n\ntype UserEdge {\n  node: User!\n  cursor: String!\n}\n\ntype PageInfo {\n  hasNextPage: Boolean!\n  hasPreviousPage: Boolean!\n  startCursor: String\n  endCursor: String\n}\n\n# クエリ\nquery GetUsers($first: Int!, $after: String) {\n  users(first: $first, after: $after) {\n    edges {\n      node {\n        id\n        name\n      }\n      cursor\n    }\n    pageInfo {\n      hasNextPage\n      endCursor\n    }\n    totalCount\n  }\n}\n</code></pre>\n<h2>Resolver 実装</h2>\n<pre><code class=\"language-typescript\">// TypeScript + Apollo Server\nconst resolvers = {\n  Query: {\n    user: async (_, { id }, context) => {\n      return context.dataSources.userAPI.getUser(id);\n    },\n\n    users: async (_, { filter, pagination }, context) => {\n      return context.dataSources.userAPI.getUsers(filter, pagination);\n    },\n  },\n\n  Mutation: {\n    createUser: async (_, { input }, context) => {\n      return context.dataSources.userAPI.createUser(input);\n    },\n  },\n\n  User: {\n    posts: async (parent, _, context) => {\n      return context.dataSources.postAPI.getPostsByAuthor(parent.id);\n    },\n  },\n\n  Subscription: {\n    postCreated: {\n      subscribe: (_, __, { pubsub }) => {\n        return pubsub.asyncIterator(['POST_CREATED']);\n      },\n    },\n  },\n};\n</code></pre>\n<h2>N+1 問題の解決</h2>\n<pre><code class=\"language-typescript\">// DataLoader で N+1 解決\nimport DataLoader from 'dataloader';\n\nconst userLoader = new DataLoader(async (ids) => {\n  const users = await User.findByIds(ids);\n  return ids.map(id => users.find(u => u.id === id));\n});\n\nconst resolvers = {\n  Post: {\n    author: (post) => userLoader.load(post.authorId),\n  },\n};\n</code></pre>\n<h2>エラーハンドリング</h2>\n<pre><code class=\"language-graphql\"># エラーレスポンス\n{\n  \"data\": null,\n  \"errors\": [\n    {\n      \"message\": \"User not found\",\n      \"locations\": [{ \"line\": 2, \"column\": 3 }],\n      \"path\": [\"user\"],\n      \"extensions\": {\n        \"code\": \"NOT_FOUND\",\n        \"timestamp\": \"2024-01-15T10:30:00Z\"\n      }\n    }\n  ]\n}\n</code></pre>\n<h2>まとめ</h2>\n<p>GraphQL のポイント：</p>\n<ol>\n<li><strong>型システム</strong> - 強い型付け Schema 定義</li>\n<li><strong>精確なクエリ</strong> - クライアントが返却データを制御</li>\n<li><strong>単一エンドポイント</strong> - すべての操作が 1 つの URL</li>\n<li><strong>N+1 解決</strong> - DataLoader でバッチロード</li>\n<li><strong>リアルタイムサブスクリプション</strong> - Subscription サポート</li>\n</ol>\n"
}