{
  "slug": "pinia",
  "meta": {
    "title": "Pinia 状態管理",
    "description": "Vue 公式状態管理ライブラリ Pinia のコア機能とベストプラクティス",
    "order": 2,
    "tags": [
      "vue",
      "pinia",
      "state",
      "store"
    ]
  },
  "content": "<h1>Pinia 状態管理</h1>\n<h2>Pinia 概要</h2>\n<p>Pinia は Vue 公式推奨の状態管理ライブラリで、直感的な API と完全な TypeScript サポートを提供します。</p>\n<pre><code>Pinia の特徴\n├── シンプルな API - Composition API 風\n├── TypeScript サポート - 完全な型推論\n├── モジュール化 - ネストモジュールなし\n├── 開発者ツール - Vue DevTools 統合\n└── 軽量 - 約 1KB gzip\n</code></pre>\n<h2>インストールと設定</h2>\n<pre><code class=\"language-typescript\">// main.ts\nimport { createApp } from \"vue\";\nimport { createPinia } from \"pinia\";\nimport App from \"./App.vue\";\n\nconst app = createApp(App);\nconst pinia = createPinia();\n\napp.use(pinia);\napp.mount(\"#app\");\n</code></pre>\n<h2>Store の定義</h2>\n<h3>Options API スタイル</h3>\n<pre><code class=\"language-typescript\">// stores/counter.ts\nimport { defineStore } from \"pinia\";\n\nexport const useCounterStore = defineStore(\"counter\", {\n  state: () => ({\n    count: 0,\n    name: \"Counter\",\n  }),\n\n  getters: {\n    doubleCount: (state) => state.count * 2,\n    // this で他の getter にアクセス\n    doubleCountPlusOne(): number {\n      return this.doubleCount + 1;\n    },\n  },\n\n  actions: {\n    increment() {\n      this.count++;\n    },\n    async fetchData() {\n      const data = await api.getData();\n      this.count = data.count;\n    },\n  },\n});\n</code></pre>\n<h3>Composition API スタイル</h3>\n<pre><code class=\"language-typescript\">// stores/user.ts\nimport { defineStore } from \"pinia\";\nimport { ref, computed } from \"vue\";\n\nexport const useUserStore = defineStore(\"user\", () => {\n  // state\n  const user = ref&#x3C;User | null>(null);\n  const isLoading = ref(false);\n\n  // getters\n  const isLoggedIn = computed(() => !!user.value);\n  const userName = computed(() => user.value?.name ?? \"Guest\");\n\n  // actions\n  async function login(credentials: Credentials) {\n    isLoading.value = true;\n    try {\n      user.value = await api.login(credentials);\n    } finally {\n      isLoading.value = false;\n    }\n  }\n\n  function logout() {\n    user.value = null;\n  }\n\n  return {\n    user,\n    isLoading,\n    isLoggedIn,\n    userName,\n    login,\n    logout,\n  };\n});\n</code></pre>\n<h2>Store の使用</h2>\n<h3>コンポーネントでの使用</h3>\n<pre><code class=\"language-vue\">&#x3C;script setup lang=\"ts\">\nimport { useCounterStore } from \"@/stores/counter\";\nimport { storeToRefs } from \"pinia\";\n\nconst counterStore = useCounterStore();\n\n// 直接アクセス\nconsole.log(counterStore.count);\nconsole.log(counterStore.doubleCount);\n\n// 分割代入には storeToRefs でリアクティブ性を保持\nconst { count, doubleCount } = storeToRefs(counterStore);\n\n// actions は直接分割可能\nconst { increment } = counterStore;\n&#x3C;/script>\n\n&#x3C;template>\n  &#x3C;div>\n    &#x3C;p>Count: {{ count }}&#x3C;/p>\n    &#x3C;p>Double: {{ doubleCount }}&#x3C;/p>\n    &#x3C;button @click=\"increment\">+1&#x3C;/button>\n    &#x3C;button @click=\"counterStore.count++\">+1 直接変更&#x3C;/button>\n  &#x3C;/div>\n&#x3C;/template>\n</code></pre>\n<h3>状態の変更</h3>\n<pre><code class=\"language-typescript\">const store = useCounterStore();\n\n// 直接変更\nstore.count++;\n\n// $patch - バッチ変更\nstore.$patch({\n  count: store.count + 1,\n  name: \"New Name\",\n});\n\n// $patch 関数式\nstore.$patch((state) => {\n  state.count++;\n  state.items.push({ id: 1, name: \"item\" });\n});\n\n// state 全体を置換\nstore.$state = { count: 0, name: \"Reset\" };\n\n// 状態をリセット\nstore.$reset();\n</code></pre>\n<h2>変更の購読</h2>\n<pre><code class=\"language-typescript\">const store = useCounterStore();\n\n// 状態変更を購読\nstore.$subscribe((mutation, state) => {\n  console.log(\"Type:\", mutation.type);\n  console.log(\"Store ID:\", mutation.storeId);\n  console.log(\"State:\", state);\n});\n\n// action を購読\nstore.$onAction(({ name, store, args, after, onError }) => {\n  console.log(`Action ${name} called with`, args);\n\n  after((result) => {\n    console.log(\"Action completed with result:\", result);\n  });\n\n  onError((error) => {\n    console.error(\"Action failed:\", error);\n  });\n});\n</code></pre>\n<h2>Store 間の連携</h2>\n<pre><code class=\"language-typescript\">// stores/cart.ts\nimport { defineStore } from \"pinia\";\nimport { useUserStore } from \"./user\";\n\nexport const useCartStore = defineStore(\"cart\", () => {\n  const items = ref&#x3C;CartItem[]>([]);\n\n  // 他の store を使用\n  const userStore = useUserStore();\n\n  const canCheckout = computed(() => {\n    return userStore.isLoggedIn &#x26;&#x26; items.value.length > 0;\n  });\n\n  async function checkout() {\n    if (!userStore.isLoggedIn) {\n      throw new Error(\"Please login first\");\n    }\n    // チェックアウトロジック\n  }\n\n  return { items, canCheckout, checkout };\n});\n</code></pre>\n<h2>プラグイン</h2>\n<h3>永続化プラグイン</h3>\n<pre><code class=\"language-typescript\">// plugins/persistedState.ts\nimport { PiniaPluginContext } from \"pinia\";\n\nexport function persistedState({ store }: PiniaPluginContext) {\n  // localStorage から復元\n  const storedState = localStorage.getItem(store.$id);\n  if (storedState) {\n    store.$patch(JSON.parse(storedState));\n  }\n\n  // 変更を購読して保存\n  store.$subscribe((mutation, state) => {\n    localStorage.setItem(store.$id, JSON.stringify(state));\n  });\n}\n\n// main.ts\nconst pinia = createPinia();\npinia.use(persistedState);\n</code></pre>\n<h3>プロパティの追加</h3>\n<pre><code class=\"language-typescript\">// すべての store にプロパティを追加\npinia.use(({ store }) => {\n  store.$router = markRaw(router);\n});\n\n// 型宣言\ndeclare module \"pinia\" {\n  export interface PiniaCustomProperties {\n    $router: Router;\n  }\n}\n</code></pre>\n<h2>テスト</h2>\n<pre><code class=\"language-typescript\">import { setActivePinia, createPinia } from \"pinia\";\nimport { useCounterStore } from \"@/stores/counter\";\nimport { describe, it, expect, beforeEach } from \"vitest\";\n\ndescribe(\"Counter Store\", () => {\n  beforeEach(() => {\n    setActivePinia(createPinia());\n  });\n\n  it(\"increments count\", () => {\n    const store = useCounterStore();\n    expect(store.count).toBe(0);\n\n    store.increment();\n    expect(store.count).toBe(1);\n  });\n\n  it(\"computes double count\", () => {\n    const store = useCounterStore();\n    store.count = 5;\n    expect(store.doubleCount).toBe(10);\n  });\n});\n</code></pre>\n<h2>ベストプラクティス</h2>\n<pre><code class=\"language-typescript\">// stores/types.ts\nexport interface User {\n  id: string;\n  name: string;\n  email: string;\n}\n\n// stores/user.ts\nimport { defineStore } from \"pinia\";\nimport { ref, computed } from \"vue\";\nimport type { User } from \"./types\";\n\nexport const useUserStore = defineStore(\"user\", () => {\n  // 1. State\n  const user = ref&#x3C;User | null>(null);\n  const token = ref&#x3C;string | null>(null);\n  const isLoading = ref(false);\n  const error = ref&#x3C;string | null>(null);\n\n  // 2. Getters\n  const isAuthenticated = computed(() => !!token.value);\n\n  // 3. Actions - 非同期とビジネスロジック\n  async function fetchUser() {\n    if (!token.value) return;\n\n    isLoading.value = true;\n    error.value = null;\n\n    try {\n      user.value = await api.getUser();\n    } catch (e) {\n      error.value = e instanceof Error ? e.message : \"Unknown error\";\n    } finally {\n      isLoading.value = false;\n    }\n  }\n\n  // 4. クリーンアップ関数\n  function $reset() {\n    user.value = null;\n    token.value = null;\n    error.value = null;\n  }\n\n  return {\n    // State\n    user,\n    token,\n    isLoading,\n    error,\n    // Getters\n    isAuthenticated,\n    // Actions\n    fetchUser,\n    $reset,\n  };\n});\n</code></pre>\n<h2>まとめ</h2>\n<p>Pinia 状態管理のポイント：</p>\n<ol>\n<li><strong>シンプルな API</strong> - defineStore 定義、Composition または Options</li>\n<li><strong>リアクティブ</strong> - state、getters 自動反応</li>\n<li><strong>TypeScript</strong> - 完全な型推論</li>\n<li><strong>モジュール化</strong> - 独立 store、必要に応じてインポート</li>\n<li><strong>プラグインシステム</strong> - 永続化、ログなど拡張</li>\n</ol>\n"
}