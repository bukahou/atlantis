{
  "slug": "sharding",
  "meta": {
    "title": "シャーディング",
    "description": "データベースシャーディング戦略、分散データベースアーキテクチャとデータ移行",
    "order": 3,
    "tags": [
      "シャーディング",
      "パーティショニング",
      "分散"
    ]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "コアコンセプト",
      "items": [
        "単一データベース・テーブルでは要件を満たせない時に水平スケーリング",
        "垂直分割はビジネス別、水平分割はデータ別",
        "シャードキーがデータ分散を決定",
        "分散 ID でグローバルユニークを保証"
      ]
    },
    {
      "type": "comparison",
      "title": "分割方式",
      "columns": [
        {
          "title": "垂直分割",
          "color": "from-blue-500 to-cyan-500",
          "items": [
            {
              "label": "データベース分割",
              "description": "ビジネスドメイン別に分割"
            },
            {
              "label": "テーブル分割",
              "description": "大きなカラムをカラム別に分割"
            },
            {
              "label": "適用",
              "description": "ビジネスデカップリング"
            }
          ]
        },
        {
          "title": "水平分割",
          "color": "from-green-500 to-emerald-500",
          "items": [
            {
              "label": "データベース分割",
              "description": "データを複数 DB に分散"
            },
            {
              "label": "テーブル分割",
              "description": "データを複数テーブルに分散"
            },
            {
              "label": "適用",
              "description": "大規模データ"
            }
          ]
        }
      ]
    },
    {
      "type": "cards",
      "title": "シャーディング戦略",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "ハッシュシャーディング",
          "badge": "均等",
          "badgeColor": "blue",
          "points": [
            "user_id % N",
            "データ均等分布",
            "範囲クエリはクロスシャード"
          ]
        },
        {
          "title": "範囲シャーディング",
          "badge": "連続",
          "badgeColor": "green",
          "points": [
            "ID または時間範囲で分割",
            "範囲クエリが効率的",
            "データ偏りの可能性"
          ]
        },
        {
          "title": "コンシステントハッシュ",
          "badge": "拡張容易",
          "badgeColor": "purple",
          "points": [
            "仮想ノードリング",
            "拡張時のデータ移行が少ない",
            "負荷分散"
          ]
        },
        {
          "title": "複合シャーディング",
          "badge": "組み合わせ",
          "badgeColor": "amber",
          "points": [
            "まず時間で DB 分割",
            "次にハッシュでテーブル分割",
            "柔軟な組み合わせ"
          ]
        }
      ]
    },
    {
      "type": "table",
      "title": "シャードキー選択",
      "highlightFirst": true,
      "headers": [
        "要件",
        "説明",
        "例"
      ],
      "rows": [
        [
          "高離散性",
          "データ均等分布",
          "user_id"
        ],
        [
          "頻繁なクエリ",
          "クロスシャードクエリ回避",
          "注文クエリにユーザーID"
        ],
        [
          "変更が少ない",
          "データ移行回避",
          "ステータスフィールドは不使用"
        ]
      ]
    },
    {
      "type": "codeBlock",
      "title": "Snowflake ID",
      "language": "text",
      "code": "Snowflake ID 構造 (64 bit):\n┌─────────┬────────────┬──────────┬──────────┐\n│ 1 bit   │ 41 bit     │ 10 bit   │ 12 bit   │\n│ 符号ビット│ タイムスタンプ │ マシンID  │ シーケンス │\n└─────────┴────────────┴──────────┴──────────┘\n\n特徴:\n- 増加傾向、インデックスに適す\n- 分散生成、単一障害点なし\n- ミリ秒あたり 4096 ID"
    },
    {
      "type": "table",
      "title": "シャーディングミドルウェア",
      "highlightFirst": true,
      "headers": [
        "ミドルウェア",
        "特徴",
        "適用シナリオ"
      ],
      "rows": [
        [
          "ShardingSphere",
          "Java エコシステム、フル機能",
          "Java アプリ"
        ],
        [
          "Vitess",
          "MySQL 互換、クラウドネイティブ",
          "大規模クラスタ"
        ],
        [
          "MyCat",
          "国産、透過プロキシ",
          "中小規模"
        ]
      ]
    },
    {
      "type": "flow",
      "title": "データ移行ステップ",
      "direction": "horizontal",
      "steps": [
        {
          "label": "デュアルライト",
          "description": "新旧同期",
          "color": "bg-blue-500"
        },
        {
          "label": "履歴移行",
          "description": "バッチインポート",
          "color": "bg-purple-500"
        },
        {
          "label": "データ検証",
          "description": "整合性チェック",
          "color": "bg-cyan-500"
        },
        {
          "label": "読み取り切替",
          "description": "グレースケール切替",
          "color": "bg-amber-500"
        },
        {
          "label": "旧 DB 停止",
          "description": "移行完了",
          "color": "bg-green-500"
        }
      ]
    },
    {
      "type": "list",
      "title": "注意事項",
      "style": "check",
      "items": [
        {
          "label": "クロスシャードトランザクション回避",
          "description": "結果整合性または Saga を使用"
        },
        {
          "label": "クロスシャードクエリ",
          "description": "並列クエリ + 結果マージ"
        },
        {
          "label": "ページング問題",
          "description": "各シャードで多めに取得後ソート"
        },
        {
          "label": "グローバルテーブル",
          "description": "小テーブルを各シャードにフルコピー"
        }
      ]
    }
  ],
  "relatedTopics": [
    "分散トランザクション",
    "データベース正規化",
    "マイクロサービス"
  ]
}