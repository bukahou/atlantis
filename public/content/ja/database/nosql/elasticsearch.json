{
  "slug": "elasticsearch",
  "meta": {
    "title": "Elasticsearch",
    "description": "Elasticsearch 全文検索エンジン、インデックスとクエリ DSL",
    "order": 3,
    "tags": [
      "database",
      "elasticsearch",
      "nosql",
      "search"
    ]
  },
  "content": "<h1>Elasticsearch</h1>\n<h2>Elasticsearch 概要</h2>\n<p>Elasticsearch は分散検索・分析エンジンで、Lucene をベースに構築され、全文検索、構造化検索、分析をサポートします。</p>\n<pre><code>Elasticsearch 特性\n├── 分散 - 自動シャーディングとレプリカ\n├── 準リアルタイム - 秒単位の検索遅延\n├── RESTful API - JSON インタラクション\n├── 全文検索 - 転置インデックス\n├── 集約分析 - 多次元統計\n└── 高可用性 - ノード障害自動復旧\n</code></pre>\n<h2>コアコンセプト</h2>\n<pre><code>概念マッピング\n├── Index - インデックス (データベース相当)\n├── Document - ドキュメント (行相当)\n├── Field - フィールド (列相当)\n├── Mapping - マッピング (Schema 相当)\n├── Shard - シャード (データ分散)\n└── Replica - レプリカ (高可用性)\n</code></pre>\n<h2>インデックス操作</h2>\n<h3>インデックス作成</h3>\n<pre><code class=\"language-json\">// インデックス作成\nPUT /products\n{\n  \"settings\": {\n    \"number_of_shards\": 3,\n    \"number_of_replicas\": 1,\n    \"analysis\": {\n      \"analyzer\": {\n        \"my_analyzer\": {\n          \"type\": \"custom\",\n          \"tokenizer\": \"standard\",\n          \"filter\": [\"lowercase\", \"porter_stem\"]\n        }\n      }\n    }\n  },\n  \"mappings\": {\n    \"properties\": {\n      \"name\": {\n        \"type\": \"text\",\n        \"analyzer\": \"my_analyzer\"\n      },\n      \"price\": {\n        \"type\": \"float\"\n      },\n      \"category\": {\n        \"type\": \"keyword\"\n      },\n      \"description\": {\n        \"type\": \"text\"\n      },\n      \"created_at\": {\n        \"type\": \"date\"\n      },\n      \"tags\": {\n        \"type\": \"keyword\"\n      }\n    }\n  }\n}\n</code></pre>\n<h3>ドキュメント操作</h3>\n<pre><code class=\"language-json\">// ドキュメント作成\nPOST /products/_doc\n{\n  \"name\": \"iPhone 15\",\n  \"price\": 999.99,\n  \"category\": \"electronics\",\n  \"description\": \"Apple's latest smartphone\",\n  \"tags\": [\"phone\", \"apple\", \"5g\"]\n}\n\n// ID 指定\nPUT /products/_doc/1\n{\n  \"name\": \"MacBook Pro\",\n  \"price\": 1999.99,\n  \"category\": \"electronics\"\n}\n\n// ドキュメント更新\nPOST /products/_update/1\n{\n  \"doc\": {\n    \"price\": 1899.99\n  }\n}\n\n// ドキュメント削除\nDELETE /products/_doc/1\n\n// バルク操作\nPOST /_bulk\n{\"index\": {\"_index\": \"products\", \"_id\": \"1\"}}\n{\"name\": \"Product 1\", \"price\": 100}\n{\"index\": {\"_index\": \"products\", \"_id\": \"2\"}}\n{\"name\": \"Product 2\", \"price\": 200}\n</code></pre>\n<h2>クエリ DSL</h2>\n<h3>基本クエリ</h3>\n<pre><code class=\"language-json\">// Match クエリ\nGET /products/_search\n{\n  \"query\": {\n    \"match\": {\n      \"name\": \"iphone\"\n    }\n  }\n}\n\n// Term クエリ (完全一致)\nGET /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"category\": \"electronics\"\n    }\n  }\n}\n\n// Range クエリ\nGET /products/_search\n{\n  \"query\": {\n    \"range\": {\n      \"price\": {\n        \"gte\": 100,\n        \"lte\": 500\n      }\n    }\n  }\n}\n\n// Bool クエリ\nGET /products/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        { \"match\": { \"name\": \"phone\" } }\n      ],\n      \"filter\": [\n        { \"term\": { \"category\": \"electronics\" } },\n        { \"range\": { \"price\": { \"lte\": 1000 } } }\n      ],\n      \"should\": [\n        { \"term\": { \"tags\": \"5g\" } }\n      ],\n      \"must_not\": [\n        { \"term\": { \"category\": \"refurbished\" } }\n      ]\n    }\n  }\n}\n</code></pre>\n<h3>全文検索</h3>\n<pre><code class=\"language-json\">// Multi-match\nGET /products/_search\n{\n  \"query\": {\n    \"multi_match\": {\n      \"query\": \"apple phone\",\n      \"fields\": [\"name^2\", \"description\"],\n      \"type\": \"best_fields\"\n    }\n  }\n}\n\n// Match Phrase\nGET /products/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"description\": \"latest smartphone\"\n    }\n  }\n}\n\n// Fuzzy クエリ\nGET /products/_search\n{\n  \"query\": {\n    \"fuzzy\": {\n      \"name\": {\n        \"value\": \"iphon\",\n        \"fuzziness\": \"AUTO\"\n      }\n    }\n  }\n}\n\n// ハイライト\nGET /products/_search\n{\n  \"query\": {\n    \"match\": { \"description\": \"smartphone\" }\n  },\n  \"highlight\": {\n    \"fields\": {\n      \"description\": {}\n    }\n  }\n}\n</code></pre>\n<h2>集約分析</h2>\n<h3>バケット集約</h3>\n<pre><code class=\"language-json\">// Terms 集約\nGET /products/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"categories\": {\n      \"terms\": {\n        \"field\": \"category\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\n// 範囲集約\nGET /products/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"price_ranges\": {\n      \"range\": {\n        \"field\": \"price\",\n        \"ranges\": [\n          { \"to\": 100 },\n          { \"from\": 100, \"to\": 500 },\n          { \"from\": 500 }\n        ]\n      }\n    }\n  }\n}\n\n// 日付ヒストグラム\nGET /orders/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"orders_over_time\": {\n      \"date_histogram\": {\n        \"field\": \"created_at\",\n        \"calendar_interval\": \"month\"\n      }\n    }\n  }\n}\n</code></pre>\n<h3>メトリクス集約</h3>\n<pre><code class=\"language-json\">// 統計集約\nGET /products/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"price_stats\": {\n      \"stats\": {\n        \"field\": \"price\"\n      }\n    }\n  }\n}\n\n// ネスト集約\nGET /orders/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"by_category\": {\n      \"terms\": {\n        \"field\": \"category\"\n      },\n      \"aggs\": {\n        \"avg_price\": {\n          \"avg\": { \"field\": \"price\" }\n        },\n        \"total_sales\": {\n          \"sum\": { \"field\": \"amount\" }\n        }\n      }\n    }\n  }\n}\n</code></pre>\n<h2>Go クライアント</h2>\n<pre><code class=\"language-go\">import \"github.com/elastic/go-elasticsearch/v8\"\n\n// 接続\nes, _ := elasticsearch.NewClient(elasticsearch.Config{\n    Addresses: []string{\"http://localhost:9200\"},\n})\n\n// ドキュメントインデックス\ndoc := map[string]interface{}{\n    \"name\":  \"Product\",\n    \"price\": 99.99,\n}\nbody, _ := json.Marshal(doc)\nes.Index(\"products\", bytes.NewReader(body))\n\n// 検索\nquery := map[string]interface{}{\n    \"query\": map[string]interface{}{\n        \"match\": map[string]interface{}{\n            \"name\": \"product\",\n        },\n    },\n}\nbody, _ := json.Marshal(query)\nres, _ := es.Search(\n    es.Search.WithIndex(\"products\"),\n    es.Search.WithBody(bytes.NewReader(body)),\n)\n</code></pre>\n<h2>パフォーマンス最適化</h2>\n<pre><code class=\"language-yaml\"># インデックス最適化\n├── 適切なシャード数 - 1シャード 10-50GB\n├── バルクインデックス - bulk API\n├── リフレッシュ間隔 - refresh_interval\n└── レプリカ設定 - 読み書き比率\n\n# クエリ最適化\n├── filter 使用 - キャッシュ可能\n├── 深いページング回避 - search_after\n├── 返却フィールド制限 - _source\n└── キャッシュウォームアップ - warmer\n</code></pre>\n<h2>まとめ</h2>\n<p>Elasticsearch のポイント：</p>\n<ol>\n<li><strong>インデックス設計</strong> - Mapping、シャード、レプリカ</li>\n<li><strong>クエリ DSL</strong> - Match、Bool、Range</li>\n<li><strong>全文検索</strong> - トークナイズ、ハイライト、ファジー</li>\n<li><strong>集約</strong> - バケット集約、メトリクス集約</li>\n<li><strong>パフォーマンス</strong> - バルク操作、Filter キャッシュ</li>\n</ol>\n"
}