{
  "slug": "helm",
  "meta": {
    "title": "Helm 包管理详解",
    "description": "Helm Chart 开发、仓库管理与最佳实践",
    "order": 4,
    "tags": [
      "kubernetes",
      "helm",
      "chart",
      "package-manager"
    ]
  },
  "content": "<h1>Helm 包管理详解</h1>\n<h2>Helm 概念</h2>\n<p>Helm 是 Kubernetes 的包管理器，类似于 apt/yum，用于定义、安装和升级复杂的 Kubernetes 应用。</p>\n<pre><code>Helm 架构\n┌─────────────────────────────────────────┐\n│ Helm CLI                                │\n│   helm install / upgrade / rollback     │\n└──────────────────┬──────────────────────┘\n                   │\n                   ▼\n┌─────────────────────────────────────────┐\n│ Chart                                   │\n│   ├── Chart.yaml     (元数据)           │\n│   ├── values.yaml    (默认值)           │\n│   ├── templates/     (K8s 模板)         │\n│   └── charts/        (依赖)             │\n└──────────────────┬──────────────────────┘\n                   │\n                   ▼\n┌─────────────────────────────────────────┐\n│ Kubernetes Cluster                      │\n│   Release: 运行中的 Chart 实例          │\n└─────────────────────────────────────────┘\n</code></pre>\n<h2>基础命令</h2>\n<h3>仓库管理</h3>\n<pre><code class=\"language-bash\"># 添加仓库\nhelm repo add bitnami https://charts.bitnami.com/bitnami\nhelm repo add stable https://charts.helm.sh/stable\n\n# 更新仓库\nhelm repo update\n\n# 搜索 Chart\nhelm search repo nginx\nhelm search hub wordpress  # 搜索 Artifact Hub\n\n# 查看仓库\nhelm repo list\n\n# 删除仓库\nhelm repo remove stable\n</code></pre>\n<h3>安装应用</h3>\n<pre><code class=\"language-bash\"># 安装 Chart\nhelm install my-nginx bitnami/nginx\n\n# 指定命名空间\nhelm install my-nginx bitnami/nginx -n production --create-namespace\n\n# 使用自定义值\nhelm install my-nginx bitnami/nginx -f values.yaml\n\n# 命令行覆盖值\nhelm install my-nginx bitnami/nginx \\\n  --set service.type=LoadBalancer \\\n  --set replicaCount=3\n\n# 安装前模拟\nhelm install my-nginx bitnami/nginx --dry-run --debug\n\n# 等待就绪\nhelm install my-nginx bitnami/nginx --wait --timeout 5m\n</code></pre>\n<h3>管理 Release</h3>\n<pre><code class=\"language-bash\"># 查看 Release\nhelm list\nhelm list -A  # 所有命名空间\nhelm list -a  # 包括失败的\n\n# 查看状态\nhelm status my-nginx\n\n# 获取值\nhelm get values my-nginx\nhelm get values my-nginx --all  # 包括默认值\n\n# 获取 manifest\nhelm get manifest my-nginx\n\n# 升级\nhelm upgrade my-nginx bitnami/nginx --set replicaCount=5\nhelm upgrade my-nginx bitnami/nginx -f new-values.yaml\n\n# 回滚\nhelm rollback my-nginx 1  # 回滚到版本1\nhelm history my-nginx     # 查看历史\n\n# 卸载\nhelm uninstall my-nginx\nhelm uninstall my-nginx --keep-history  # 保留历史\n</code></pre>\n<h2>创建 Chart</h2>\n<h3>初始化</h3>\n<pre><code class=\"language-bash\"># 创建 Chart 骨架\nhelm create myapp\n\n# 目录结构\nmyapp/\n├── Chart.yaml          # Chart 元数据\n├── values.yaml         # 默认配置值\n├── charts/             # 依赖 Chart\n├── templates/          # 模板文件\n│   ├── deployment.yaml\n│   ├── service.yaml\n│   ├── ingress.yaml\n│   ├── hpa.yaml\n│   ├── serviceaccount.yaml\n│   ├── _helpers.tpl    # 模板助手\n│   ├── NOTES.txt       # 安装说明\n│   └── tests/\n│       └── test-connection.yaml\n└── .helmignore         # 忽略文件\n</code></pre>\n<h3>Chart.yaml</h3>\n<pre><code class=\"language-yaml\">apiVersion: v2\nname: myapp\ndescription: A Helm chart for MyApp\ntype: application\nversion: 1.0.0      # Chart 版本\nappVersion: \"2.0.0\" # 应用版本\n\nkeywords:\n  - webapp\n  - nodejs\n\nhome: https://github.com/myorg/myapp\nsources:\n  - https://github.com/myorg/myapp\n\nmaintainers:\n  - name: DevOps Team\n    email: devops@example.com\n\ndependencies:\n  - name: postgresql\n    version: \"12.x.x\"\n    repository: https://charts.bitnami.com/bitnami\n    condition: postgresql.enabled\n  - name: redis\n    version: \"17.x.x\"\n    repository: https://charts.bitnami.com/bitnami\n    condition: redis.enabled\n</code></pre>\n<h3>values.yaml</h3>\n<pre><code class=\"language-yaml\"># 副本数\nreplicaCount: 3\n\n# 镜像配置\nimage:\n  repository: myapp\n  tag: \"2.0.0\"\n  pullPolicy: IfNotPresent\n\nimagePullSecrets: []\n\n# Service 配置\nservice:\n  type: ClusterIP\n  port: 80\n\n# Ingress 配置\ningress:\n  enabled: true\n  className: nginx\n  annotations:\n    nginx.ingress.kubernetes.io/rewrite-target: /\n  hosts:\n    - host: myapp.example.com\n      paths:\n        - path: /\n          pathType: Prefix\n  tls:\n    - secretName: myapp-tls\n      hosts:\n        - myapp.example.com\n\n# 资源限制\nresources:\n  requests:\n    cpu: 100m\n    memory: 128Mi\n  limits:\n    cpu: 500m\n    memory: 256Mi\n\n# 自动扩缩容\nautoscaling:\n  enabled: true\n  minReplicas: 2\n  maxReplicas: 10\n  targetCPUUtilizationPercentage: 70\n\n# 探针配置\nlivenessProbe:\n  httpGet:\n    path: /health\n    port: http\n  initialDelaySeconds: 15\n\nreadinessProbe:\n  httpGet:\n    path: /ready\n    port: http\n  initialDelaySeconds: 5\n\n# 环境变量\nenv:\n  - name: NODE_ENV\n    value: production\n\n# ConfigMap\nconfig:\n  LOG_LEVEL: info\n  CACHE_TTL: \"3600\"\n\n# Secret (建议使用外部 Secret 管理)\nsecrets: {}\n\n# 依赖开关\npostgresql:\n  enabled: true\n  auth:\n    database: myapp\n    username: myapp\n\nredis:\n  enabled: false\n</code></pre>\n<h2>模板语法</h2>\n<h3>基础语法</h3>\n<pre><code class=\"language-yaml\"># templates/deployment.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: {{ include \"myapp.fullname\" . }}\n  labels:\n    {{- include \"myapp.labels\" . | nindent 4 }}\nspec:\n  {{- if not .Values.autoscaling.enabled }}\n  replicas: {{ .Values.replicaCount }}\n  {{- end }}\n  selector:\n    matchLabels:\n      {{- include \"myapp.selectorLabels\" . | nindent 6 }}\n  template:\n    metadata:\n      labels:\n        {{- include \"myapp.selectorLabels\" . | nindent 8 }}\n    spec:\n      containers:\n        - name: {{ .Chart.Name }}\n          image: \"{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}\"\n          imagePullPolicy: {{ .Values.image.pullPolicy }}\n          ports:\n            - name: http\n              containerPort: 8080\n          {{- with .Values.env }}\n          env:\n            {{- toYaml . | nindent 12 }}\n          {{- end }}\n          {{- with .Values.resources }}\n          resources:\n            {{- toYaml . | nindent 12 }}\n          {{- end }}\n</code></pre>\n<h3>_helpers.tpl</h3>\n<pre><code class=\"language-yaml\"># templates/_helpers.tpl\n\n{{/*\n应用名称\n*/}}\n{{- define \"myapp.name\" -}}\n{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix \"-\" }}\n{{- end }}\n\n{{/*\n完整名称\n*/}}\n{{- define \"myapp.fullname\" -}}\n{{- if .Values.fullnameOverride }}\n{{- .Values.fullnameOverride | trunc 63 | trimSuffix \"-\" }}\n{{- else }}\n{{- $name := default .Chart.Name .Values.nameOverride }}\n{{- printf \"%s-%s\" .Release.Name $name | trunc 63 | trimSuffix \"-\" }}\n{{- end }}\n{{- end }}\n\n{{/*\n通用标签\n*/}}\n{{- define \"myapp.labels\" -}}\nhelm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace \"+\" \"_\" }}\napp.kubernetes.io/name: {{ include \"myapp.name\" . }}\napp.kubernetes.io/instance: {{ .Release.Name }}\napp.kubernetes.io/version: {{ .Chart.AppVersion | quote }}\napp.kubernetes.io/managed-by: {{ .Release.Service }}\n{{- end }}\n\n{{/*\n选择器标签\n*/}}\n{{- define \"myapp.selectorLabels\" -}}\napp.kubernetes.io/name: {{ include \"myapp.name\" . }}\napp.kubernetes.io/instance: {{ .Release.Name }}\n{{- end }}\n</code></pre>\n<h3>条件与循环</h3>\n<pre><code class=\"language-yaml\"># 条件判断\n{{- if .Values.ingress.enabled }}\napiVersion: networking.k8s.io/v1\nkind: Ingress\n...\n{{- end }}\n\n# 三元运算\n{{ .Values.env | default \"production\" }}\n\n# 循环\n{{- range .Values.ingress.hosts }}\n  - host: {{ .host | quote }}\n    http:\n      paths:\n        {{- range .paths }}\n        - path: {{ .path }}\n          pathType: {{ .pathType }}\n        {{- end }}\n{{- end }}\n\n# with 语句\n{{- with .Values.nodeSelector }}\nnodeSelector:\n  {{- toYaml . | nindent 2 }}\n{{- end }}\n</code></pre>\n<h3>常用函数</h3>\n<pre><code class=\"language-yaml\"># 字符串函数\n{{ .Values.name | upper }}\n{{ .Values.name | lower }}\n{{ .Values.name | title }}\n{{ .Values.name | quote }}\n{{ .Values.name | trunc 63 }}\n{{ .Values.name | trimSuffix \"-\" }}\n{{ printf \"%s-%s\" .Release.Name .Chart.Name }}\n\n# 类型转换\n{{ .Values.port | int }}\n{{ .Values.enabled | toString }}\n\n# 默认值\n{{ .Values.tag | default .Chart.AppVersion }}\n{{ .Values.name | default \"myapp\" }}\n\n# 必填检查\n{{ required \"image.repository is required\" .Values.image.repository }}\n\n# 编码\n{{ .Values.data | b64enc }}\n{{ .Values.data | b64dec }}\n\n# YAML/JSON\n{{ toYaml .Values.resources }}\n{{ toJson .Values.config }}\n\n# 缩进\n{{ toYaml .Values.resources | nindent 4 }}\n{{ include \"myapp.labels\" . | indent 4 }}\n</code></pre>\n<h2>依赖管理</h2>\n<pre><code class=\"language-bash\"># 更新依赖\nhelm dependency update ./myapp\n\n# 构建依赖\nhelm dependency build ./myapp\n\n# 查看依赖\nhelm dependency list ./myapp\n</code></pre>\n<pre><code class=\"language-yaml\"># Chart.yaml 中定义依赖\ndependencies:\n  - name: postgresql\n    version: \"12.1.0\"\n    repository: https://charts.bitnami.com/bitnami\n    condition: postgresql.enabled\n    tags:\n      - database\n    import-values:\n      - child: primary.service\n        parent: database\n</code></pre>\n<h2>打包与发布</h2>\n<pre><code class=\"language-bash\"># 校验 Chart\nhelm lint ./myapp\n\n# 打包\nhelm package ./myapp\n# 输出: myapp-1.0.0.tgz\n\n# 创建索引\nhelm repo index . --url https://charts.example.com\n\n# 推送到 OCI 仓库\nhelm push myapp-1.0.0.tgz oci://registry.example.com/charts\n\n# 从 OCI 安装\nhelm install my-release oci://registry.example.com/charts/myapp --version 1.0.0\n</code></pre>\n<h2>Helmfile</h2>\n<p>多 Chart 管理工具。</p>\n<pre><code class=\"language-yaml\"># helmfile.yaml\nrepositories:\n  - name: bitnami\n    url: https://charts.bitnami.com/bitnami\n\nreleases:\n  - name: nginx\n    namespace: web\n    chart: bitnami/nginx\n    version: 15.0.0\n    values:\n      - values/nginx.yaml\n    set:\n      - name: replicaCount\n        value: 3\n\n  - name: redis\n    namespace: cache\n    chart: bitnami/redis\n    version: 17.0.0\n    values:\n      - values/redis.yaml\n\nenvironments:\n  production:\n    values:\n      - env/production.yaml\n  staging:\n    values:\n      - env/staging.yaml\n</code></pre>\n<pre><code class=\"language-bash\"># 应用所有 Release\nhelmfile apply\n\n# 指定环境\nhelmfile -e production apply\n\n# 同步\nhelmfile sync\n\n# 差异对比\nhelmfile diff\n</code></pre>\n<h2>常用命令速查</h2>\n<pre><code class=\"language-bash\"># Chart 开发\nhelm create myapp          # 创建\nhelm lint ./myapp          # 校验\nhelm template ./myapp      # 渲染模板\nhelm package ./myapp       # 打包\n\n# 安装管理\nhelm install NAME CHART    # 安装\nhelm upgrade NAME CHART    # 升级\nhelm rollback NAME REV     # 回滚\nhelm uninstall NAME        # 卸载\n\n# 查询\nhelm list                  # 列出 Release\nhelm status NAME           # 状态\nhelm history NAME          # 历史\nhelm get values NAME       # 获取值\nhelm get manifest NAME     # 获取清单\n\n# 仓库\nhelm repo add NAME URL     # 添加\nhelm repo update           # 更新\nhelm search repo KEYWORD   # 搜索\n</code></pre>\n<h2>最佳实践</h2>\n<ol>\n<li><strong>版本控制</strong> - Chart 和 values 文件纳入 Git</li>\n<li><strong>环境分离</strong> - 不同环境使用不同 values 文件</li>\n<li><strong>Secrets 管理</strong> - 使用 helm-secrets 或 Sealed Secrets</li>\n<li><strong>模板复用</strong> - 善用 _helpers.tpl 和 named templates</li>\n<li><strong>依赖锁定</strong> - 使用 Chart.lock 锁定版本</li>\n<li><strong>校验测试</strong> - helm lint + helm test</li>\n<li><strong>语义化版本</strong> - Chart 和应用分开版本控制</li>\n<li><strong>文档注释</strong> - values.yaml 添加详细注释</li>\n</ol>\n"
}