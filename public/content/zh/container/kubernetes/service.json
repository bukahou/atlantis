{
  "slug": "service",
  "meta": {
    "title": "Service 与网络",
    "description": "Kubernetes 网络：Service、Ingress 与 NetworkPolicy",
    "order": 2,
    "tags": [
      "Kubernetes",
      "Service",
      "Ingress",
      "NetworkPolicy"
    ]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "核心概念",
      "items": [
        "Service 提供稳定的访问入口和负载均衡",
        "Ingress 实现 HTTP/HTTPS 路由和 TLS 终止",
        "NetworkPolicy 控制 Pod 间的网络流量",
        "CoreDNS 提供集群内服务发现"
      ]
    },
    {
      "type": "comparison",
      "title": "Service 类型",
      "columns": [
        {
          "title": "ClusterIP",
          "color": "from-blue-500 to-cyan-500",
          "items": [
            {
              "label": "范围",
              "description": "集群内部访问"
            },
            {
              "label": "IP",
              "description": "虚拟 ClusterIP"
            },
            {
              "label": "场景",
              "description": "内部服务通信"
            }
          ]
        },
        {
          "title": "NodePort",
          "color": "from-green-500 to-emerald-500",
          "items": [
            {
              "label": "范围",
              "description": "节点 IP + 端口"
            },
            {
              "label": "端口",
              "description": "30000-32767"
            },
            {
              "label": "场景",
              "description": "开发测试环境"
            }
          ]
        },
        {
          "title": "LoadBalancer",
          "color": "from-purple-500 to-pink-500",
          "items": [
            {
              "label": "范围",
              "description": "外部负载均衡器"
            },
            {
              "label": "IP",
              "description": "云厂商分配"
            },
            {
              "label": "场景",
              "description": "生产环境暴露服务"
            }
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "Service 配置示例",
      "language": "yaml",
      "code": "# ClusterIP (默认)\napiVersion: v1\nkind: Service\nmetadata:\n  name: web-service\nspec:\n  type: ClusterIP\n  selector:\n    app: web\n  ports:\n  - name: http\n    port: 80          # Service 端口\n    targetPort: 8080  # Pod 端口\n---\n# Headless Service (用于 StatefulSet)\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql\nspec:\n  clusterIP: None  # Headless\n  selector:\n    app: mysql\n  ports:\n  - port: 3306\n# DNS: mysql-0.mysql.namespace.svc.cluster.local\n---\n# ExternalName (外部服务代理)\napiVersion: v1\nkind: Service\nmetadata:\n  name: external-db\nspec:\n  type: ExternalName\n  externalName: db.example.com"
    },
    {
      "type": "codeBlock",
      "title": "Ingress 配置",
      "language": "yaml",
      "code": "# 需要安装 Ingress Controller (nginx/traefik/等)\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: app-ingress\n  annotations:\n    nginx.ingress.kubernetes.io/ssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io/proxy-body-size: \"50m\"\nspec:\n  ingressClassName: nginx\n  tls:\n  - hosts:\n    - api.example.com\n    - web.example.com\n    secretName: tls-secret\n  rules:\n  # 基于 Host 路由\n  - host: api.example.com\n    http:\n      paths:\n      - path: /\n        pathType: Prefix\n        backend:\n          service:\n            name: api-service\n            port:\n              number: 80\n  - host: web.example.com\n    http:\n      paths:\n      # 基于 Path 路由\n      - path: /api\n        pathType: Prefix\n        backend:\n          service:\n            name: api-service\n            port:\n              number: 80\n      - path: /\n        pathType: Prefix\n        backend:\n          service:\n            name: frontend\n            port:\n              number: 80"
    },
    {
      "type": "table",
      "title": "Ingress Path 类型",
      "highlightFirst": true,
      "headers": [
        "类型",
        "匹配规则",
        "示例"
      ],
      "rows": [
        [
          "Exact",
          "精确匹配",
          "/api 只匹配 /api"
        ],
        [
          "Prefix",
          "前缀匹配",
          "/api 匹配 /api, /api/v1"
        ],
        [
          "ImplementationSpecific",
          "控制器特定",
          "取决于 Ingress 实现"
        ]
      ]
    },
    {
      "type": "codeBlock",
      "title": "NetworkPolicy 网络策略",
      "language": "yaml",
      "code": "# 默认拒绝所有入站流量\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: default-deny-ingress\n  namespace: production\nspec:\n  podSelector: {}  # 选择所有 Pod\n  policyTypes:\n  - Ingress\n---\n# 允许特定流量\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: api-policy\n  namespace: production\nspec:\n  podSelector:\n    matchLabels:\n      app: api\n  policyTypes:\n  - Ingress\n  - Egress\n  ingress:\n  # 允许来自 frontend 的流量\n  - from:\n    - podSelector:\n        matchLabels:\n          app: frontend\n    ports:\n    - protocol: TCP\n      port: 8080\n  # 允许来自 monitoring 命名空间\n  - from:\n    - namespaceSelector:\n        matchLabels:\n          name: monitoring\n  egress:\n  # 允许访问数据库\n  - to:\n    - podSelector:\n        matchLabels:\n          app: database\n    ports:\n    - protocol: TCP\n      port: 5432\n  # 允许 DNS 查询\n  - to:\n    - namespaceSelector: {}\n    ports:\n    - protocol: UDP\n      port: 53"
    },
    {
      "type": "cards",
      "title": "网络功能",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "服务发现 (DNS)",
          "badge": "CoreDNS",
          "badgeColor": "blue",
          "points": [
            "<service>.<ns>.svc.cluster.local",
            "<pod-ip>.<ns>.pod.cluster.local",
            "自动 A/AAAA/SRV 记录"
          ]
        },
        {
          "title": "负载均衡",
          "badge": "kube-proxy",
          "badgeColor": "green",
          "points": [
            "iptables 模式 (默认)",
            "IPVS 模式 (高性能)",
            "轮询/最少连接等策略"
          ]
        },
        {
          "title": "Ingress Controller",
          "badge": "HTTP",
          "badgeColor": "amber",
          "points": [
            "Nginx Ingress (最流行)",
            "Traefik (云原生)",
            "AWS ALB / GCE"
          ]
        },
        {
          "title": "CNI 网络插件",
          "badge": "CNI",
          "badgeColor": "purple",
          "points": [
            "Calico (NetworkPolicy)",
            "Cilium (eBPF)",
            "Flannel (简单)"
          ]
        }
      ]
    },
    {
      "type": "flow",
      "title": "流量路径",
      "direction": "horizontal",
      "steps": [
        {
          "label": "Client",
          "description": "外部请求",
          "color": "bg-gray-500"
        },
        {
          "label": "Ingress",
          "description": "HTTP 路由",
          "color": "bg-blue-500"
        },
        {
          "label": "Service",
          "description": "负载均衡",
          "color": "bg-cyan-500"
        },
        {
          "label": "Pod",
          "description": "目标容器",
          "color": "bg-green-500"
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "网络调试",
      "language": "bash",
      "code": "# 检查 Service\nkubectl get svc\nkubectl describe svc <service-name>\nkubectl get endpoints <service-name>\n\n# 检查 Ingress\nkubectl get ingress\nkubectl describe ingress <ingress-name>\n\n# 检查 NetworkPolicy\nkubectl get networkpolicy -A\n\n# DNS 调试\nkubectl run tmp --image=busybox -it --rm -- nslookup <service-name>\n\n# 网络连通性测试\nkubectl run tmp --image=curlimages/curl -it --rm -- curl <service-name>:80"
    },
    {
      "type": "list",
      "title": "网络最佳实践",
      "style": "check",
      "items": [
        {
          "label": "使用 Ingress",
          "description": "统一管理 HTTP 路由，减少 LoadBalancer 成本"
        },
        {
          "label": "启用 NetworkPolicy",
          "description": "实施零信任网络，限制 Pod 间通信"
        },
        {
          "label": "Headless Service",
          "description": "StatefulSet 场景使用 clusterIP: None"
        },
        {
          "label": "TLS 终止",
          "description": "在 Ingress 层统一管理 TLS 证书"
        },
        {
          "label": "使用支持 NetworkPolicy 的 CNI",
          "description": "如 Calico/Cilium"
        }
      ]
    }
  ],
  "relatedTopics": [
    "Pod",
    "Ingress Controller",
    "Service Mesh",
    "安全"
  ]
}