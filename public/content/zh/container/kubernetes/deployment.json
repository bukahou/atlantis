{
  "slug": "deployment",
  "meta": {
    "title": "Deployment 部署",
    "description": "声明式部署、滚动更新与回滚",
    "order": 3,
    "tags": [
      "Kubernetes",
      "Deployment",
      "部署"
    ]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "核心概念",
      "items": [
        "Deployment 管理 Pod 的副本和更新",
        "声明式配置，自动调谐到期望状态",
        "支持滚动更新和回滚",
        "通过 ReplicaSet 实现副本管理"
      ]
    },
    {
      "type": "text",
      "title": "什么是 Deployment",
      "content": "Deployment 是 Kubernetes 中最常用的工作负载控制器，它提供声明式的 Pod 更新能力。你只需要描述期望的状态，Deployment Controller 会自动将实际状态调谐到期望状态，支持滚动更新、回滚等高级特性。"
    },
    {
      "type": "codeBlock",
      "title": "Deployment 配置示例",
      "language": "yaml",
      "code": "apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: web-app\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: web\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxSurge: 1        # 最多超出期望副本数\n      maxUnavailable: 0  # 最多不可用副本数\n  template:\n    metadata:\n      labels:\n        app: web\n    spec:\n      containers:\n      - name: web\n        image: nginx:1.24\n        ports:\n        - containerPort: 80\n        resources:\n          requests:\n            cpu: 100m\n            memory: 128Mi\n          limits:\n            cpu: 200m\n            memory: 256Mi"
    },
    {
      "type": "flow",
      "title": "滚动更新过程",
      "subtitle": "逐步替换旧 Pod",
      "direction": "horizontal",
      "steps": [
        {
          "label": "v1: 3 Pods",
          "description": "当前状态",
          "color": "bg-gray-500"
        },
        {
          "label": "v2: 1 Pod",
          "description": "创建新版本",
          "color": "bg-blue-500"
        },
        {
          "label": "v1: 2 + v2: 1",
          "description": "逐步替换",
          "color": "bg-purple-500"
        },
        {
          "label": "v1: 1 + v2: 2",
          "description": "继续替换",
          "color": "bg-cyan-500"
        },
        {
          "label": "v2: 3 Pods",
          "description": "完成更新",
          "color": "bg-green-500"
        }
      ]
    },
    {
      "type": "comparison",
      "title": "更新策略",
      "columns": [
        {
          "title": "RollingUpdate",
          "color": "from-green-500 to-emerald-500",
          "items": [
            {
              "label": "方式",
              "description": "逐步更新"
            },
            {
              "label": "中断",
              "description": "零停机"
            },
            {
              "label": "参数",
              "description": "maxSurge, maxUnavailable"
            },
            {
              "label": "推荐",
              "description": "生产环境首选"
            }
          ]
        },
        {
          "title": "Recreate",
          "color": "from-red-500 to-orange-500",
          "items": [
            {
              "label": "方式",
              "description": "先删后建"
            },
            {
              "label": "中断",
              "description": "有停机时间"
            },
            {
              "label": "参数",
              "description": "无"
            },
            {
              "label": "推荐",
              "description": "不支持多版本共存"
            }
          ]
        }
      ]
    },
    {
      "type": "table",
      "title": "Deployment 操作命令",
      "highlightFirst": true,
      "headers": [
        "命令",
        "说明"
      ],
      "rows": [
        [
          "kubectl apply -f deployment.yaml",
          "创建/更新 Deployment"
        ],
        [
          "kubectl scale deploy/web --replicas=5",
          "扩缩容"
        ],
        [
          "kubectl set image deploy/web web=nginx:1.25",
          "更新镜像"
        ],
        [
          "kubectl rollout status deploy/web",
          "查看更新状态"
        ],
        [
          "kubectl rollout history deploy/web",
          "查看更新历史"
        ],
        [
          "kubectl rollout undo deploy/web",
          "回滚到上一版本"
        ],
        [
          "kubectl rollout undo deploy/web --to-revision=2",
          "回滚到指定版本"
        ]
      ]
    },
    {
      "type": "cards",
      "title": "关键配置",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "副本管理",
          "badge": "Replicas",
          "badgeColor": "blue",
          "points": [
            "replicas - 期望副本数",
            "kubectl scale 动态调整",
            "HPA 自动扩缩容"
          ]
        },
        {
          "title": "更新策略",
          "badge": "Strategy",
          "badgeColor": "green",
          "points": [
            "maxSurge - 最大超额",
            "maxUnavailable - 最大不可用",
            "minReadySeconds - 就绪等待"
          ]
        },
        {
          "title": "回滚机制",
          "badge": "Rollback",
          "badgeColor": "amber",
          "points": [
            "revisionHistoryLimit - 历史版本数",
            "rollout undo - 快速回滚",
            "自动保存 ReplicaSet"
          ]
        },
        {
          "title": "标签选择",
          "badge": "Selector",
          "badgeColor": "purple",
          "points": [
            "matchLabels - 精确匹配",
            "matchExpressions - 表达式",
            "不可变，创建后无法修改"
          ]
        }
      ]
    },
    {
      "type": "list",
      "title": "最佳实践",
      "style": "check",
      "items": [
        {
          "label": "设置资源配额",
          "description": "为所有容器配置 requests 和 limits"
        },
        {
          "label": "配置健康检查",
          "description": "确保新 Pod 就绪后才接收流量"
        },
        {
          "label": "保留更新历史",
          "description": "设置合适的 revisionHistoryLimit"
        },
        {
          "label": "使用金丝雀发布",
          "description": "配合 Service 实现流量灰度"
        },
        {
          "label": "监控更新过程",
          "description": "使用 kubectl rollout status 跟踪"
        }
      ]
    }
  ],
  "relatedTopics": [
    "ReplicaSet",
    "HPA",
    "Service"
  ]
}