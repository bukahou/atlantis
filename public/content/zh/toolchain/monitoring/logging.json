{
  "slug": "logging",
  "meta": {
    "title": "日志系统",
    "description": "日志收集、ELK Stack 与分布式追踪",
    "order": 3,
    "tags": [
      "toolchain",
      "monitoring",
      "logging",
      "elk"
    ]
  },
  "content": "<h1>日志系统</h1>\n<h2>日志系统概述</h2>\n<p>日志系统是可观测性的重要组成部分，用于记录、收集、存储和分析应用程序日志。</p>\n<pre><code>日志架构\n├── 日志生成 - 应用产生日志\n├── 日志收集 - Filebeat, Fluentd\n├── 日志传输 - Kafka, Redis\n├── 日志存储 - Elasticsearch, Loki\n├── 日志分析 - Kibana, Grafana\n└── 日志告警 - ElastAlert, Grafana\n</code></pre>\n<h2>结构化日志</h2>\n<h3>Go 日志库</h3>\n<pre><code class=\"language-go\">import \"go.uber.org/zap\"\n\n// 初始化 Logger\nfunc NewLogger() *zap.Logger {\n    config := zap.NewProductionConfig()\n    config.OutputPaths = []string{\"stdout\"}\n    config.EncoderConfig.TimeKey = \"timestamp\"\n    config.EncoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder\n\n    logger, _ := config.Build()\n    return logger\n}\n\n// 使用\nfunc main() {\n    logger := NewLogger()\n    defer logger.Sync()\n\n    logger.Info(\"Server started\",\n        zap.String(\"host\", \"localhost\"),\n        zap.Int(\"port\", 8080),\n    )\n\n    logger.Error(\"Request failed\",\n        zap.String(\"method\", \"GET\"),\n        zap.String(\"path\", \"/api/users\"),\n        zap.Int(\"status\", 500),\n        zap.Error(err),\n        zap.String(\"trace_id\", traceID),\n    )\n}\n</code></pre>\n<h3>日志格式</h3>\n<pre><code class=\"language-json\">{\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\",\n  \"level\": \"INFO\",\n  \"message\": \"HTTP request completed\",\n  \"service\": \"user-service\",\n  \"host\": \"pod-abc123\",\n  \"trace_id\": \"abc123def456\",\n  \"span_id\": \"span789\",\n  \"method\": \"GET\",\n  \"path\": \"/api/users/123\",\n  \"status\": 200,\n  \"duration_ms\": 45,\n  \"user_id\": \"user456\"\n}\n</code></pre>\n<h2>ELK Stack</h2>\n<h3>Filebeat 配置</h3>\n<pre><code class=\"language-yaml\"># filebeat.yml\nfilebeat.inputs:\n  - type: container\n    paths:\n      - '/var/lib/docker/containers/*/*.log'\n    processors:\n      - add_kubernetes_metadata:\n          host: ${NODE_NAME}\n          matchers:\n            - logs_path:\n                logs_path: \"/var/lib/docker/containers/\"\n\n  - type: log\n    paths:\n      - /var/log/app/*.log\n    json:\n      keys_under_root: true\n      add_error_key: true\n\noutput.elasticsearch:\n  hosts: [\"elasticsearch:9200\"]\n  index: \"logs-%{+yyyy.MM.dd}\"\n\noutput.kafka:\n  hosts: [\"kafka:9092\"]\n  topic: \"logs\"\n  codec.json:\n    pretty: false\n\nprocessors:\n  - add_host_metadata: ~\n  - add_cloud_metadata: ~\n</code></pre>\n<h3>Logstash 配置</h3>\n<pre><code class=\"language-ruby\"># logstash.conf\ninput {\n  kafka {\n    bootstrap_servers => \"kafka:9092\"\n    topics => [\"logs\"]\n    codec => json\n    consumer_group_id => \"logstash\"\n  }\n}\n\nfilter {\n  # 解析 JSON\n  json {\n    source => \"message\"\n  }\n\n  # 日期解析\n  date {\n    match => [\"timestamp\", \"ISO8601\"]\n    target => \"@timestamp\"\n  }\n\n  # GeoIP\n  if [client_ip] {\n    geoip {\n      source => \"client_ip\"\n    }\n  }\n\n  # 敏感信息脱敏\n  mutate {\n    gsub => [\n      \"message\", \"\\d{16}\", \"****\",\n      \"email\", \"[^@]+@\", \"***@\"\n    ]\n  }\n}\n\noutput {\n  elasticsearch {\n    hosts => [\"elasticsearch:9200\"]\n    index => \"logs-%{service}-%{+YYYY.MM.dd}\"\n  }\n}\n</code></pre>\n<h3>Elasticsearch 索引模板</h3>\n<pre><code class=\"language-json\">PUT _index_template/logs\n{\n  \"index_patterns\": [\"logs-*\"],\n  \"template\": {\n    \"settings\": {\n      \"number_of_shards\": 3,\n      \"number_of_replicas\": 1,\n      \"index.lifecycle.name\": \"logs-policy\",\n      \"index.lifecycle.rollover_alias\": \"logs\"\n    },\n    \"mappings\": {\n      \"properties\": {\n        \"@timestamp\": { \"type\": \"date\" },\n        \"level\": { \"type\": \"keyword\" },\n        \"message\": { \"type\": \"text\" },\n        \"service\": { \"type\": \"keyword\" },\n        \"trace_id\": { \"type\": \"keyword\" },\n        \"duration_ms\": { \"type\": \"integer\" },\n        \"status\": { \"type\": \"integer\" }\n      }\n    }\n  }\n}\n</code></pre>\n<h2>Loki</h2>\n<h3>Loki 配置</h3>\n<pre><code class=\"language-yaml\"># loki-config.yaml\nauth_enabled: false\n\nserver:\n  http_listen_port: 3100\n\ningester:\n  lifecycler:\n    ring:\n      kvstore:\n        store: inmemory\n      replication_factor: 1\n\nschema_config:\n  configs:\n    - from: 2020-10-24\n      store: boltdb-shipper\n      object_store: filesystem\n      schema: v11\n      index:\n        prefix: index_\n        period: 24h\n\nstorage_config:\n  boltdb_shipper:\n    active_index_directory: /loki/index\n    cache_location: /loki/cache\n  filesystem:\n    directory: /loki/chunks\n\nlimits_config:\n  enforce_metric_name: false\n  reject_old_samples: true\n  reject_old_samples_max_age: 168h\n</code></pre>\n<h3>Promtail 配置</h3>\n<pre><code class=\"language-yaml\"># promtail-config.yaml\nserver:\n  http_listen_port: 9080\n\npositions:\n  filename: /tmp/positions.yaml\n\nclients:\n  - url: http://loki:3100/loki/api/v1/push\n\nscrape_configs:\n  - job_name: kubernetes-pods\n    kubernetes_sd_configs:\n      - role: pod\n    pipeline_stages:\n      - docker: {}\n      - json:\n          expressions:\n            level: level\n            msg: message\n            trace_id: trace_id\n      - labels:\n          level:\n          trace_id:\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_label_app]\n        target_label: app\n      - source_labels: [__meta_kubernetes_namespace]\n        target_label: namespace\n</code></pre>\n<h3>LogQL 查询</h3>\n<pre><code class=\"language-logql\"># 基础查询\n{app=\"user-service\"} |= \"error\"\n\n# JSON 解析\n{app=\"user-service\"} | json | level=\"ERROR\"\n\n# 正则提取\n{app=\"nginx\"} | regexp `(?P&#x3C;method>\\w+) (?P&#x3C;path>\\S+) HTTP`\n\n# 聚合\nsum(rate({app=\"user-service\"} | json | level=\"ERROR\" [5m])) by (path)\n\n# 分位数\nquantile_over_time(0.95, {app=\"user-service\"} | json | unwrap duration_ms [5m])\n</code></pre>\n<h2>分布式追踪</h2>\n<h3>OpenTelemetry</h3>\n<pre><code class=\"language-go\">import (\n    \"go.opentelemetry.io/otel\"\n    \"go.opentelemetry.io/otel/exporters/jaeger\"\n    \"go.opentelemetry.io/otel/sdk/trace\"\n)\n\nfunc initTracer() func() {\n    exporter, _ := jaeger.New(jaeger.WithCollectorEndpoint(\n        jaeger.WithEndpoint(\"http://jaeger:14268/api/traces\"),\n    ))\n\n    tp := trace.NewTracerProvider(\n        trace.WithBatcher(exporter),\n        trace.WithResource(resource.NewWithAttributes(\n            semconv.SchemaURL,\n            semconv.ServiceNameKey.String(\"user-service\"),\n        )),\n    )\n\n    otel.SetTracerProvider(tp)\n\n    return func() {\n        tp.Shutdown(context.Background())\n    }\n}\n\n// 使用\nfunc HandleRequest(w http.ResponseWriter, r *http.Request) {\n    ctx, span := otel.Tracer(\"user-service\").Start(r.Context(), \"HandleRequest\")\n    defer span.End()\n\n    span.SetAttributes(\n        attribute.String(\"http.method\", r.Method),\n        attribute.String(\"http.url\", r.URL.String()),\n    )\n\n    // 传递 context\n    user, err := userService.GetUser(ctx, userID)\n}\n</code></pre>\n<h2>总结</h2>\n<p>日志系统要点：</p>\n<ol>\n<li><strong>结构化日志</strong> - JSON 格式，统一字段</li>\n<li><strong>日志收集</strong> - Filebeat, Promtail</li>\n<li><strong>日志存储</strong> - Elasticsearch, Loki</li>\n<li><strong>日志分析</strong> - Kibana, Grafana</li>\n<li><strong>分布式追踪</strong> - OpenTelemetry, Jaeger</li>\n</ol>\n"
}