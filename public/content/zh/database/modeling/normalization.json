{
  "slug": "normalization",
  "meta": {
    "title": "数据库范式",
    "description": "数据库范式理论、反范式设计与数据建模",
    "order": 1,
    "tags": [
      "database",
      "modeling",
      "normalization",
      "design"
    ]
  },
  "content": "<h1>数据库范式</h1>\n<h2>范式概述</h2>\n<p>数据库范式是设计关系数据库时消除冗余、保证数据完整性的指导原则。</p>\n<pre><code>范式层级\n├── 1NF - 原子性 (属性不可分)\n├── 2NF - 完全依赖 (消除部分依赖)\n├── 3NF - 消除传递依赖\n├── BCNF - 消除主属性依赖\n├── 4NF - 消除多值依赖\n└── 5NF - 消除连接依赖\n</code></pre>\n<h2>第一范式 (1NF)</h2>\n<h3>定义</h3>\n<p>每个属性都是原子的、不可再分的。</p>\n<pre><code class=\"language-sql\">-- 违反 1NF\nCREATE TABLE orders_bad (\n    id INT,\n    products VARCHAR(500)  -- \"iPhone,MacBook,AirPods\"\n);\n\n-- 符合 1NF\nCREATE TABLE orders (\n    id INT PRIMARY KEY,\n    customer_id INT\n);\n\nCREATE TABLE order_items (\n    order_id INT,\n    product_id INT,\n    quantity INT,\n    PRIMARY KEY (order_id, product_id)\n);\n</code></pre>\n<h2>第二范式 (2NF)</h2>\n<h3>定义</h3>\n<p>满足 1NF，且非主属性完全依赖于主键。</p>\n<pre><code class=\"language-sql\">-- 违反 2NF (部分依赖)\n-- 主键: (student_id, course_id)\n-- student_name 只依赖 student_id\nCREATE TABLE enrollment_bad (\n    student_id INT,\n    course_id INT,\n    student_name VARCHAR(100),  -- 部分依赖\n    grade DECIMAL(3,1),\n    PRIMARY KEY (student_id, course_id)\n);\n\n-- 符合 2NF\nCREATE TABLE students (\n    id INT PRIMARY KEY,\n    name VARCHAR(100)\n);\n\nCREATE TABLE enrollments (\n    student_id INT,\n    course_id INT,\n    grade DECIMAL(3,1),\n    PRIMARY KEY (student_id, course_id),\n    FOREIGN KEY (student_id) REFERENCES students(id)\n);\n</code></pre>\n<h2>第三范式 (3NF)</h2>\n<h3>定义</h3>\n<p>满足 2NF，且非主属性不传递依赖于主键。</p>\n<pre><code class=\"language-sql\">-- 违反 3NF (传递依赖)\n-- department_name 依赖 department_id，而非直接依赖 id\nCREATE TABLE employees_bad (\n    id INT PRIMARY KEY,\n    name VARCHAR(100),\n    department_id INT,\n    department_name VARCHAR(100)  -- 传递依赖\n);\n\n-- 符合 3NF\nCREATE TABLE departments (\n    id INT PRIMARY KEY,\n    name VARCHAR(100)\n);\n\nCREATE TABLE employees (\n    id INT PRIMARY KEY,\n    name VARCHAR(100),\n    department_id INT,\n    FOREIGN KEY (department_id) REFERENCES departments(id)\n);\n</code></pre>\n<h2>BCNF (巴斯-科德范式)</h2>\n<h3>定义</h3>\n<p>满足 3NF，且每个决定因素都是候选键。</p>\n<pre><code class=\"language-sql\">-- 违反 BCNF\n-- 假设: 一个学生只能选一个导师的课\n-- 导师只教一门课\nCREATE TABLE student_course_bad (\n    student_id INT,\n    course_id INT,\n    teacher_id INT,\n    PRIMARY KEY (student_id, course_id)\n    -- teacher_id -> course_id，但 teacher_id 不是候选键\n);\n\n-- 符合 BCNF\nCREATE TABLE teacher_courses (\n    teacher_id INT PRIMARY KEY,\n    course_id INT\n);\n\nCREATE TABLE student_teachers (\n    student_id INT,\n    teacher_id INT,\n    PRIMARY KEY (student_id, teacher_id)\n);\n</code></pre>\n<h2>反范式设计</h2>\n<h3>何时反范式</h3>\n<pre><code>适用场景\n├── 读多写少 - 减少 JOIN\n├── 报表查询 - 预聚合数据\n├── 高性能要求 - 空间换时间\n└── 数据仓库 - 星型/雪花模型\n</code></pre>\n<h3>反范式技术</h3>\n<pre><code class=\"language-sql\">-- 1. 冗余字段\nCREATE TABLE orders (\n    id INT PRIMARY KEY,\n    user_id INT,\n    user_name VARCHAR(100),  -- 冗余，避免 JOIN\n    total_amount DECIMAL(10,2)\n);\n\n-- 2. 预计算字段\nCREATE TABLE products (\n    id INT PRIMARY KEY,\n    name VARCHAR(100),\n    price DECIMAL(10,2),\n    review_count INT DEFAULT 0,  -- 预计算\n    avg_rating DECIMAL(2,1) DEFAULT 0\n);\n\n-- 3. 汇总表\nCREATE TABLE daily_sales (\n    date DATE PRIMARY KEY,\n    total_orders INT,\n    total_revenue DECIMAL(12,2),\n    avg_order_value DECIMAL(10,2)\n);\n</code></pre>\n<h2>数据建模实践</h2>\n<h3>实体关系设计</h3>\n<pre><code class=\"language-sql\">-- 一对多\nCREATE TABLE categories (\n    id INT PRIMARY KEY,\n    name VARCHAR(100)\n);\n\nCREATE TABLE products (\n    id INT PRIMARY KEY,\n    name VARCHAR(100),\n    category_id INT,\n    FOREIGN KEY (category_id) REFERENCES categories(id)\n);\n\n-- 多对多\nCREATE TABLE tags (\n    id INT PRIMARY KEY,\n    name VARCHAR(50)\n);\n\nCREATE TABLE product_tags (\n    product_id INT,\n    tag_id INT,\n    PRIMARY KEY (product_id, tag_id),\n    FOREIGN KEY (product_id) REFERENCES products(id),\n    FOREIGN KEY (tag_id) REFERENCES tags(id)\n);\n\n-- 自关联\nCREATE TABLE employees (\n    id INT PRIMARY KEY,\n    name VARCHAR(100),\n    manager_id INT,\n    FOREIGN KEY (manager_id) REFERENCES employees(id)\n);\n</code></pre>\n<h3>继承模式</h3>\n<pre><code class=\"language-sql\">-- 单表继承\nCREATE TABLE vehicles (\n    id INT PRIMARY KEY,\n    type ENUM('car', 'motorcycle', 'truck'),\n    brand VARCHAR(50),\n    -- Car 字段\n    num_doors INT,\n    -- Motorcycle 字段\n    engine_cc INT,\n    -- Truck 字段\n    payload_capacity DECIMAL(10,2)\n);\n\n-- 类表继承\nCREATE TABLE vehicles (\n    id INT PRIMARY KEY,\n    brand VARCHAR(50)\n);\n\nCREATE TABLE cars (\n    vehicle_id INT PRIMARY KEY,\n    num_doors INT,\n    FOREIGN KEY (vehicle_id) REFERENCES vehicles(id)\n);\n\nCREATE TABLE motorcycles (\n    vehicle_id INT PRIMARY KEY,\n    engine_cc INT,\n    FOREIGN KEY (vehicle_id) REFERENCES vehicles(id)\n);\n\n-- 具体表继承\nCREATE TABLE cars (\n    id INT PRIMARY KEY,\n    brand VARCHAR(50),\n    num_doors INT\n);\n\nCREATE TABLE motorcycles (\n    id INT PRIMARY KEY,\n    brand VARCHAR(50),\n    engine_cc INT\n);\n</code></pre>\n<h2>设计原则</h2>\n<pre><code class=\"language-yaml\">规范化优先:\n  - 从高范式开始\n  - 根据性能需求适当反范式\n  - 记录反范式决策理由\n\n命名规范:\n  - 表名: 复数形式 (users, orders)\n  - 主键: id 或 table_id\n  - 外键: referenced_table_id\n  - 时间戳: created_at, updated_at\n\n约束使用:\n  - 主键约束\n  - 外键约束 (考虑性能影响)\n  - 唯一约束\n  - 检查约束\n</code></pre>\n<h2>总结</h2>\n<p>数据库范式要点：</p>\n<ol>\n<li><strong>1NF</strong> - 原子性，属性不可分</li>\n<li><strong>2NF</strong> - 消除部分依赖</li>\n<li><strong>3NF</strong> - 消除传递依赖</li>\n<li><strong>反范式</strong> - 性能优化，适当冗余</li>\n<li><strong>实践</strong> - 平衡规范化与性能</li>\n</ol>\n"
}