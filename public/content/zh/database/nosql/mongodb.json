{
  "slug": "mongodb",
  "meta": {
    "title": "MongoDB",
    "description": "MongoDB 文档数据库、查询操作与聚合管道",
    "order": 1,
    "tags": [
      "database",
      "mongodb",
      "nosql",
      "document"
    ]
  },
  "content": "<h1>MongoDB</h1>\n<h2>MongoDB 概述</h2>\n<p>MongoDB 是面向文档的 NoSQL 数据库，以灵活的模式和强大的查询能力著称。</p>\n<pre><code>MongoDB 特性\n├── 文档模型 - BSON 格式\n├── 灵活模式 - 无固定 Schema\n├── 高性能 - 内存映射\n├── 水平扩展 - 分片集群\n├── 丰富查询 - 聚合框架\n└── 高可用 - 副本集\n</code></pre>\n<h2>基础操作</h2>\n<h3>CRUD 操作</h3>\n<pre><code class=\"language-javascript\">// 插入文档\ndb.users.insertOne({\n  name: \"Alice\",\n  email: \"alice@example.com\",\n  age: 28,\n  tags: [\"developer\", \"golang\"],\n  profile: {\n    city: \"Tokyo\",\n    country: \"Japan\"\n  }\n});\n\n// 批量插入\ndb.users.insertMany([\n  { name: \"Bob\", age: 30 },\n  { name: \"Charlie\", age: 25 }\n]);\n\n// 查询\ndb.users.find({ age: { $gt: 25 } });\ndb.users.findOne({ email: \"alice@example.com\" });\n\n// 更新\ndb.users.updateOne(\n  { email: \"alice@example.com\" },\n  { $set: { age: 29 }, $push: { tags: \"kubernetes\" } }\n);\n\n// 删除\ndb.users.deleteOne({ email: \"alice@example.com\" });\ndb.users.deleteMany({ age: { $lt: 20 } });\n</code></pre>\n<h3>查询操作符</h3>\n<pre><code class=\"language-javascript\">// 比较操作符\n{ age: { $eq: 25 } }   // 等于\n{ age: { $ne: 25 } }   // 不等于\n{ age: { $gt: 25 } }   // 大于\n{ age: { $gte: 25 } }  // 大于等于\n{ age: { $lt: 25 } }   // 小于\n{ age: { $lte: 25 } }  // 小于等于\n{ age: { $in: [25, 30] } }  // 在列表中\n\n// 逻辑操作符\n{ $and: [{ age: { $gt: 20 } }, { age: { $lt: 30 } }] }\n{ $or: [{ status: \"active\" }, { role: \"admin\" }] }\n{ $not: { age: { $gt: 25 } } }\n\n// 元素操作符\n{ tags: { $exists: true } }\n{ age: { $type: \"int\" } }\n\n// 数组操作符\n{ tags: { $all: [\"developer\", \"golang\"] } }\n{ tags: { $size: 3 } }\n{ tags: { $elemMatch: { $eq: \"golang\" } } }\n</code></pre>\n<h2>索引</h2>\n<h3>索引类型</h3>\n<pre><code class=\"language-javascript\">// 单字段索引\ndb.users.createIndex({ email: 1 });\n\n// 复合索引\ndb.users.createIndex({ name: 1, age: -1 });\n\n// 唯一索引\ndb.users.createIndex({ email: 1 }, { unique: true });\n\n// 文本索引\ndb.articles.createIndex({ title: \"text\", content: \"text\" });\n\n// 地理空间索引\ndb.places.createIndex({ location: \"2dsphere\" });\n\n// TTL 索引 (自动过期)\ndb.sessions.createIndex({ createdAt: 1 }, { expireAfterSeconds: 3600 });\n\n// 稀疏索引\ndb.users.createIndex({ nickname: 1 }, { sparse: true });\n</code></pre>\n<h3>查询分析</h3>\n<pre><code class=\"language-javascript\">// 执行计划\ndb.users.find({ email: \"test@example.com\" }).explain(\"executionStats\");\n\n// 索引统计\ndb.users.aggregate([{ $indexStats: {} }]);\n</code></pre>\n<h2>聚合管道</h2>\n<h3>管道阶段</h3>\n<pre><code class=\"language-javascript\">// 聚合示例\ndb.orders.aggregate([\n  // 匹配\n  { $match: { status: \"completed\" } },\n\n  // 分组\n  { $group: {\n      _id: \"$userId\",\n      totalAmount: { $sum: \"$amount\" },\n      orderCount: { $sum: 1 },\n      avgAmount: { $avg: \"$amount\" }\n  }},\n\n  // 排序\n  { $sort: { totalAmount: -1 } },\n\n  // 限制\n  { $limit: 10 },\n\n  // 投影\n  { $project: {\n      userId: \"$_id\",\n      totalAmount: 1,\n      orderCount: 1,\n      _id: 0\n  }}\n]);\n</code></pre>\n<h3>高级聚合</h3>\n<pre><code class=\"language-javascript\">// Lookup 关联\ndb.orders.aggregate([\n  { $lookup: {\n      from: \"users\",\n      localField: \"userId\",\n      foreignField: \"_id\",\n      as: \"user\"\n  }},\n  { $unwind: \"$user\" }\n]);\n\n// 窗口函数\ndb.sales.aggregate([\n  { $setWindowFields: {\n      partitionBy: \"$region\",\n      sortBy: { date: 1 },\n      output: {\n        runningTotal: {\n          $sum: \"$amount\",\n          window: { documents: [\"unbounded\", \"current\"] }\n        }\n      }\n  }}\n]);\n\n// 分面搜索\ndb.products.aggregate([\n  { $facet: {\n      byCategory: [{ $group: { _id: \"$category\", count: { $sum: 1 } }}],\n      byPrice: [{ $bucket: { groupBy: \"$price\", boundaries: [0, 100, 500, 1000] }}],\n      total: [{ $count: \"count\" }]\n  }}\n]);\n</code></pre>\n<h2>Go 客户端</h2>\n<pre><code class=\"language-go\">import \"go.mongodb.org/mongo-driver/mongo\"\n\n// 连接\nclient, _ := mongo.Connect(ctx, options.Client().ApplyURI(\"mongodb://localhost:27017\"))\ncollection := client.Database(\"mydb\").Collection(\"users\")\n\n// 插入\nresult, _ := collection.InsertOne(ctx, bson.M{\n    \"name\": \"Alice\",\n    \"age\":  28,\n})\n\n// 查询\nvar user User\ncollection.FindOne(ctx, bson.M{\"name\": \"Alice\"}).Decode(&#x26;user)\n\n// 查询多个\ncursor, _ := collection.Find(ctx, bson.M{\"age\": bson.M{\"$gt\": 25}})\nvar users []User\ncursor.All(ctx, &#x26;users)\n\n// 更新\ncollection.UpdateOne(ctx,\n    bson.M{\"name\": \"Alice\"},\n    bson.M{\"$set\": bson.M{\"age\": 29}},\n)\n\n// 聚合\npipeline := mongo.Pipeline{\n    {{\"$match\", bson.M{\"status\": \"active\"}}},\n    {{\"$group\", bson.M{\"_id\": \"$category\", \"count\": bson.M{\"$sum\": 1}}}},\n}\ncursor, _ := collection.Aggregate(ctx, pipeline)\n</code></pre>\n<h2>副本集与分片</h2>\n<h3>副本集</h3>\n<pre><code class=\"language-yaml\"># 副本集配置\n副本集成员:\n  - Primary: 主节点，处理写入\n  - Secondary: 从节点，数据复制\n  - Arbiter: 仲裁节点，不存数据\n\n读取偏好:\n  - primary: 只读主节点\n  - primaryPreferred: 优先主节点\n  - secondary: 只读从节点\n  - secondaryPreferred: 优先从节点\n  - nearest: 最近节点\n</code></pre>\n<h3>分片</h3>\n<pre><code class=\"language-yaml\"># 分片集群组件\n├── mongos: 路由服务\n├── config server: 配置服务\n└── shard: 数据分片\n\n# 分片键策略\n├── 范围分片: 按范围划分\n├── 哈希分片: 均匀分布\n└── 区域分片: 按地理位置\n</code></pre>\n<h2>总结</h2>\n<p>MongoDB 要点：</p>\n<ol>\n<li><strong>文档模型</strong> - 灵活 Schema，BSON 格式</li>\n<li><strong>查询</strong> - 丰富操作符，聚合管道</li>\n<li><strong>索引</strong> - 多种索引类型，TTL 支持</li>\n<li><strong>扩展</strong> - 副本集高可用，分片水平扩展</li>\n<li><strong>性能</strong> - 内存映射，读写分离</li>\n</ol>\n"
}