{
  "slug": "elasticsearch",
  "meta": {
    "title": "Elasticsearch",
    "description": "Elasticsearch 全文搜索引擎、索引与查询 DSL",
    "order": 3,
    "tags": [
      "database",
      "elasticsearch",
      "nosql",
      "search"
    ]
  },
  "content": "<h1>Elasticsearch</h1>\n<h2>Elasticsearch 概述</h2>\n<p>Elasticsearch 是分布式搜索和分析引擎，基于 Lucene 构建，支持全文搜索、结构化搜索和分析。</p>\n<pre><code>Elasticsearch 特性\n├── 分布式 - 自动分片和副本\n├── 近实时 - 秒级搜索延迟\n├── RESTful API - JSON 交互\n├── 全文搜索 - 倒排索引\n├── 聚合分析 - 多维度统计\n└── 高可用 - 节点故障自动恢复\n</code></pre>\n<h2>核心概念</h2>\n<pre><code>概念映射\n├── Index - 索引 (类似数据库)\n├── Document - 文档 (类似行)\n├── Field - 字段 (类似列)\n├── Mapping - 映射 (类似 Schema)\n├── Shard - 分片 (数据分布)\n└── Replica - 副本 (高可用)\n</code></pre>\n<h2>索引操作</h2>\n<h3>创建索引</h3>\n<pre><code class=\"language-json\">// 创建索引\nPUT /products\n{\n  \"settings\": {\n    \"number_of_shards\": 3,\n    \"number_of_replicas\": 1,\n    \"analysis\": {\n      \"analyzer\": {\n        \"my_analyzer\": {\n          \"type\": \"custom\",\n          \"tokenizer\": \"standard\",\n          \"filter\": [\"lowercase\", \"porter_stem\"]\n        }\n      }\n    }\n  },\n  \"mappings\": {\n    \"properties\": {\n      \"name\": {\n        \"type\": \"text\",\n        \"analyzer\": \"my_analyzer\"\n      },\n      \"price\": {\n        \"type\": \"float\"\n      },\n      \"category\": {\n        \"type\": \"keyword\"\n      },\n      \"description\": {\n        \"type\": \"text\"\n      },\n      \"created_at\": {\n        \"type\": \"date\"\n      },\n      \"tags\": {\n        \"type\": \"keyword\"\n      }\n    }\n  }\n}\n</code></pre>\n<h3>文档操作</h3>\n<pre><code class=\"language-json\">// 创建文档\nPOST /products/_doc\n{\n  \"name\": \"iPhone 15\",\n  \"price\": 999.99,\n  \"category\": \"electronics\",\n  \"description\": \"Apple's latest smartphone\",\n  \"tags\": [\"phone\", \"apple\", \"5g\"]\n}\n\n// 指定 ID\nPUT /products/_doc/1\n{\n  \"name\": \"MacBook Pro\",\n  \"price\": 1999.99,\n  \"category\": \"electronics\"\n}\n\n// 更新文档\nPOST /products/_update/1\n{\n  \"doc\": {\n    \"price\": 1899.99\n  }\n}\n\n// 删除文档\nDELETE /products/_doc/1\n\n// 批量操作\nPOST /_bulk\n{\"index\": {\"_index\": \"products\", \"_id\": \"1\"}}\n{\"name\": \"Product 1\", \"price\": 100}\n{\"index\": {\"_index\": \"products\", \"_id\": \"2\"}}\n{\"name\": \"Product 2\", \"price\": 200}\n</code></pre>\n<h2>查询 DSL</h2>\n<h3>基础查询</h3>\n<pre><code class=\"language-json\">// Match 查询\nGET /products/_search\n{\n  \"query\": {\n    \"match\": {\n      \"name\": \"iphone\"\n    }\n  }\n}\n\n// Term 查询 (精确匹配)\nGET /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"category\": \"electronics\"\n    }\n  }\n}\n\n// Range 查询\nGET /products/_search\n{\n  \"query\": {\n    \"range\": {\n      \"price\": {\n        \"gte\": 100,\n        \"lte\": 500\n      }\n    }\n  }\n}\n\n// Bool 查询\nGET /products/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        { \"match\": { \"name\": \"phone\" } }\n      ],\n      \"filter\": [\n        { \"term\": { \"category\": \"electronics\" } },\n        { \"range\": { \"price\": { \"lte\": 1000 } } }\n      ],\n      \"should\": [\n        { \"term\": { \"tags\": \"5g\" } }\n      ],\n      \"must_not\": [\n        { \"term\": { \"category\": \"refurbished\" } }\n      ]\n    }\n  }\n}\n</code></pre>\n<h3>全文搜索</h3>\n<pre><code class=\"language-json\">// Multi-match\nGET /products/_search\n{\n  \"query\": {\n    \"multi_match\": {\n      \"query\": \"apple phone\",\n      \"fields\": [\"name^2\", \"description\"],\n      \"type\": \"best_fields\"\n    }\n  }\n}\n\n// Match Phrase\nGET /products/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"description\": \"latest smartphone\"\n    }\n  }\n}\n\n// Fuzzy 查询\nGET /products/_search\n{\n  \"query\": {\n    \"fuzzy\": {\n      \"name\": {\n        \"value\": \"iphon\",\n        \"fuzziness\": \"AUTO\"\n      }\n    }\n  }\n}\n\n// 高亮\nGET /products/_search\n{\n  \"query\": {\n    \"match\": { \"description\": \"smartphone\" }\n  },\n  \"highlight\": {\n    \"fields\": {\n      \"description\": {}\n    }\n  }\n}\n</code></pre>\n<h2>聚合分析</h2>\n<h3>桶聚合</h3>\n<pre><code class=\"language-json\">// Terms 聚合\nGET /products/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"categories\": {\n      \"terms\": {\n        \"field\": \"category\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\n// 范围聚合\nGET /products/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"price_ranges\": {\n      \"range\": {\n        \"field\": \"price\",\n        \"ranges\": [\n          { \"to\": 100 },\n          { \"from\": 100, \"to\": 500 },\n          { \"from\": 500 }\n        ]\n      }\n    }\n  }\n}\n\n// 日期直方图\nGET /orders/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"orders_over_time\": {\n      \"date_histogram\": {\n        \"field\": \"created_at\",\n        \"calendar_interval\": \"month\"\n      }\n    }\n  }\n}\n</code></pre>\n<h3>指标聚合</h3>\n<pre><code class=\"language-json\">// 统计聚合\nGET /products/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"price_stats\": {\n      \"stats\": {\n        \"field\": \"price\"\n      }\n    }\n  }\n}\n\n// 嵌套聚合\nGET /orders/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"by_category\": {\n      \"terms\": {\n        \"field\": \"category\"\n      },\n      \"aggs\": {\n        \"avg_price\": {\n          \"avg\": { \"field\": \"price\" }\n        },\n        \"total_sales\": {\n          \"sum\": { \"field\": \"amount\" }\n        }\n      }\n    }\n  }\n}\n</code></pre>\n<h2>Go 客户端</h2>\n<pre><code class=\"language-go\">import \"github.com/elastic/go-elasticsearch/v8\"\n\n// 连接\nes, _ := elasticsearch.NewClient(elasticsearch.Config{\n    Addresses: []string{\"http://localhost:9200\"},\n})\n\n// 索引文档\ndoc := map[string]interface{}{\n    \"name\":  \"Product\",\n    \"price\": 99.99,\n}\nbody, _ := json.Marshal(doc)\nes.Index(\"products\", bytes.NewReader(body))\n\n// 搜索\nquery := map[string]interface{}{\n    \"query\": map[string]interface{}{\n        \"match\": map[string]interface{}{\n            \"name\": \"product\",\n        },\n    },\n}\nbody, _ := json.Marshal(query)\nres, _ := es.Search(\n    es.Search.WithIndex(\"products\"),\n    es.Search.WithBody(bytes.NewReader(body)),\n)\n</code></pre>\n<h2>性能优化</h2>\n<pre><code class=\"language-yaml\"># 索引优化\n├── 合理分片数 - 单分片 10-50GB\n├── 批量索引 - bulk API\n├── 刷新间隔 - refresh_interval\n└── 副本设置 - 读写比例\n\n# 查询优化\n├── 使用 filter - 可缓存\n├── 避免深分页 - search_after\n├── 限制返回字段 - _source\n└── 预热缓存 - warmer\n</code></pre>\n<h2>总结</h2>\n<p>Elasticsearch 要点：</p>\n<ol>\n<li><strong>索引设计</strong> - Mapping、分片、副本</li>\n<li><strong>查询 DSL</strong> - Match、Bool、Range</li>\n<li><strong>全文搜索</strong> - 分词、高亮、模糊</li>\n<li><strong>聚合</strong> - 桶聚合、指标聚合</li>\n<li><strong>性能</strong> - 批量操作、Filter 缓存</li>\n</ol>\n"
}