{
  "slug": "pinia",
  "meta": {
    "title": "Pinia 状态管理",
    "description": "Vue 官方状态管理库 Pinia 核心用法与最佳实践",
    "order": 2,
    "tags": [
      "vue",
      "pinia",
      "state",
      "store"
    ]
  },
  "content": "<h1>Pinia 状态管理</h1>\n<h2>Pinia 概述</h2>\n<p>Pinia 是 Vue 官方推荐的状态管理库，提供直观的 API 和完整的 TypeScript 支持。</p>\n<pre><code>Pinia 特点\n├── 简洁 API - 类似组合式 API\n├── TypeScript 支持 - 完整类型推断\n├── 模块化 - 无嵌套模块\n├── 开发者工具 - Vue DevTools 集成\n└── 轻量 - 约 1KB gzip\n</code></pre>\n<h2>安装与配置</h2>\n<pre><code class=\"language-typescript\">// main.ts\nimport { createApp } from \"vue\";\nimport { createPinia } from \"pinia\";\nimport App from \"./App.vue\";\n\nconst app = createApp(App);\nconst pinia = createPinia();\n\napp.use(pinia);\napp.mount(\"#app\");\n</code></pre>\n<h2>定义 Store</h2>\n<h3>Options API 风格</h3>\n<pre><code class=\"language-typescript\">// stores/counter.ts\nimport { defineStore } from \"pinia\";\n\nexport const useCounterStore = defineStore(\"counter\", {\n  state: () => ({\n    count: 0,\n    name: \"Counter\",\n  }),\n\n  getters: {\n    doubleCount: (state) => state.count * 2,\n    // 使用 this 访问其他 getter\n    doubleCountPlusOne(): number {\n      return this.doubleCount + 1;\n    },\n  },\n\n  actions: {\n    increment() {\n      this.count++;\n    },\n    async fetchData() {\n      const data = await api.getData();\n      this.count = data.count;\n    },\n  },\n});\n</code></pre>\n<h3>Composition API 风格</h3>\n<pre><code class=\"language-typescript\">// stores/user.ts\nimport { defineStore } from \"pinia\";\nimport { ref, computed } from \"vue\";\n\nexport const useUserStore = defineStore(\"user\", () => {\n  // state\n  const user = ref&#x3C;User | null>(null);\n  const isLoading = ref(false);\n\n  // getters\n  const isLoggedIn = computed(() => !!user.value);\n  const userName = computed(() => user.value?.name ?? \"Guest\");\n\n  // actions\n  async function login(credentials: Credentials) {\n    isLoading.value = true;\n    try {\n      user.value = await api.login(credentials);\n    } finally {\n      isLoading.value = false;\n    }\n  }\n\n  function logout() {\n    user.value = null;\n  }\n\n  return {\n    user,\n    isLoading,\n    isLoggedIn,\n    userName,\n    login,\n    logout,\n  };\n});\n</code></pre>\n<h2>使用 Store</h2>\n<h3>在组件中使用</h3>\n<pre><code class=\"language-vue\">&#x3C;script setup lang=\"ts\">\nimport { useCounterStore } from \"@/stores/counter\";\nimport { storeToRefs } from \"pinia\";\n\nconst counterStore = useCounterStore();\n\n// 直接访问\nconsole.log(counterStore.count);\nconsole.log(counterStore.doubleCount);\n\n// 解构需要 storeToRefs 保持响应性\nconst { count, doubleCount } = storeToRefs(counterStore);\n\n// actions 可以直接解构\nconst { increment } = counterStore;\n&#x3C;/script>\n\n&#x3C;template>\n  &#x3C;div>\n    &#x3C;p>Count: {{ count }}&#x3C;/p>\n    &#x3C;p>Double: {{ doubleCount }}&#x3C;/p>\n    &#x3C;button @click=\"increment\">+1&#x3C;/button>\n    &#x3C;button @click=\"counterStore.count++\">+1 直接修改&#x3C;/button>\n  &#x3C;/div>\n&#x3C;/template>\n</code></pre>\n<h3>修改状态</h3>\n<pre><code class=\"language-typescript\">const store = useCounterStore();\n\n// 直接修改\nstore.count++;\n\n// $patch - 批量修改\nstore.$patch({\n  count: store.count + 1,\n  name: \"New Name\",\n});\n\n// $patch 函数式\nstore.$patch((state) => {\n  state.count++;\n  state.items.push({ id: 1, name: \"item\" });\n});\n\n// 替换整个 state\nstore.$state = { count: 0, name: \"Reset\" };\n\n// 重置状态\nstore.$reset();\n</code></pre>\n<h2>订阅变化</h2>\n<pre><code class=\"language-typescript\">const store = useCounterStore();\n\n// 订阅状态变化\nstore.$subscribe((mutation, state) => {\n  console.log(\"Type:\", mutation.type);\n  console.log(\"Store ID:\", mutation.storeId);\n  console.log(\"State:\", state);\n});\n\n// 订阅 action\nstore.$onAction(({ name, store, args, after, onError }) => {\n  console.log(`Action ${name} called with`, args);\n\n  after((result) => {\n    console.log(\"Action completed with result:\", result);\n  });\n\n  onError((error) => {\n    console.error(\"Action failed:\", error);\n  });\n});\n</code></pre>\n<h2>Store 之间交互</h2>\n<pre><code class=\"language-typescript\">// stores/cart.ts\nimport { defineStore } from \"pinia\";\nimport { useUserStore } from \"./user\";\n\nexport const useCartStore = defineStore(\"cart\", () => {\n  const items = ref&#x3C;CartItem[]>([]);\n\n  // 使用其他 store\n  const userStore = useUserStore();\n\n  const canCheckout = computed(() => {\n    return userStore.isLoggedIn &#x26;&#x26; items.value.length > 0;\n  });\n\n  async function checkout() {\n    if (!userStore.isLoggedIn) {\n      throw new Error(\"Please login first\");\n    }\n    // 结账逻辑\n  }\n\n  return { items, canCheckout, checkout };\n});\n</code></pre>\n<h2>插件</h2>\n<h3>持久化插件</h3>\n<pre><code class=\"language-typescript\">// plugins/persistedState.ts\nimport { PiniaPluginContext } from \"pinia\";\n\nexport function persistedState({ store }: PiniaPluginContext) {\n  // 从 localStorage 恢复\n  const storedState = localStorage.getItem(store.$id);\n  if (storedState) {\n    store.$patch(JSON.parse(storedState));\n  }\n\n  // 订阅变化并保存\n  store.$subscribe((mutation, state) => {\n    localStorage.setItem(store.$id, JSON.stringify(state));\n  });\n}\n\n// main.ts\nconst pinia = createPinia();\npinia.use(persistedState);\n</code></pre>\n<h3>添加属性</h3>\n<pre><code class=\"language-typescript\">// 为所有 store 添加属性\npinia.use(({ store }) => {\n  store.$router = markRaw(router);\n});\n\n// 类型声明\ndeclare module \"pinia\" {\n  export interface PiniaCustomProperties {\n    $router: Router;\n  }\n}\n</code></pre>\n<h2>测试</h2>\n<pre><code class=\"language-typescript\">import { setActivePinia, createPinia } from \"pinia\";\nimport { useCounterStore } from \"@/stores/counter\";\nimport { describe, it, expect, beforeEach } from \"vitest\";\n\ndescribe(\"Counter Store\", () => {\n  beforeEach(() => {\n    setActivePinia(createPinia());\n  });\n\n  it(\"increments count\", () => {\n    const store = useCounterStore();\n    expect(store.count).toBe(0);\n\n    store.increment();\n    expect(store.count).toBe(1);\n  });\n\n  it(\"computes double count\", () => {\n    const store = useCounterStore();\n    store.count = 5;\n    expect(store.doubleCount).toBe(10);\n  });\n});\n</code></pre>\n<h2>最佳实践</h2>\n<pre><code class=\"language-typescript\">// stores/types.ts\nexport interface User {\n  id: string;\n  name: string;\n  email: string;\n}\n\n// stores/user.ts\nimport { defineStore } from \"pinia\";\nimport { ref, computed } from \"vue\";\nimport type { User } from \"./types\";\n\nexport const useUserStore = defineStore(\"user\", () => {\n  // 1. State\n  const user = ref&#x3C;User | null>(null);\n  const token = ref&#x3C;string | null>(null);\n  const isLoading = ref(false);\n  const error = ref&#x3C;string | null>(null);\n\n  // 2. Getters\n  const isAuthenticated = computed(() => !!token.value);\n\n  // 3. Actions - 处理异步和业务逻辑\n  async function fetchUser() {\n    if (!token.value) return;\n\n    isLoading.value = true;\n    error.value = null;\n\n    try {\n      user.value = await api.getUser();\n    } catch (e) {\n      error.value = e instanceof Error ? e.message : \"Unknown error\";\n    } finally {\n      isLoading.value = false;\n    }\n  }\n\n  // 4. 清理函数\n  function $reset() {\n    user.value = null;\n    token.value = null;\n    error.value = null;\n  }\n\n  return {\n    // State\n    user,\n    token,\n    isLoading,\n    error,\n    // Getters\n    isAuthenticated,\n    // Actions\n    fetchUser,\n    $reset,\n  };\n});\n</code></pre>\n<h2>总结</h2>\n<p>Pinia 状态管理要点：</p>\n<ol>\n<li><strong>简洁 API</strong> - defineStore 定义，组合式或选项式</li>\n<li><strong>响应式</strong> - state、getters 自动响应</li>\n<li><strong>TypeScript</strong> - 完整类型推断</li>\n<li><strong>模块化</strong> - 独立 store，按需导入</li>\n<li><strong>插件系统</strong> - 持久化、日志等扩展</li>\n</ol>\n"
}