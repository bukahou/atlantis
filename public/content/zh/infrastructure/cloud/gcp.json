{
  "slug": "gcp",
  "meta": {
    "title": "GCP 云服务基础",
    "description": "Google Cloud Platform 核心服务介绍与实践指南",
    "order": 2,
    "tags": [
      "gcp",
      "cloud",
      "compute-engine",
      "gcs"
    ]
  },
  "content": "<h1>GCP 云服务基础</h1>\n<h2>GCP 简介</h2>\n<p>Google Cloud Platform (GCP) 是 Google 提供的云计算平台，以其强大的数据分析、机器学习能力和全球网络基础设施著称。</p>\n<pre><code>GCP 全球基础设施\n├── Regions (区域) - 40+\n│   └── Zones (可用区) - 121+\n├── Edge PoPs - 200+\n└── CDN Nodes - 全球分布\n</code></pre>\n<h2>核心计算服务</h2>\n<h3>Compute Engine (虚拟机)</h3>\n<p>Compute Engine 提供可自定义的虚拟机实例。</p>\n<h4>机器类型</h4>\n<table>\n<thead>\n<tr>\n<th>系列</th>\n<th>用途</th>\n<th>特点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>E2</strong></td>\n<td>通用工作负载</td>\n<td>成本优化</td>\n</tr>\n<tr>\n<td><strong>N2/N2D</strong></td>\n<td>平衡型</td>\n<td>高性能</td>\n</tr>\n<tr>\n<td><strong>C2/C2D</strong></td>\n<td>计算密集型</td>\n<td>最高单核性能</td>\n</tr>\n<tr>\n<td><strong>M2/M3</strong></td>\n<td>内存密集型</td>\n<td>最高12TB内存</td>\n</tr>\n<tr>\n<td><strong>A2/G2</strong></td>\n<td>GPU 加速</td>\n<td>ML/AI 工作负载</td>\n</tr>\n</tbody>\n</table>\n<h4>创建 VM 实例</h4>\n<pre><code class=\"language-bash\"># 使用 gcloud 创建实例\ngcloud compute instances create my-instance \\\n  --zone=asia-northeast1-a \\\n  --machine-type=e2-medium \\\n  --image-family=debian-12 \\\n  --image-project=debian-cloud \\\n  --boot-disk-size=20GB \\\n  --tags=http-server,https-server\n\n# 带 GPU 的实例\ngcloud compute instances create gpu-instance \\\n  --zone=asia-northeast1-a \\\n  --machine-type=n1-standard-4 \\\n  --accelerator=type=nvidia-tesla-t4,count=1 \\\n  --image-family=debian-12 \\\n  --image-project=debian-cloud \\\n  --maintenance-policy=TERMINATE\n</code></pre>\n<h4>实例组和自动扩缩</h4>\n<pre><code class=\"language-bash\"># 创建实例模板\ngcloud compute instance-templates create my-template \\\n  --machine-type=e2-medium \\\n  --image-family=debian-12 \\\n  --image-project=debian-cloud\n\n# 创建托管实例组\ngcloud compute instance-groups managed create my-group \\\n  --base-instance-name=my-vm \\\n  --template=my-template \\\n  --size=3 \\\n  --zone=asia-northeast1-a\n\n# 配置自动扩缩\ngcloud compute instance-groups managed set-autoscaling my-group \\\n  --zone=asia-northeast1-a \\\n  --min-num-replicas=2 \\\n  --max-num-replicas=10 \\\n  --target-cpu-utilization=0.7\n</code></pre>\n<h3>Cloud Functions (无服务器)</h3>\n<pre><code class=\"language-python\"># main.py - Cloud Functions 示例\nimport functions_framework\n\n@functions_framework.http\ndef hello_http(request):\n    name = request.args.get('name', 'World')\n    return f'Hello, {name}!'\n\n@functions_framework.cloud_event\ndef hello_pubsub(cloud_event):\n    import base64\n    data = base64.b64decode(cloud_event.data[\"message\"][\"data\"])\n    print(f\"Received message: {data}\")\n</code></pre>\n<pre><code class=\"language-bash\"># 部署 HTTP 函数\ngcloud functions deploy hello-http \\\n  --gen2 \\\n  --runtime=python311 \\\n  --trigger-http \\\n  --allow-unauthenticated \\\n  --region=asia-northeast1\n\n# 部署 Pub/Sub 触发函数\ngcloud functions deploy hello-pubsub \\\n  --gen2 \\\n  --runtime=python311 \\\n  --trigger-topic=my-topic \\\n  --region=asia-northeast1\n</code></pre>\n<h3>Cloud Run (容器化无服务器)</h3>\n<pre><code class=\"language-bash\"># 部署容器到 Cloud Run\ngcloud run deploy my-service \\\n  --image=gcr.io/my-project/my-image:latest \\\n  --platform=managed \\\n  --region=asia-northeast1 \\\n  --allow-unauthenticated \\\n  --memory=512Mi \\\n  --cpu=1 \\\n  --min-instances=0 \\\n  --max-instances=100\n\n# 配置流量分割\ngcloud run services update-traffic my-service \\\n  --to-revisions=my-service-v2=50,my-service-v1=50 \\\n  --region=asia-northeast1\n</code></pre>\n<h2>存储服务</h2>\n<h3>Cloud Storage (对象存储)</h3>\n<p>GCS 提供统一的对象存储，具有多种存储类别。</p>\n<pre><code>存储类别\n├── Standard - 热数据，频繁访问\n├── Nearline - 每月访问少于1次\n├── Coldline - 每季度访问少于1次\n└── Archive - 每年访问少于1次\n</code></pre>\n<h4>操作示例</h4>\n<pre><code class=\"language-bash\"># 创建存储桶\ngsutil mb -l asia-northeast1 gs://my-bucket-name\n\n# 上传文件\ngsutil cp file.txt gs://my-bucket-name/\n\n# 同步目录\ngsutil -m rsync -r ./local-dir gs://my-bucket-name/remote-dir\n\n# 设置生命周期\ngsutil lifecycle set lifecycle.json gs://my-bucket-name\n\n# 设置 CORS\ngsutil cors set cors.json gs://my-bucket-name\n</code></pre>\n<pre><code class=\"language-json\">// lifecycle.json\n{\n  \"rule\": [\n    {\n      \"action\": {\"type\": \"SetStorageClass\", \"storageClass\": \"NEARLINE\"},\n      \"condition\": {\"age\": 30}\n    },\n    {\n      \"action\": {\"type\": \"Delete\"},\n      \"condition\": {\"age\": 365}\n    }\n  ]\n}\n</code></pre>\n<h3>Persistent Disk</h3>\n<pre><code class=\"language-bash\"># 创建 SSD 持久磁盘\ngcloud compute disks create my-disk \\\n  --size=100GB \\\n  --type=pd-ssd \\\n  --zone=asia-northeast1-a\n\n# 挂载到实例\ngcloud compute instances attach-disk my-instance \\\n  --disk=my-disk \\\n  --zone=asia-northeast1-a\n\n# 创建快照\ngcloud compute disks snapshot my-disk \\\n  --snapshot-names=my-snapshot \\\n  --zone=asia-northeast1-a\n</code></pre>\n<h2>网络服务</h2>\n<h3>VPC 网络</h3>\n<pre><code>GCP VPC 特点\n├── 全球 VPC - 跨区域统一网络\n├── 自动模式 - 自动创建子网\n├── 自定义模式 - 完全控制 CIDR\n└── 共享 VPC - 跨项目网络\n</code></pre>\n<pre><code class=\"language-bash\"># 创建自定义 VPC\ngcloud compute networks create my-vpc \\\n  --subnet-mode=custom\n\n# 创建子网\ngcloud compute networks subnets create my-subnet \\\n  --network=my-vpc \\\n  --region=asia-northeast1 \\\n  --range=10.0.0.0/24\n\n# 创建防火墙规则\ngcloud compute firewall-rules create allow-http \\\n  --network=my-vpc \\\n  --allow=tcp:80,tcp:443 \\\n  --source-ranges=0.0.0.0/0 \\\n  --target-tags=http-server\n</code></pre>\n<h3>Cloud Load Balancing</h3>\n<pre><code class=\"language-bash\"># 创建健康检查\ngcloud compute health-checks create http my-health-check \\\n  --port=80 \\\n  --request-path=/health\n\n# 创建后端服务\ngcloud compute backend-services create my-backend \\\n  --protocol=HTTP \\\n  --health-checks=my-health-check \\\n  --global\n\n# 添加后端实例组\ngcloud compute backend-services add-backend my-backend \\\n  --instance-group=my-group \\\n  --instance-group-zone=asia-northeast1-a \\\n  --global\n\n# 创建 URL 映射\ngcloud compute url-maps create my-lb \\\n  --default-service=my-backend\n\n# 创建 HTTP 代理\ngcloud compute target-http-proxies create my-proxy \\\n  --url-map=my-lb\n\n# 创建转发规则\ngcloud compute forwarding-rules create my-forwarding-rule \\\n  --global \\\n  --target-http-proxy=my-proxy \\\n  --ports=80\n</code></pre>\n<h3>Cloud DNS</h3>\n<pre><code class=\"language-bash\"># 创建托管区域\ngcloud dns managed-zones create my-zone \\\n  --dns-name=example.com. \\\n  --description=\"My DNS zone\"\n\n# 添加 A 记录\ngcloud dns record-sets transaction start --zone=my-zone\ngcloud dns record-sets transaction add 1.2.3.4 \\\n  --name=www.example.com. \\\n  --ttl=300 \\\n  --type=A \\\n  --zone=my-zone\ngcloud dns record-sets transaction execute --zone=my-zone\n</code></pre>\n<h2>数据库服务</h2>\n<h3>Cloud SQL</h3>\n<pre><code class=\"language-bash\"># 创建 PostgreSQL 实例\ngcloud sql instances create my-db \\\n  --database-version=POSTGRES_15 \\\n  --tier=db-custom-2-4096 \\\n  --region=asia-northeast1 \\\n  --root-password=MyPassword123 \\\n  --availability-type=REGIONAL\n\n# 创建数据库\ngcloud sql databases create mydb --instance=my-db\n\n# 创建用户\ngcloud sql users create myuser \\\n  --instance=my-db \\\n  --password=UserPassword123\n</code></pre>\n<h3>Firestore / Datastore</h3>\n<pre><code class=\"language-python\">from google.cloud import firestore\n\n# 初始化客户端\ndb = firestore.Client()\n\n# 添加文档\ndoc_ref = db.collection('users').document('user123')\ndoc_ref.set({\n    'name': 'John Doe',\n    'email': 'john@example.com',\n    'created_at': firestore.SERVER_TIMESTAMP\n})\n\n# 查询数据\nusers_ref = db.collection('users')\ndocs = users_ref.where('name', '==', 'John Doe').stream()\nfor doc in docs:\n    print(f'{doc.id} => {doc.to_dict()}')\n</code></pre>\n<h3>BigQuery (数据仓库)</h3>\n<pre><code class=\"language-sql\">-- 创建数据集\nCREATE SCHEMA my_dataset;\n\n-- 创建表\nCREATE TABLE my_dataset.users (\n  user_id STRING,\n  name STRING,\n  email STRING,\n  created_at TIMESTAMP\n);\n\n-- 查询 (支持 PB 级数据)\nSELECT\n  DATE(created_at) as date,\n  COUNT(*) as user_count\nFROM my_dataset.users\nWHERE created_at >= '2024-01-01'\nGROUP BY date\nORDER BY date;\n</code></pre>\n<pre><code class=\"language-bash\"># 从 GCS 加载数据\nbq load \\\n  --source_format=CSV \\\n  my_dataset.users \\\n  gs://my-bucket/users.csv \\\n  user_id:STRING,name:STRING,email:STRING\n</code></pre>\n<h2>IAM 与安全</h2>\n<h3>角色和权限</h3>\n<pre><code class=\"language-bash\"># 授予项目级别角色\ngcloud projects add-iam-policy-binding my-project \\\n  --member=user:user@example.com \\\n  --role=roles/compute.admin\n\n# 授予资源级别权限\ngcloud storage buckets add-iam-policy-binding gs://my-bucket \\\n  --member=serviceAccount:sa@my-project.iam.gserviceaccount.com \\\n  --role=roles/storage.objectViewer\n\n# 创建服务账号\ngcloud iam service-accounts create my-sa \\\n  --display-name=\"My Service Account\"\n\n# 创建密钥\ngcloud iam service-accounts keys create key.json \\\n  --iam-account=my-sa@my-project.iam.gserviceaccount.com\n</code></pre>\n<h3>自定义角色</h3>\n<pre><code class=\"language-yaml\"># custom-role.yaml\ntitle: \"Custom Storage Reader\"\ndescription: \"Custom role for reading storage\"\nstage: \"GA\"\nincludedPermissions:\n  - storage.objects.get\n  - storage.objects.list\n  - storage.buckets.get\n</code></pre>\n<pre><code class=\"language-bash\">gcloud iam roles create customStorageReader \\\n  --project=my-project \\\n  --file=custom-role.yaml\n</code></pre>\n<h2>GKE (Kubernetes Engine)</h2>\n<pre><code class=\"language-bash\"># 创建 GKE 集群\ngcloud container clusters create my-cluster \\\n  --zone=asia-northeast1-a \\\n  --num-nodes=3 \\\n  --machine-type=e2-medium \\\n  --enable-autoscaling \\\n  --min-nodes=1 \\\n  --max-nodes=5\n\n# 获取集群凭证\ngcloud container clusters get-credentials my-cluster \\\n  --zone=asia-northeast1-a\n\n# 部署应用\nkubectl apply -f deployment.yaml\n</code></pre>\n<h2>成本管理</h2>\n<pre><code class=\"language-bash\"># 导出计费数据到 BigQuery\ngcloud billing accounts list\n\n# 设置预算警报\ngcloud billing budgets create \\\n  --billing-account=ACCOUNT_ID \\\n  --display-name=\"Monthly Budget\" \\\n  --budget-amount=1000USD \\\n  --threshold-rules=percent=50 \\\n  --threshold-rules=percent=90\n</code></pre>\n<h2>总结</h2>\n<p>GCP 核心服务要点：</p>\n<ol>\n<li><strong>计算</strong>: Compute Engine, Cloud Functions, Cloud Run, GKE</li>\n<li><strong>存储</strong>: Cloud Storage, Persistent Disk, Filestore</li>\n<li><strong>数据库</strong>: Cloud SQL, Firestore, Bigtable, Spanner</li>\n<li><strong>数据分析</strong>: BigQuery, Dataflow, Pub/Sub</li>\n<li><strong>网络</strong>: VPC, Cloud Load Balancing, Cloud CDN</li>\n<li><strong>AI/ML</strong>: Vertex AI, AutoML, Vision AI</li>\n</ol>\n"
}