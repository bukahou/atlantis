{
  "slug": "service",
  "meta": {
    "title": "服务管理",
    "description": "Linux 服务管理：systemd 架构、单元配置与系统引导",
    "order": 6,
    "tags": [
      "Linux",
      "systemd",
      "服务",
      "init"
    ]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "核心概念",
      "items": [
        "systemd 是现代 Linux 的 init 系统和服务管理器",
        "Unit 是 systemd 管理的基本单位",
        "并行启动服务，大幅提升启动速度",
        "提供日志、定时任务、网络等统一管理"
      ]
    },
    {
      "type": "comparison",
      "title": "systemd vs SysVinit",
      "columns": [
        {
          "title": "systemd",
          "color": "from-blue-500 to-cyan-500",
          "items": [
            {
              "label": "启动方式",
              "description": "并行启动，按依赖"
            },
            {
              "label": "配置格式",
              "description": "声明式 Unit 文件"
            },
            {
              "label": "服务管理",
              "description": "systemctl 命令"
            },
            {
              "label": "日志系统",
              "description": "journald 二进制日志"
            },
            {
              "label": "依赖管理",
              "description": "自动解析依赖关系"
            }
          ]
        },
        {
          "title": "SysVinit",
          "color": "from-amber-500 to-orange-500",
          "items": [
            {
              "label": "启动方式",
              "description": "串行启动，按顺序"
            },
            {
              "label": "配置格式",
              "description": "Shell 脚本"
            },
            {
              "label": "服务管理",
              "description": "service/chkconfig"
            },
            {
              "label": "日志系统",
              "description": "syslog 文本日志"
            },
            {
              "label": "依赖管理",
              "description": "手动管理顺序"
            }
          ]
        }
      ]
    },
    {
      "type": "cards",
      "title": "Unit 类型",
      "layout": "grid",
      "columns": 3,
      "items": [
        {
          "title": ".service",
          "badge": "服务",
          "badgeColor": "blue",
          "points": [
            "后台服务进程",
            "最常用的类型",
            "如 nginx.service"
          ]
        },
        {
          "title": ".socket",
          "badge": "套接字",
          "badgeColor": "green",
          "points": [
            "Socket 激活",
            "按需启动服务",
            "节省资源"
          ]
        },
        {
          "title": ".timer",
          "badge": "定时",
          "badgeColor": "amber",
          "points": [
            "替代 cron",
            "定时触发服务",
            "更灵活的调度"
          ]
        },
        {
          "title": ".target",
          "badge": "目标",
          "badgeColor": "purple",
          "points": [
            "服务分组",
            "类似运行级别",
            "如 multi-user.target"
          ]
        },
        {
          "title": ".mount",
          "badge": "挂载",
          "badgeColor": "cyan",
          "points": [
            "文件系统挂载",
            "自动生成",
            "对应 /etc/fstab"
          ]
        },
        {
          "title": ".path",
          "badge": "路径",
          "badgeColor": "red",
          "points": [
            "路径监控",
            "文件变化触发",
            "inotify 机制"
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "systemctl 常用命令",
      "language": "bash",
      "code": "# 服务控制\nsystemctl start nginx      # 启动服务\nsystemctl stop nginx       # 停止服务\nsystemctl restart nginx    # 重启服务\nsystemctl reload nginx     # 重载配置\nsystemctl status nginx     # 查看状态\n\n# 开机自启\nsystemctl enable nginx     # 启用自启\nsystemctl disable nginx    # 禁用自启\nsystemctl is-enabled nginx # 检查是否自启\n\n# 服务列表\nsystemctl list-units --type=service          # 已加载服务\nsystemctl list-units --type=service --all    # 所有服务\nsystemctl list-unit-files --type=service     # 服务文件\n\n# 依赖关系\nsystemctl list-dependencies nginx\nsystemctl list-dependencies --reverse nginx  # 反向依赖\n\n# 系统状态\nsystemctl is-system-running  # 系统状态\nsystemctl --failed           # 失败的服务"
    },
    {
      "type": "flow",
      "title": "systemd 启动流程",
      "direction": "vertical",
      "steps": [
        {
          "label": "内核启动",
          "description": "加载 initramfs",
          "color": "bg-gray-500"
        },
        {
          "label": "systemd (PID 1)",
          "description": "初始化系统",
          "color": "bg-blue-500"
        },
        {
          "label": "default.target",
          "description": "默认目标",
          "color": "bg-cyan-500"
        },
        {
          "label": "依赖解析",
          "description": "构建依赖树",
          "color": "bg-purple-500"
        },
        {
          "label": "并行启动",
          "description": "启动所有服务",
          "color": "bg-green-500"
        },
        {
          "label": "用户登录",
          "description": "getty/display-manager",
          "color": "bg-amber-500"
        }
      ]
    },
    {
      "type": "table",
      "title": "运行目标 (Target)",
      "highlightFirst": true,
      "headers": [
        "Target",
        "说明",
        "对应运行级别"
      ],
      "rows": [
        [
          "poweroff.target",
          "关机",
          "0"
        ],
        [
          "rescue.target",
          "救援模式",
          "1 (单用户)"
        ],
        [
          "multi-user.target",
          "多用户命令行",
          "3"
        ],
        [
          "graphical.target",
          "图形界面",
          "5"
        ],
        [
          "reboot.target",
          "重启",
          "6"
        ],
        [
          "emergency.target",
          "紧急模式",
          "-"
        ]
      ]
    },
    {
      "type": "codeBlock",
      "title": "Unit 文件结构",
      "language": "ini",
      "code": "# /etc/systemd/system/myapp.service\n[Unit]\nDescription=My Application Service\nAfter=network.target          # 在网络启动后\nWants=postgresql.service      # 弱依赖\nRequires=redis.service        # 强依赖\n\n[Service]\nType=simple                   # 服务类型\nUser=myapp                    # 运行用户\nGroup=myapp                   # 运行组\nWorkingDirectory=/opt/myapp   # 工作目录\nExecStart=/opt/myapp/bin/server  # 启动命令\nExecReload=/bin/kill -HUP $MAINPID  # 重载命令\nRestart=on-failure            # 失败时重启\nRestartSec=5                  # 重启间隔\n\n# 资源限制\nLimitNOFILE=65535\nLimitNPROC=4096\n\n# 安全加固\nNoNewPrivileges=true\nProtectSystem=strict\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.target    # 安装目标"
    },
    {
      "type": "table",
      "title": "Service 类型",
      "highlightFirst": true,
      "headers": [
        "Type",
        "说明",
        "适用场景"
      ],
      "rows": [
        [
          "simple",
          "主进程即服务进程",
          "大多数守护进程"
        ],
        [
          "forking",
          "fork 后父进程退出",
          "传统守护进程"
        ],
        [
          "oneshot",
          "一次性执行",
          "启动脚本"
        ],
        [
          "notify",
          "就绪时通知 systemd",
          "支持 sd_notify"
        ],
        [
          "idle",
          "空闲时启动",
          "低优先级任务"
        ]
      ]
    },
    {
      "type": "codeBlock",
      "title": "journalctl 日志查看",
      "language": "bash",
      "code": "# 基本查看\njournalctl                    # 所有日志\njournalctl -f                 # 实时跟踪\njournalctl -n 50              # 最近 50 条\n\n# 按服务过滤\njournalctl -u nginx           # nginx 服务日志\njournalctl -u nginx -f        # 实时跟踪\njournalctl -u nginx --since today\n\n# 按时间过滤\njournalctl --since \"2024-01-01\"\njournalctl --since \"1 hour ago\"\njournalctl --since \"09:00\" --until \"10:00\"\n\n# 按优先级过滤\njournalctl -p err             # 错误及以上\njournalctl -p warning         # 警告及以上\n\n# 内核日志\njournalctl -k                 # 等同于 dmesg\njournalctl -k -b              # 本次启动的内核日志\n\n# 输出格式\njournalctl -o json-pretty     # JSON 格式\njournalctl -o short-iso       # ISO 时间格式"
    },
    {
      "type": "codeBlock",
      "title": "定时任务 (Timer)",
      "language": "ini",
      "code": "# /etc/systemd/system/backup.timer\n[Unit]\nDescription=Daily Backup Timer\n\n[Timer]\nOnCalendar=*-*-* 02:00:00     # 每天凌晨 2 点\nPersistent=true               # 错过时间也执行\nRandomizedDelaySec=300        # 随机延迟 0-5 分钟\n\n[Install]\nWantedBy=timers.target\n\n# /etc/systemd/system/backup.service\n[Unit]\nDescription=Backup Service\n\n[Service]\nType=oneshot\nExecStart=/usr/local/bin/backup.sh\n\n# 启用定时器\n# systemctl enable --now backup.timer\n# systemctl list-timers"
    },
    {
      "type": "cards",
      "title": "高级特性",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "Socket 激活",
          "badge": "按需",
          "badgeColor": "blue",
          "points": [
            "监听端口，按需启动服务",
            "空闲时不占用资源",
            "支持 TCP/UDP/Unix Socket"
          ]
        },
        {
          "title": "资源控制",
          "badge": "cgroup",
          "badgeColor": "green",
          "points": [
            "CPUQuota 限制 CPU",
            "MemoryMax 限制内存",
            "IOWeight 控制 I/O 优先级"
          ]
        },
        {
          "title": "安全沙箱",
          "badge": "隔离",
          "badgeColor": "purple",
          "points": [
            "PrivateTmp 私有 /tmp",
            "ProtectSystem 只读系统",
            "NoNewPrivileges 禁止提权"
          ]
        },
        {
          "title": "依赖管理",
          "badge": "顺序",
          "badgeColor": "amber",
          "points": [
            "After/Before 顺序控制",
            "Requires 强依赖",
            "Wants 弱依赖"
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "资源限制配置",
      "language": "ini",
      "code": "[Service]\n# CPU 限制\nCPUQuota=200%              # 最多使用 2 个 CPU 核心\nCPUWeight=100              # CPU 权重 (1-10000)\n\n# 内存限制\nMemoryMax=2G               # 最大内存\nMemoryHigh=1.5G            # 高水位警告\n\n# I/O 限制\nIOWeight=100               # I/O 权重\nIOReadBandwidthMax=/dev/sda 100M\nIOWriteBandwidthMax=/dev/sda 50M\n\n# 进程限制\nTasksMax=512               # 最大进程/线程数\n\n# 查看资源使用\n# systemctl show nginx --property=MemoryCurrent\n# systemd-cgtop"
    },
    {
      "type": "list",
      "title": "服务管理最佳实践",
      "style": "check",
      "items": [
        {
          "label": "使用 systemctl 管理服务",
          "description": "取代 service 命令"
        },
        {
          "label": "配置资源限制",
          "description": "防止单个服务耗尽资源"
        },
        {
          "label": "启用安全选项",
          "description": "PrivateTmp, ProtectSystem"
        },
        {
          "label": "使用 Timer 替代 cron",
          "description": "更好的日志和依赖管理"
        },
        {
          "label": "监控失败服务",
          "description": "systemctl --failed"
        }
      ]
    }
  ],
  "relatedTopics": [
    "Linux 内核",
    "进程管理",
    "日志管理"
  ]
}