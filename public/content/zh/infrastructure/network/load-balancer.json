{
  "slug": "load-balancer",
  "meta": {
    "title": "负载均衡",
    "description": "L3/L4/L7 负载均衡策略、算法与高可用架构",
    "order": 7,
    "tags": [
      "负载均衡",
      "L3",
      "L4",
      "L7",
      "高可用"
    ]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "核心概念",
      "items": [
        "负载均衡分发流量到多个后端服务器",
        "按 OSI 层级分：L3/L4/L7 负载均衡",
        "多种算法：轮询、权重、最少连接、哈希",
        "健康检查确保流量只发往健康节点"
      ]
    },
    {
      "type": "text",
      "title": "负载均衡概述",
      "content": "负载均衡是将网络流量分发到多个服务器的技术，按工作层级可分为：L3（网络层，基于 IP）、L4（传输层，基于 IP+端口）、L7（应用层，基于内容）。它是构建高可用分布式系统的核心组件。"
    },
    {
      "type": "table",
      "title": "负载均衡层级对比",
      "highlightFirst": true,
      "headers": [
        "层级",
        "依据",
        "技术/设备",
        "特点"
      ],
      "rows": [
        [
          "L3 网络层",
          "IP 地址",
          "DNS 轮询、ECMP、BGP Anycast",
          "简单高效，无状态"
        ],
        [
          "L4 传输层",
          "IP + 端口",
          "LVS、IPVS、NLB",
          "高性能，四层转发"
        ],
        [
          "L7 应用层",
          "URL/Header/Cookie",
          "Nginx、HAProxy、ALB",
          "智能路由，内容感知"
        ]
      ]
    },
    {
      "type": "cards",
      "title": "L3 网络层负载均衡",
      "layout": "grid",
      "columns": 3,
      "items": [
        {
          "title": "DNS 轮询",
          "badge": "DNS",
          "badgeColor": "gray",
          "points": [
            "一个域名多个 A 记录",
            "DNS 服务器轮询返回",
            "简单但不感知服务状态",
            "依赖 TTL 缓存"
          ]
        },
        {
          "title": "ECMP",
          "badge": "路由",
          "badgeColor": "blue",
          "points": [
            "等价多路径路由",
            "路由器层面分发",
            "基于流的哈希",
            "高性能数据中心"
          ]
        },
        {
          "title": "BGP Anycast",
          "badge": "全球",
          "badgeColor": "green",
          "points": [
            "多节点相同 IP",
            "就近路由访问",
            "CDN 广泛使用",
            "天然容灾"
          ]
        }
      ]
    },
    {
      "type": "comparison",
      "title": "L4 vs L7 负载均衡",
      "columns": [
        {
          "title": "L4 负载均衡",
          "color": "from-blue-500 to-cyan-500",
          "items": [
            {
              "label": "工作层",
              "description": "传输层 (TCP/UDP)"
            },
            {
              "label": "依据",
              "description": "IP + 端口"
            },
            {
              "label": "性能",
              "description": "极高，内核态转发"
            },
            {
              "label": "功能",
              "description": "简单转发"
            },
            {
              "label": "代表",
              "description": "LVS、IPVS、F5"
            }
          ]
        },
        {
          "title": "L7 负载均衡",
          "color": "from-purple-500 to-pink-500",
          "items": [
            {
              "label": "工作层",
              "description": "应用层 (HTTP)"
            },
            {
              "label": "依据",
              "description": "URL、Header、Cookie"
            },
            {
              "label": "性能",
              "description": "相对较低，用户态"
            },
            {
              "label": "功能",
              "description": "内容路由、SSL 终止"
            },
            {
              "label": "代表",
              "description": "Nginx、HAProxy"
            }
          ]
        }
      ]
    },
    {
      "type": "table",
      "title": "负载均衡算法",
      "highlightFirst": true,
      "headers": [
        "算法",
        "原理",
        "适用场景"
      ],
      "rows": [
        [
          "轮询 (Round Robin)",
          "依次分发",
          "服务器性能相近"
        ],
        [
          "加权轮询",
          "按权重比例分发",
          "服务器性能不同"
        ],
        [
          "最少连接",
          "分发给连接数最少的",
          "长连接场景"
        ],
        [
          "IP 哈希",
          "相同 IP 固定到同一服务器",
          "会话保持"
        ],
        [
          "一致性哈希",
          "环形哈希映射",
          "缓存服务器"
        ],
        [
          "最快响应",
          "分发给响应最快的",
          "性能敏感场景"
        ]
      ]
    },
    {
      "type": "flow",
      "title": "多层负载均衡架构",
      "subtitle": "典型企业架构",
      "direction": "horizontal",
      "steps": [
        {
          "label": "L3 DNS",
          "description": "Anycast/轮询",
          "color": "bg-gray-500"
        },
        {
          "label": "L4 LB",
          "description": "LVS/NLB",
          "color": "bg-blue-500"
        },
        {
          "label": "L7 LB",
          "description": "Nginx/HAProxy",
          "color": "bg-purple-500"
        },
        {
          "label": "App Server",
          "description": "应用服务",
          "color": "bg-green-500"
        }
      ]
    },
    {
      "type": "cards",
      "title": "主流负载均衡方案",
      "layout": "grid",
      "columns": 3,
      "items": [
        {
          "title": "LVS/IPVS",
          "badge": "L4",
          "badgeColor": "blue",
          "points": [
            "Linux 内核模块",
            "极高性能",
            "DR/NAT/TUN 模式",
            "开源免费"
          ]
        },
        {
          "title": "Nginx",
          "badge": "L7",
          "badgeColor": "green",
          "points": [
            "HTTP 反向代理",
            "丰富的路由规则",
            "SSL 终止和缓存",
            "开源免费"
          ]
        },
        {
          "title": "HAProxy",
          "badge": "L4/L7",
          "badgeColor": "purple",
          "points": [
            "专业负载均衡器",
            "高性能高可用",
            "详细的统计信息",
            "灵活的健康检查"
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "LVS DR 模式配置",
      "language": "bash",
      "code": "# Director (负载均衡器)\nipvsadm -A -t 10.0.0.100:80 -s rr\nipvsadm -a -t 10.0.0.100:80 -r 10.0.0.1:80 -g\nipvsadm -a -t 10.0.0.100:80 -r 10.0.0.2:80 -g\n\n# Real Server (后端服务器)\n# 配置 VIP 在 lo 上，并抑制 ARP\nip addr add 10.0.0.100/32 dev lo\necho 1 > /proc/sys/net/ipv4/conf/all/arp_ignore\necho 2 > /proc/sys/net/ipv4/conf/all/arp_announce"
    },
    {
      "type": "codeBlock",
      "title": "Nginx 负载均衡配置",
      "language": "nginx",
      "code": "upstream backend {\n    # 加权轮询\n    server 10.0.0.1:8080 weight=3;\n    server 10.0.0.2:8080 weight=2;\n    server 10.0.0.3:8080 backup;  # 备用\n    \n    # 健康检查 (Nginx Plus)\n    # health_check interval=5s;\n    \n    keepalive 32;\n}\n\nserver {\n    listen 80;\n    \n    location / {\n        proxy_pass http://backend;\n        proxy_http_version 1.1;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n    }\n}"
    },
    {
      "type": "cards",
      "title": "健康检查",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "主动健康检查",
          "badge": "Active",
          "badgeColor": "green",
          "points": [
            "定期发送探测请求",
            "TCP 端口检查",
            "HTTP 状态码检查",
            "自定义健康接口"
          ]
        },
        {
          "title": "被动健康检查",
          "badge": "Passive",
          "badgeColor": "amber",
          "points": [
            "监控实际请求",
            "连续失败标记不健康",
            "响应超时检测",
            "零额外开销"
          ]
        }
      ]
    },
    {
      "type": "list",
      "title": "高可用设计要点",
      "style": "check",
      "items": [
        {
          "label": "负载均衡器冗余",
          "description": "Keepalived 主备或集群"
        },
        {
          "label": "多层负载均衡",
          "description": "L3 + L4 + L7 组合使用"
        },
        {
          "label": "完善的健康检查",
          "description": "合理设置检查间隔和阈值"
        },
        {
          "label": "优雅降级",
          "description": "配置备用服务器和降级策略"
        },
        {
          "label": "会话保持",
          "description": "根据业务选择合适的方案"
        }
      ]
    }
  ],
  "relatedTopics": [
    "L4 传输层",
    "L7 应用层",
    "高可用架构"
  ]
}