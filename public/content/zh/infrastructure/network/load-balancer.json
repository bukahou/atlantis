{
  "slug": "load-balancer",
  "meta": {
    "title": "负载均衡",
    "description": "负载均衡原理、算法与实践配置",
    "order": 4,
    "tags": [
      "network",
      "load-balancer",
      "nginx",
      "haproxy"
    ]
  },
  "content": "<h1>负载均衡</h1>\n<h2>什么是负载均衡</h2>\n<p>负载均衡是将网络流量分发到多台服务器的技术，用于提高应用的可用性、可靠性和性能。</p>\n<pre><code>                    ┌─────────────┐\n                    │   客户端    │\n                    └──────┬──────┘\n                           │\n                    ┌──────▼──────┐\n                    │  负载均衡器  │\n                    └──────┬──────┘\n              ┌────────────┼────────────┐\n              │            │            │\n        ┌─────▼─────┐┌─────▼─────┐┌─────▼─────┐\n        │  服务器1  ││  服务器2  ││  服务器3  │\n        └───────────┘└───────────┘└───────────┘\n</code></pre>\n<h2>负载均衡类型</h2>\n<h3>按 OSI 层级</h3>\n<table>\n<thead>\n<tr>\n<th>类型</th>\n<th>层级</th>\n<th>特点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>L4 负载均衡</strong></td>\n<td>传输层</td>\n<td>基于 IP + 端口，性能高</td>\n</tr>\n<tr>\n<td><strong>L7 负载均衡</strong></td>\n<td>应用层</td>\n<td>基于内容 (URL、Header)，功能强</td>\n</tr>\n</tbody>\n</table>\n<h3>L4 vs L7</h3>\n<pre><code>L4 负载均衡:\n客户端 ──TCP──> 负载均衡器 ──TCP──> 后端服务器\n              只看 IP:Port\n\nL7 负载均衡:\n客户端 ──HTTP──> 负载均衡器 ──HTTP──> 后端服务器\n                解析 URL/Header/Cookie\n</code></pre>\n<h2>负载均衡算法</h2>\n<h3>轮询 (Round Robin)</h3>\n<pre><code>请求依次分发到每台服务器\n\n请求1 → Server1\n请求2 → Server2\n请求3 → Server3\n请求4 → Server1\n...\n</code></pre>\n<h3>加权轮询 (Weighted Round Robin)</h3>\n<pre><code>根据权重比例分发\n\nServer1 (weight=3): 3 个请求\nServer2 (weight=2): 2 个请求\nServer3 (weight=1): 1 个请求\n</code></pre>\n<h3>最少连接 (Least Connections)</h3>\n<pre><code>选择当前连接数最少的服务器\n\nServer1: 10 连接\nServer2: 5 连接  ← 新请求\nServer3: 8 连接\n</code></pre>\n<h3>IP 哈希 (IP Hash)</h3>\n<pre><code>相同客户端 IP 始终访问同一服务器\n\nhash(客户端IP) % 服务器数量 = 目标服务器\n</code></pre>\n<h3>一致性哈希 (Consistent Hash)</h3>\n<pre><code>解决服务器增减时的重新分配问题\n\n     0\n    /   \\\n   S1    S3\n  /        \\\n S2 ────── hash环\n</code></pre>\n<h2>Nginx 配置</h2>\n<h3>基本配置</h3>\n<pre><code class=\"language-nginx\">http {\n    upstream backend {\n        server 192.168.1.101:8080;\n        server 192.168.1.102:8080;\n        server 192.168.1.103:8080;\n    }\n\n    server {\n        listen 80;\n        server_name example.com;\n\n        location / {\n            proxy_pass http://backend;\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        }\n    }\n}\n</code></pre>\n<h3>负载均衡算法</h3>\n<pre><code class=\"language-nginx\">upstream backend {\n    # 默认轮询\n    server 192.168.1.101:8080;\n    server 192.168.1.102:8080;\n}\n\nupstream backend_weighted {\n    # 加权轮询\n    server 192.168.1.101:8080 weight=3;\n    server 192.168.1.102:8080 weight=2;\n    server 192.168.1.103:8080 weight=1;\n}\n\nupstream backend_least_conn {\n    # 最少连接\n    least_conn;\n    server 192.168.1.101:8080;\n    server 192.168.1.102:8080;\n}\n\nupstream backend_ip_hash {\n    # IP 哈希\n    ip_hash;\n    server 192.168.1.101:8080;\n    server 192.168.1.102:8080;\n}\n\nupstream backend_hash {\n    # 一致性哈希\n    hash $request_uri consistent;\n    server 192.168.1.101:8080;\n    server 192.168.1.102:8080;\n}\n</code></pre>\n<h3>健康检查</h3>\n<pre><code class=\"language-nginx\">upstream backend {\n    server 192.168.1.101:8080 max_fails=3 fail_timeout=30s;\n    server 192.168.1.102:8080 max_fails=3 fail_timeout=30s;\n    server 192.168.1.103:8080 backup;  # 备用服务器\n}\n</code></pre>\n<h3>会话保持</h3>\n<pre><code class=\"language-nginx\">upstream backend {\n    ip_hash;  # 基于 IP 的会话保持\n    server 192.168.1.101:8080;\n    server 192.168.1.102:8080;\n}\n\n# 或使用 sticky cookie (需要 nginx-sticky-module)\nupstream backend {\n    sticky cookie srv_id expires=1h;\n    server 192.168.1.101:8080;\n    server 192.168.1.102:8080;\n}\n</code></pre>\n<h2>HAProxy 配置</h2>\n<h3>基本配置</h3>\n<pre><code class=\"language-haproxy\">global\n    daemon\n    maxconn 4096\n\ndefaults\n    mode http\n    timeout connect 5s\n    timeout client 50s\n    timeout server 50s\n\nfrontend http_front\n    bind *:80\n    default_backend http_back\n\nbackend http_back\n    balance roundrobin\n    server server1 192.168.1.101:8080 check\n    server server2 192.168.1.102:8080 check\n    server server3 192.168.1.103:8080 check\n</code></pre>\n<h3>负载均衡算法</h3>\n<pre><code class=\"language-haproxy\">backend http_back\n    # 轮询\n    balance roundrobin\n\n    # 最少连接\n    balance leastconn\n\n    # 源 IP 哈希\n    balance source\n\n    # URI 哈希\n    balance uri\n\n    server server1 192.168.1.101:8080 check weight 3\n    server server2 192.168.1.102:8080 check weight 2\n</code></pre>\n<h3>健康检查</h3>\n<pre><code class=\"language-haproxy\">backend http_back\n    option httpchk GET /health\n    http-check expect status 200\n\n    server server1 192.168.1.101:8080 check inter 5s fall 3 rise 2\n    server server2 192.168.1.102:8080 check inter 5s fall 3 rise 2\n</code></pre>\n<h3>会话保持</h3>\n<pre><code class=\"language-haproxy\">backend http_back\n    balance roundrobin\n    cookie SERVERID insert indirect nocache\n\n    server server1 192.168.1.101:8080 check cookie s1\n    server server2 192.168.1.102:8080 check cookie s2\n</code></pre>\n<h2>云服务负载均衡</h2>\n<h3>AWS ALB/NLB</h3>\n<pre><code>ALB (Application Load Balancer):\n- L7 负载均衡\n- 支持路径路由、主机路由\n- WebSocket 支持\n\nNLB (Network Load Balancer):\n- L4 负载均衡\n- 超高性能\n- 静态 IP 支持\n</code></pre>\n<h3>阿里云 SLB</h3>\n<pre><code>CLB (传统负载均衡):\n- L4/L7 支持\n- 按量付费\n\nALB (应用负载均衡):\n- L7 专用\n- 灰度发布支持\n</code></pre>\n<h2>高可用架构</h2>\n<h3>主备模式</h3>\n<pre><code>         ┌──────────────┐\n         │   虚拟 IP    │\n         │ (Keepalived) │\n         └──────┬───────┘\n          ┌─────┴─────┐\n    ┌─────▼─────┐┌────▼────┐\n    │  LB 主    ││  LB 备  │\n    └─────┬─────┘└────┬────┘\n          └─────┬─────┘\n         后端服务器集群\n</code></pre>\n<h3>Keepalived 配置</h3>\n<pre><code class=\"language-bash\"># /etc/keepalived/keepalived.conf\n\nvrrp_instance VI_1 {\n    state MASTER\n    interface eth0\n    virtual_router_id 51\n    priority 100\n    advert_int 1\n\n    authentication {\n        auth_type PASS\n        auth_pass 1234\n    }\n\n    virtual_ipaddress {\n        192.168.1.100\n    }\n}\n</code></pre>\n<h2>监控指标</h2>\n<h3>关键指标</h3>\n<table>\n<thead>\n<tr>\n<th>指标</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>QPS</td>\n<td>每秒查询数</td>\n</tr>\n<tr>\n<td>响应时间</td>\n<td>请求处理耗时</td>\n</tr>\n<tr>\n<td>错误率</td>\n<td>失败请求比例</td>\n</tr>\n<tr>\n<td>连接数</td>\n<td>当前活跃连接</td>\n</tr>\n<tr>\n<td>后端健康状态</td>\n<td>各服务器状态</td>\n</tr>\n</tbody>\n</table>\n<h3>Nginx 状态监控</h3>\n<pre><code class=\"language-nginx\">location /nginx_status {\n    stub_status on;\n    allow 127.0.0.1;\n    deny all;\n}\n</code></pre>\n<pre><code class=\"language-bash\"># 输出示例\nActive connections: 291\nserver accepts handled requests\n 16630948 16630948 31070465\nReading: 6 Writing: 179 Waiting: 106\n</code></pre>\n<h2>总结</h2>\n<p>负载均衡核心要点：</p>\n<ol>\n<li><strong>选择层级</strong>: L4 高性能，L7 功能强</li>\n<li><strong>选择算法</strong>: 根据业务场景选择合适算法</li>\n<li><strong>健康检查</strong>: 自动剔除故障节点</li>\n<li><strong>会话保持</strong>: 需要时配置会话亲和</li>\n<li><strong>高可用</strong>: 负载均衡器本身也需要冗余</li>\n</ol>\n"
}