{
  "meta": {
    "title": "多阶段构建",
    "description": "Docker 多阶段构建优化镜像体积与安全性",
    "order": 3,
    "tags": ["Docker", "多阶段构建", "镜像优化"]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "核心概念",
      "items": [
        "多阶段构建分离构建环境和运行环境",
        "最终镜像只包含运行所需文件",
        "显著减小镜像体积",
        "提高安全性，移除构建工具"
      ]
    },
    {
      "type": "flow",
      "title": "多阶段构建流程",
      "direction": "horizontal",
      "steps": [
        { "label": "构建阶段", "description": "编译/打包", "color": "bg-blue-500" },
        { "label": "COPY --from", "description": "复制产物", "color": "bg-purple-500" },
        { "label": "运行阶段", "description": "最小镜像", "color": "bg-green-500" }
      ]
    },
    {
      "type": "codeBlock",
      "title": "Go 应用多阶段构建",
      "language": "dockerfile",
      "code": "# 构建阶段\nFROM golang:1.21-alpine AS builder\n\nWORKDIR /app\nCOPY go.mod go.sum ./\nRUN go mod download\n\nCOPY . .\nRUN CGO_ENABLED=0 GOOS=linux go build -o /app/server ./cmd/server\n\n# 运行阶段\nFROM alpine:3.18\n\n# 安全：使用非 root 用户\nRUN adduser -D -g '' appuser\nUSER appuser\n\nWORKDIR /app\nCOPY --from=builder /app/server .\n\nEXPOSE 8080\nCMD [\"./server\"]\n\n# 最终镜像：~15MB vs 构建镜像 ~300MB"
    },
    {
      "type": "codeBlock",
      "title": "Node.js 应用多阶段构建",
      "language": "dockerfile",
      "code": "# 依赖安装阶段\nFROM node:18-alpine AS deps\nWORKDIR /app\nCOPY package*.json ./\nRUN npm ci --only=production\n\n# 构建阶段\nFROM node:18-alpine AS builder\nWORKDIR /app\nCOPY package*.json ./\nRUN npm ci\nCOPY . .\nRUN npm run build\n\n# 运行阶段\nFROM node:18-alpine AS runner\nWORKDIR /app\n\nENV NODE_ENV=production\n\n# 只复制必要文件\nCOPY --from=deps /app/node_modules ./node_modules\nCOPY --from=builder /app/dist ./dist\nCOPY --from=builder /app/package.json ./\n\nUSER node\nEXPOSE 3000\nCMD [\"node\", \"dist/index.js\"]"
    },
    {
      "type": "codeBlock",
      "title": "React 静态站点构建",
      "language": "dockerfile",
      "code": "# 构建阶段\nFROM node:18-alpine AS builder\nWORKDIR /app\n\nCOPY package*.json ./\nRUN npm ci\n\nCOPY . .\nRUN npm run build\n\n# Nginx 运行阶段\nFROM nginx:alpine\n\n# 复制构建产物\nCOPY --from=builder /app/dist /usr/share/nginx/html\n\n# 自定义 nginx 配置\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE 80\nCMD [\"nginx\", \"-g\", \"daemon off;\"]\n\n# 最终镜像：~25MB（只有静态文件 + nginx）"
    },
    {
      "type": "comparison",
      "title": "镜像体积对比",
      "columns": [
        {
          "title": "单阶段构建",
          "color": "from-red-500 to-orange-500",
          "items": [
            { "label": "Go 应用", "description": "~300MB" },
            { "label": "Node.js", "description": "~500MB" },
            { "label": "包含", "description": "构建工具、源码" }
          ]
        },
        {
          "title": "多阶段构建",
          "color": "from-green-500 to-emerald-500",
          "items": [
            { "label": "Go 应用", "description": "~15MB" },
            { "label": "Node.js", "description": "~150MB" },
            { "label": "包含", "description": "仅运行时依赖" }
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "高级技巧：条件构建",
      "language": "dockerfile",
      "code": "# 基础阶段\nFROM golang:1.21-alpine AS base\nWORKDIR /app\nCOPY go.mod go.sum ./\nRUN go mod download\nCOPY . .\n\n# 开发阶段（可选）\nFROM base AS development\nRUN go install github.com/cosmtrek/air@latest\nCMD [\"air\"]\n\n# 测试阶段\nFROM base AS test\nRUN go test -v ./...\n\n# 生产构建\nFROM base AS builder\nRUN CGO_ENABLED=0 go build -ldflags=\"-s -w\" -o /server\n\n# 生产运行\nFROM gcr.io/distroless/static-debian11 AS production\nCOPY --from=builder /server /\nCMD [\"/server\"]\n\n# 使用：docker build --target production -t app:prod ."
    },
    {
      "type": "table",
      "title": "常用基础镜像",
      "highlightFirst": true,
      "headers": ["镜像", "大小", "适用场景"],
      "rows": [
        ["scratch", "0MB", "静态编译二进制（Go/Rust）"],
        ["distroless", "~2MB", "无 shell，高安全"],
        ["alpine", "~5MB", "需要 shell/工具"],
        ["debian-slim", "~25MB", "需要 glibc"]
      ]
    },
    {
      "type": "list",
      "title": "最佳实践",
      "style": "check",
      "items": [
        { "label": "命名构建阶段", "description": "使用 AS 命名，提高可读性" },
        { "label": "利用缓存", "description": "先复制依赖文件，再复制源码" },
        { "label": "使用 distroless", "description": "生产环境使用无 shell 镜像" },
        { "label": "压缩二进制", "description": "Go 使用 -ldflags=\"-s -w\"" },
        { "label": "非 root 运行", "description": "USER 指令切换用户" }
      ]
    }
  ],
  "relatedTopics": ["Docker 基础", "CI/CD", "安全"]
}
