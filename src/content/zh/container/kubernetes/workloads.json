{
  "meta": {
    "title": "工作负载",
    "description": "Kubernetes 工作负载：StatefulSet、DaemonSet、Job 与 CronJob",
    "order": 3,
    "tags": ["Kubernetes", "工作负载", "StatefulSet", "DaemonSet", "Job"]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "核心概念",
      "items": [
        "Deployment 适合无状态应用",
        "StatefulSet 提供稳定的网络标识和持久存储",
        "DaemonSet 确保每个节点运行一个 Pod",
        "Job/CronJob 用于批处理和定时任务"
      ]
    },
    {
      "type": "cards",
      "title": "工作负载类型",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "Deployment",
          "badge": "无状态",
          "badgeColor": "blue",
          "points": [
            "无状态应用部署",
            "滚动更新/回滚",
            "Pod 可任意替换",
            "适合 Web 服务、API"
          ]
        },
        {
          "title": "StatefulSet",
          "badge": "有状态",
          "badgeColor": "green",
          "points": [
            "稳定的网络标识 (pod-0, pod-1)",
            "稳定的持久存储",
            "有序部署/扩缩容",
            "适合数据库、消息队列"
          ]
        },
        {
          "title": "DaemonSet",
          "badge": "节点级",
          "badgeColor": "amber",
          "points": [
            "每个节点运行一个 Pod",
            "新节点自动部署",
            "适合日志收集、监控 Agent",
            "节点级别的系统服务"
          ]
        },
        {
          "title": "Job/CronJob",
          "badge": "批处理",
          "badgeColor": "purple",
          "points": [
            "一次性任务 (Job)",
            "定时任务 (CronJob)",
            "成功完成后终止",
            "适合数据处理、备份"
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "StatefulSet 示例",
      "language": "yaml",
      "code": "apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: mysql\nspec:\n  serviceName: mysql  # Headless Service 名称\n  replicas: 3\n  selector:\n    matchLabels:\n      app: mysql\n  template:\n    metadata:\n      labels:\n        app: mysql\n    spec:\n      containers:\n      - name: mysql\n        image: mysql:8.0\n        ports:\n        - containerPort: 3306\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql-secret\n              key: password\n        volumeMounts:\n        - name: data\n          mountPath: /var/lib/mysql\n  volumeClaimTemplates:  # 每个 Pod 独立的 PVC\n  - metadata:\n      name: data\n    spec:\n      accessModes: [\"ReadWriteOnce\"]\n      storageClassName: standard\n      resources:\n        requests:\n          storage: 10Gi\n---\n# Headless Service (clusterIP: None)\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql\nspec:\n  clusterIP: None\n  selector:\n    app: mysql\n  ports:\n  - port: 3306\n# Pod DNS: mysql-0.mysql.namespace.svc.cluster.local"
    },
    {
      "type": "table",
      "title": "Deployment vs StatefulSet",
      "highlightFirst": true,
      "headers": ["特性", "Deployment", "StatefulSet"],
      "rows": [
        ["Pod 名称", "随机后缀 (app-xyz)", "有序编号 (app-0, app-1)"],
        ["Pod 替换", "可任意替换", "保持相同标识"],
        ["存储", "共享或无", "每 Pod 独立 PVC"],
        ["扩缩容", "并行", "有序 (逐个)"],
        ["更新策略", "滚动更新", "有序更新"],
        ["适用场景", "无状态应用", "数据库/分布式系统"]
      ]
    },
    {
      "type": "codeBlock",
      "title": "DaemonSet 示例",
      "language": "yaml",
      "code": "apiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: fluentd\n  namespace: kube-system\nspec:\n  selector:\n    matchLabels:\n      name: fluentd\n  template:\n    metadata:\n      labels:\n        name: fluentd\n    spec:\n      tolerations:  # 允许在 master 节点运行\n      - key: node-role.kubernetes.io/control-plane\n        effect: NoSchedule\n      containers:\n      - name: fluentd\n        image: fluentd:v1.14\n        resources:\n          limits:\n            memory: 200Mi\n          requests:\n            cpu: 100m\n            memory: 200Mi\n        volumeMounts:\n        - name: varlog\n          mountPath: /var/log\n        - name: containers\n          mountPath: /var/lib/docker/containers\n          readOnly: true\n      volumes:\n      - name: varlog\n        hostPath:\n          path: /var/log\n      - name: containers\n        hostPath:\n          path: /var/lib/docker/containers"
    },
    {
      "type": "codeBlock",
      "title": "Job 示例",
      "language": "yaml",
      "code": "apiVersion: batch/v1\nkind: Job\nmetadata:\n  name: data-migration\nspec:\n  ttlSecondsAfterFinished: 3600  # 完成后 1 小时清理\n  backoffLimit: 3                 # 最大重试次数\n  activeDeadlineSeconds: 600      # 超时时间\n  template:\n    spec:\n      restartPolicy: Never        # Job 必须为 Never 或 OnFailure\n      containers:\n      - name: migrate\n        image: myapp/migrate:v1\n        command: [\"./migrate.sh\"]\n        env:\n        - name: DATABASE_URL\n          valueFrom:\n            secretKeyRef:\n              name: db-secret\n              key: url\n---\n# 并行 Job\napiVersion: batch/v1\nkind: Job\nmetadata:\n  name: parallel-job\nspec:\n  completions: 10     # 需要成功完成的 Pod 数\n  parallelism: 3      # 并行运行的 Pod 数\n  template:\n    spec:\n      restartPolicy: Never\n      containers:\n      - name: worker\n        image: myapp/worker:v1"
    },
    {
      "type": "codeBlock",
      "title": "CronJob 示例",
      "language": "yaml",
      "code": "apiVersion: batch/v1\nkind: CronJob\nmetadata:\n  name: daily-backup\nspec:\n  schedule: \"0 2 * * *\"  # 每天凌晨 2 点\n  timeZone: \"Asia/Tokyo\"  # 时区设置\n  concurrencyPolicy: Forbid  # 禁止并发执行\n  successfulJobsHistoryLimit: 3\n  failedJobsHistoryLimit: 1\n  jobTemplate:\n    spec:\n      template:\n        spec:\n          restartPolicy: OnFailure\n          containers:\n          - name: backup\n            image: myapp/backup:v1\n            command: [\"/backup.sh\"]\n\n# schedule 格式: 分 时 日 月 周\n# */5 * * * *   每 5 分钟\n# 0 */2 * * *   每 2 小时\n# 0 0 * * 0     每周日凌晨"
    },
    {
      "type": "table",
      "title": "CronJob 并发策略",
      "highlightFirst": true,
      "headers": ["策略", "说明"],
      "rows": [
        ["Allow", "允许并发运行 (默认)"],
        ["Forbid", "禁止并发，跳过新任务"],
        ["Replace", "取消正在运行的，启动新任务"]
      ]
    },
    {
      "type": "list",
      "title": "工作负载选择指南",
      "style": "check",
      "items": [
        { "label": "Web/API 服务", "description": "使用 Deployment" },
        { "label": "数据库/缓存", "description": "使用 StatefulSet + Headless Service" },
        { "label": "日志/监控 Agent", "description": "使用 DaemonSet" },
        { "label": "数据迁移/ETL", "description": "使用 Job" },
        { "label": "定时备份/清理", "description": "使用 CronJob" }
      ]
    }
  ],
  "relatedTopics": ["Pod", "Deployment", "持久化存储", "调度"]
}
