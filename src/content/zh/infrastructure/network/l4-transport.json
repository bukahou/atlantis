{
  "meta": {
    "title": "L4 传输层",
    "description": "传输层协议：TCP 可靠传输与 UDP 无连接传输",
    "order": 5,
    "tags": ["传输层", "L4", "TCP", "UDP"]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "核心概念",
      "items": [
        "传输层提供端到端的通信服务",
        "TCP 面向连接，提供可靠有序传输",
        "UDP 无连接，低延迟高效率",
        "端口号标识应用进程"
      ]
    },
    {
      "type": "text",
      "title": "传输层概述",
      "content": "传输层是 OSI 模型的第四层，负责在源主机和目标主机之间提供端到端的数据传输服务。它使用端口号区分不同的应用进程，主要协议包括 TCP（可靠传输）和 UDP（尽力传输）。"
    },
    {
      "type": "comparison",
      "title": "TCP vs UDP",
      "columns": [
        {
          "title": "TCP",
          "color": "from-blue-500 to-cyan-500",
          "items": [
            { "label": "连接", "description": "面向连接（三次握手）" },
            { "label": "可靠性", "description": "可靠传输，有确认重传" },
            { "label": "顺序", "description": "保证数据顺序" },
            { "label": "流控", "description": "滑动窗口流量控制" },
            { "label": "头部", "description": "20-60 字节" },
            { "label": "场景", "description": "HTTP、FTP、SSH" }
          ]
        },
        {
          "title": "UDP",
          "color": "from-green-500 to-emerald-500",
          "items": [
            { "label": "连接", "description": "无连接" },
            { "label": "可靠性", "description": "不可靠，可能丢失" },
            { "label": "顺序", "description": "不保证顺序" },
            { "label": "流控", "description": "无流量控制" },
            { "label": "头部", "description": "8 字节" },
            { "label": "场景", "description": "DNS、视频、游戏" }
          ]
        }
      ]
    },
    {
      "type": "flow",
      "title": "TCP 三次握手",
      "subtitle": "建立可靠连接",
      "direction": "horizontal",
      "steps": [
        { "label": "SYN", "description": "客户端 → 服务端", "color": "bg-blue-500" },
        { "label": "SYN+ACK", "description": "服务端 → 客户端", "color": "bg-purple-500" },
        { "label": "ACK", "description": "客户端 → 服务端", "color": "bg-green-500" }
      ]
    },
    {
      "type": "flow",
      "title": "TCP 四次挥手",
      "subtitle": "断开连接",
      "direction": "horizontal",
      "steps": [
        { "label": "FIN", "description": "主动关闭", "color": "bg-red-500" },
        { "label": "ACK", "description": "确认收到", "color": "bg-orange-500" },
        { "label": "FIN", "description": "被动关闭", "color": "bg-yellow-500" },
        { "label": "ACK", "description": "最终确认", "color": "bg-green-500" }
      ]
    },
    {
      "type": "codeBlock",
      "title": "TCP/UDP 头部结构",
      "language": "text",
      "code": "TCP 头部 (20-60 字节):\n┌─────────────────┬─────────────────┐\n│   源端口 (16)   │  目的端口 (16)  │\n├─────────────────┴─────────────────┤\n│            序列号 (32)            │\n├───────────────────────────────────┤\n│           确认号 (32)             │\n├────┬──────┬──────┬────────────────┤\n│偏移│保留  │标志位│   窗口 (16)    │\n├────┴──────┴──────┼────────────────┤\n│   校验和 (16)    │ 紧急指针 (16)  │\n├──────────────────┴────────────────┤\n│         选项 (可变长)             │\n└───────────────────────────────────┘\n\n标志位: URG, ACK, PSH, RST, SYN, FIN\n\nUDP 头部 (8 字节):\n┌─────────────────┬─────────────────┐\n│   源端口 (16)   │  目的端口 (16)  │\n├─────────────────┼─────────────────┤\n│    长度 (16)    │  校验和 (16)    │\n└─────────────────┴─────────────────┘"
    },
    {
      "type": "cards",
      "title": "TCP 核心机制",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "滑动窗口",
          "badge": "流量控制",
          "badgeColor": "blue",
          "points": [
            "接收方通告窗口大小",
            "发送方据此控制发送速率",
            "窗口大小动态调整"
          ]
        },
        {
          "title": "拥塞控制",
          "badge": "网络保护",
          "badgeColor": "amber",
          "points": [
            "慢启动：指数增长",
            "拥塞避免：线性增长",
            "快重传与快恢复"
          ]
        },
        {
          "title": "序列号",
          "badge": "可靠传输",
          "badgeColor": "green",
          "points": [
            "每个字节有序列号",
            "确认号表示期望下一个",
            "支持乱序重组"
          ]
        },
        {
          "title": "超时重传",
          "badge": "错误恢复",
          "badgeColor": "red",
          "points": [
            "RTT 动态计算超时",
            "未收到 ACK 自动重传",
            "指数退避算法"
          ]
        }
      ]
    },
    {
      "type": "table",
      "title": "常用端口",
      "highlightFirst": true,
      "headers": ["端口", "协议", "服务"],
      "rows": [
        ["20/21", "TCP", "FTP (数据/控制)"],
        ["22", "TCP", "SSH"],
        ["23", "TCP", "Telnet"],
        ["25", "TCP", "SMTP"],
        ["53", "TCP/UDP", "DNS"],
        ["80", "TCP", "HTTP"],
        ["443", "TCP", "HTTPS"],
        ["3306", "TCP", "MySQL"],
        ["6379", "TCP", "Redis"]
      ]
    },
    {
      "type": "table",
      "title": "TCP 状态转换",
      "highlightFirst": true,
      "headers": ["状态", "说明", "触发条件"],
      "rows": [
        ["LISTEN", "等待连接", "服务端监听"],
        ["SYN_SENT", "已发 SYN", "客户端发起连接"],
        ["ESTABLISHED", "已建立", "三次握手完成"],
        ["FIN_WAIT_1", "主动关闭", "发送 FIN"],
        ["TIME_WAIT", "等待 2MSL", "确保 ACK 送达"],
        ["CLOSE_WAIT", "被动关闭", "收到 FIN"]
      ]
    },
    {
      "type": "codeBlock",
      "title": "查看连接状态",
      "language": "bash",
      "code": "# 查看所有 TCP 连接\nss -ant\nnetstat -ant\n\n# 统计各状态数量\nss -ant | awk 'NR>1 {print $1}' | sort | uniq -c\n\n# 查看监听端口\nss -tlnp\nnetstat -tlnp\n\n# 查看 UDP 连接\nss -anu"
    },
    {
      "type": "list",
      "title": "TCP 调优建议",
      "style": "check",
      "items": [
        { "label": "调整缓冲区", "description": "net.core.rmem_max / wmem_max" },
        { "label": "TCP Fast Open", "description": "减少握手延迟" },
        { "label": "TIME_WAIT 复用", "description": "net.ipv4.tcp_tw_reuse" },
        { "label": "Keepalive", "description": "长连接心跳检测" }
      ]
    }
  ],
  "relatedTopics": ["L3 网络层", "L7 应用层", "Socket 编程"]
}
