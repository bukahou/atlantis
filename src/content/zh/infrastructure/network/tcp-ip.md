---
title: TCP/IP 协议基础
description: 理解网络通信的核心协议栈
order: 1
tags:
  - network
  - tcp
  - ip
  - protocol
---

# TCP/IP 协议基础

## 网络分层模型

### OSI 七层 vs TCP/IP 四层

```
OSI 模型              TCP/IP 模型           协议示例
┌─────────────┐      ┌─────────────┐
│   应用层    │      │             │       HTTP, FTP, DNS
├─────────────┤      │   应用层    │       SMTP, SSH, HTTPS
│   表示层    │      │             │
├─────────────┤      ├─────────────┤
│   会话层    │      │             │
├─────────────┤      ├─────────────┤
│   传输层    │      │   传输层    │       TCP, UDP
├─────────────┤      ├─────────────┤
│   网络层    │      │   网络层    │       IP, ICMP, ARP
├─────────────┤      ├─────────────┤
│ 数据链路层  │      │             │       Ethernet, Wi-Fi
├─────────────┤      │  网络接口层 │
│   物理层    │      │             │
└─────────────┘      └─────────────┘
```

## IP 协议

### IPv4 地址

```
32 位地址，点分十进制表示

192.168.1.100

┌────────┬────────┬────────┬────────┐
│   192  │   168  │    1   │   100  │
├────────┴────────┴────────┴────────┤
│  11000000.10101000.00000001.01100100
└───────────────────────────────────┘
```

### IP 地址分类

| 类别 | 范围 | 默认掩码 | 用途 |
|------|------|----------|------|
| A | 1.0.0.0 - 126.255.255.255 | 255.0.0.0 | 大型网络 |
| B | 128.0.0.0 - 191.255.255.255 | 255.255.0.0 | 中型网络 |
| C | 192.0.0.0 - 223.255.255.255 | 255.255.255.0 | 小型网络 |

### 私有地址

```
10.0.0.0    - 10.255.255.255   (A 类)
172.16.0.0  - 172.31.255.255   (B 类)
192.168.0.0 - 192.168.255.255  (C 类)
```

### 子网划分

```bash
# CIDR 表示法
192.168.1.0/24

# 子网掩码
255.255.255.0

# 计算
网络地址: 192.168.1.0
广播地址: 192.168.1.255
可用主机: 192.168.1.1 - 192.168.1.254 (254 个)
```

## TCP 协议

### TCP 特性

- **面向连接**: 通信前需建立连接
- **可靠传输**: 确保数据完整有序
- **流量控制**: 防止发送过快
- **拥塞控制**: 适应网络状况

### 三次握手

```
客户端                         服务器
   │                              │
   │  ─────── SYN (seq=x) ──────> │  1. 客户端发起连接
   │                              │
   │  <── SYN+ACK (seq=y,ack=x+1) │  2. 服务器确认并同步
   │                              │
   │  ─────── ACK (ack=y+1) ────> │  3. 客户端确认
   │                              │
   │        连接已建立             │
```

### 四次挥手

```
客户端                         服务器
   │                              │
   │  ─────── FIN (seq=u) ──────> │  1. 客户端请求断开
   │                              │
   │  <────── ACK (ack=u+1) ───── │  2. 服务器确认
   │                              │
   │  <────── FIN (seq=v) ─────── │  3. 服务器请求断开
   │                              │
   │  ─────── ACK (ack=v+1) ────> │  4. 客户端确认
   │                              │
   │        连接已关闭             │
```

### TCP 头部

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
├─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┤
│          源端口 (16 位)         │        目标端口 (16 位)       │
├───────────────────────────────┴───────────────────────────────┤
│                        序列号 (32 位)                          │
├───────────────────────────────────────────────────────────────┤
│                        确认号 (32 位)                          │
├───────┬───────┬─┬─┬─┬─┬─┬─┬───────────────────────────────────┤
│头长度 │ 保留  │U│A│P│R│S│F│          窗口大小 (16 位)         │
├───────┴───────┴─┴─┴─┴─┴─┴─┴───────────────────────────────────┤
│         校验和 (16 位)          │        紧急指针 (16 位)       │
└───────────────────────────────┴───────────────────────────────┘
```

### 常用端口

| 端口 | 协议 | 服务 |
|------|------|------|
| 20/21 | TCP | FTP |
| 22 | TCP | SSH |
| 23 | TCP | Telnet |
| 25 | TCP | SMTP |
| 53 | TCP/UDP | DNS |
| 80 | TCP | HTTP |
| 443 | TCP | HTTPS |
| 3306 | TCP | MySQL |
| 6379 | TCP | Redis |

## UDP 协议

### UDP vs TCP

| 特性 | TCP | UDP |
|------|-----|-----|
| 连接 | 面向连接 | 无连接 |
| 可靠性 | 可靠 | 不可靠 |
| 顺序 | 保证顺序 | 不保证 |
| 速度 | 较慢 | 较快 |
| 用途 | 文件传输、网页 | 视频流、游戏 |

### UDP 头部

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
├─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┤
│          源端口 (16 位)         │        目标端口 (16 位)       │
├───────────────────────────────┼───────────────────────────────┤
│           长度 (16 位)          │        校验和 (16 位)         │
└───────────────────────────────┴───────────────────────────────┘
```

## 网络诊断工具

### ping

```bash
# 测试连通性
ping 8.8.8.8
ping -c 4 google.com    # 发送 4 个包
```

### traceroute

```bash
# 追踪路由路径
traceroute google.com
tracepath google.com
```

### netstat

```bash
# 查看网络连接
netstat -tuln          # TCP/UDP 监听端口
netstat -anp           # 所有连接及进程
```

### ss

```bash
# 现代 netstat 替代
ss -tuln               # 监听端口
ss -s                  # 统计信息
```

### tcpdump

```bash
# 抓包分析
tcpdump -i eth0                    # 指定网卡
tcpdump -i eth0 port 80            # 指定端口
tcpdump -i eth0 host 192.168.1.1   # 指定主机
tcpdump -w capture.pcap            # 保存到文件
```

### curl

```bash
# HTTP 请求测试
curl http://example.com
curl -I http://example.com         # 仅头部
curl -X POST -d "data" http://api  # POST 请求
```

## 总结

TCP/IP 是互联网的基础：

1. **IP** 负责寻址和路由
2. **TCP** 提供可靠的端到端传输
3. **UDP** 提供快速但不可靠的传输
4. 理解分层模型有助于排查网络问题

掌握常用诊断工具，能快速定位网络故障。
