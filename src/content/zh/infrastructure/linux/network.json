{
  "meta": {
    "title": "Linux 网络",
    "description": "Linux 网络栈：配置、诊断与性能调优",
    "order": 5,
    "tags": ["Linux", "网络", "iptables", "网络调优"]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "核心概念",
      "items": [
        "Linux 网络栈实现完整的 TCP/IP 协议",
        "Netfilter 框架提供包过滤能力",
        "iproute2 是现代网络配置工具集",
        "内核参数调优优化网络性能"
      ]
    },
    {
      "type": "flow",
      "title": "Linux 网络栈",
      "direction": "vertical",
      "steps": [
        { "label": "应用程序", "description": "Socket API", "color": "bg-blue-500" },
        { "label": "传输层", "description": "TCP/UDP", "color": "bg-cyan-500" },
        { "label": "网络层", "description": "IP/路由/Netfilter", "color": "bg-purple-500" },
        { "label": "链路层", "description": "ARP/网桥", "color": "bg-amber-500" },
        { "label": "设备驱动", "description": "网卡驱动", "color": "bg-orange-500" },
        { "label": "硬件", "description": "NIC", "color": "bg-gray-500" }
      ]
    },
    {
      "type": "codeBlock",
      "title": "网络配置 (iproute2)",
      "language": "bash",
      "code": "# 查看网络接口\nip link show\nip addr show\nip -s link   # 带统计信息\n\n# 配置 IP 地址\nip addr add 192.168.1.10/24 dev eth0\nip addr del 192.168.1.10/24 dev eth0\n\n# 启用/禁用接口\nip link set eth0 up\nip link set eth0 down\n\n# 路由管理\nip route show\nip route add 10.0.0.0/8 via 192.168.1.1\nip route add default via 192.168.1.1\n\n# ARP 表\nip neigh show\nip neigh add 192.168.1.1 lladdr aa:bb:cc:dd:ee:ff dev eth0"
    },
    {
      "type": "cards",
      "title": "Netfilter/iptables",
      "layout": "grid",
      "columns": 3,
      "items": [
        {
          "title": "filter 表",
          "badge": "过滤",
          "badgeColor": "blue",
          "points": [
            "INPUT 入站",
            "OUTPUT 出站",
            "FORWARD 转发",
            "默认表"
          ]
        },
        {
          "title": "nat 表",
          "badge": "转换",
          "badgeColor": "green",
          "points": [
            "PREROUTING DNAT",
            "POSTROUTING SNAT",
            "OUTPUT 本地",
            "地址转换"
          ]
        },
        {
          "title": "mangle 表",
          "badge": "修改",
          "badgeColor": "amber",
          "points": [
            "修改数据包",
            "TTL/TOS/Mark",
            "QoS 标记",
            "高级用途"
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "iptables 常用规则",
      "language": "bash",
      "code": "# 查看规则\niptables -L -n -v\niptables -t nat -L -n\n\n# 允许/拒绝规则\niptables -A INPUT -p tcp --dport 22 -j ACCEPT\niptables -A INPUT -p tcp --dport 80 -j ACCEPT\niptables -A INPUT -j DROP\n\n# NAT 规则\n# SNAT (内网访问外网)\niptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE\n\n# DNAT (端口转发)\niptables -t nat -A PREROUTING -p tcp --dport 8080 -j DNAT --to 192.168.1.10:80\n\n# 保存规则\niptables-save > /etc/iptables.rules\niptables-restore < /etc/iptables.rules"
    },
    {
      "type": "codeBlock",
      "title": "网络诊断工具",
      "language": "bash",
      "code": "# 连通性测试\nping -c 4 8.8.8.8\ntraceroute 8.8.8.8\nmtr 8.8.8.8\n\n# 端口测试\ntelnet 192.168.1.1 80\nnc -zv 192.168.1.1 80\nss -tlnp                  # 监听端口\nss -antp                  # 所有 TCP 连接\n\n# DNS 诊断\ndig example.com\nnslookup example.com\n\n# 抓包\ntcpdump -i eth0 -n port 80\ntcpdump -i any -w capture.pcap"
    },
    {
      "type": "table",
      "title": "网络内核参数",
      "highlightFirst": true,
      "headers": ["参数", "默认", "说明"],
      "rows": [
        ["net.ipv4.ip_forward", "0", "开启 IP 转发"],
        ["net.core.somaxconn", "128", "Socket 监听队列"],
        ["net.ipv4.tcp_max_syn_backlog", "128", "SYN 队列大小"],
        ["net.core.netdev_max_backlog", "1000", "网卡接收队列"],
        ["net.ipv4.tcp_tw_reuse", "0", "TIME_WAIT 复用"],
        ["net.ipv4.tcp_fin_timeout", "60", "FIN 超时时间"]
      ]
    },
    {
      "type": "codeBlock",
      "title": "网络性能调优",
      "language": "bash",
      "code": "# 高并发服务器优化\ncat >> /etc/sysctl.conf << EOF\n# 开启 TCP 连接复用\nnet.ipv4.tcp_tw_reuse = 1\n\n# 增大连接队列\nnet.core.somaxconn = 65535\nnet.ipv4.tcp_max_syn_backlog = 65535\nnet.core.netdev_max_backlog = 65535\n\n# 增大端口范围\nnet.ipv4.ip_local_port_range = 1024 65535\n\n# 增大 TCP 缓冲区\nnet.core.rmem_max = 16777216\nnet.core.wmem_max = 16777216\nnet.ipv4.tcp_rmem = 4096 87380 16777216\nnet.ipv4.tcp_wmem = 4096 65536 16777216\n\n# 开启 TCP Fast Open\nnet.ipv4.tcp_fastopen = 3\nEOF\n\nsysctl -p"
    },
    {
      "type": "cards",
      "title": "网络命名空间与虚拟化",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "Network Namespace",
          "badge": "隔离",
          "badgeColor": "blue",
          "points": [
            "独立网络栈",
            "容器网络基础",
            "ip netns 管理"
          ]
        },
        {
          "title": "虚拟网络设备",
          "badge": "虚拟",
          "badgeColor": "green",
          "points": [
            "veth pair 对",
            "bridge 网桥",
            "tun/tap 设备"
          ]
        }
      ]
    },
    {
      "type": "list",
      "title": "网络最佳实践",
      "style": "check",
      "items": [
        { "label": "使用 iproute2", "description": "取代 ifconfig/route 等旧工具" },
        { "label": "合理配置防火墙", "description": "最小权限原则" },
        { "label": "调优内核参数", "description": "根据场景优化 TCP 栈" },
        { "label": "启用 TCP Fast Open", "description": "减少握手延迟" }
      ]
    }
  ],
  "relatedTopics": ["Linux 内核", "网络安全", "性能调优"]
}
