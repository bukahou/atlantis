{
  "meta": {
    "title": "内存管理",
    "description": "Linux 内存管理：虚拟内存、页面缓存与 OOM",
    "order": 3,
    "tags": ["Linux", "内存", "虚拟内存", "OOM"]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "核心概念",
      "items": [
        "虚拟内存为每个进程提供独立地址空间",
        "页面 (Page) 是内存管理的基本单位 (通常 4KB)",
        "Page Cache 缓存磁盘数据加速 I/O",
        "OOM Killer 在内存耗尽时终止进程"
      ]
    },
    {
      "type": "flow",
      "title": "虚拟内存到物理内存",
      "direction": "horizontal",
      "steps": [
        { "label": "虚拟地址", "description": "进程地址空间", "color": "bg-blue-500" },
        { "label": "MMU", "description": "地址转换", "color": "bg-purple-500" },
        { "label": "页表", "description": "Page Table", "color": "bg-cyan-500" },
        { "label": "物理地址", "description": "RAM/Swap", "color": "bg-green-500" }
      ]
    },
    {
      "type": "cards",
      "title": "进程内存布局",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "代码段 (Text)",
          "badge": "只读",
          "badgeColor": "gray",
          "points": [
            "可执行指令",
            "只读，共享",
            "从 ELF 文件加载"
          ]
        },
        {
          "title": "数据段 (Data/BSS)",
          "badge": "读写",
          "badgeColor": "blue",
          "points": [
            "已初始化全局变量",
            "未初始化变量 (BSS)",
            "进程私有"
          ]
        },
        {
          "title": "堆 (Heap)",
          "badge": "动态",
          "badgeColor": "green",
          "points": [
            "malloc/free 分配",
            "向高地址增长",
            "brk/mmap 管理"
          ]
        },
        {
          "title": "栈 (Stack)",
          "badge": "自动",
          "badgeColor": "amber",
          "points": [
            "函数调用、局部变量",
            "向低地址增长",
            "自动管理"
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "内存信息查看",
      "language": "bash",
      "code": "# 系统内存\nfree -h                   # 总体内存使用\ncat /proc/meminfo         # 详细信息\nvmstat 1 5                # 动态监控\n\n# 进程内存\nps aux --sort=-%mem | head  # 按内存排序\npmap -x <pid>               # 进程内存映射\ncat /proc/<pid>/status | grep -i mem\ncat /proc/<pid>/smaps       # 详细内存映射\n\n# 内存统计\nsar -r 1 5                # 内存使用率\nsmem -tk                  # 按进程统计"
    },
    {
      "type": "table",
      "title": "/proc/meminfo 关键字段",
      "highlightFirst": true,
      "headers": ["字段", "说明"],
      "rows": [
        ["MemTotal", "物理内存总量"],
        ["MemFree", "空闲物理内存"],
        ["MemAvailable", "可用内存 (含可回收缓存)"],
        ["Buffers", "块设备缓冲区"],
        ["Cached", "Page Cache 缓存"],
        ["SwapTotal", "Swap 空间总量"],
        ["SwapFree", "Swap 空闲空间"],
        ["Dirty", "等待写回磁盘的脏页"]
      ]
    },
    {
      "type": "comparison",
      "title": "Page Cache vs Buffer Cache",
      "columns": [
        {
          "title": "Page Cache",
          "color": "from-blue-500 to-cyan-500",
          "items": [
            { "label": "缓存对象", "description": "文件数据" },
            { "label": "单位", "description": "页面 (Page)" },
            { "label": "用途", "description": "加速文件 I/O" },
            { "label": "查看", "description": "Cached in meminfo" }
          ]
        },
        {
          "title": "Buffer Cache",
          "color": "from-green-500 to-emerald-500",
          "items": [
            { "label": "缓存对象", "description": "块设备元数据" },
            { "label": "单位", "description": "块 (Block)" },
            { "label": "用途", "description": "加速块设备访问" },
            { "label": "查看", "description": "Buffers in meminfo" }
          ]
        }
      ]
    },
    {
      "type": "cards",
      "title": "内存回收机制",
      "layout": "grid",
      "columns": 3,
      "items": [
        {
          "title": "Page Reclaim",
          "badge": "回收",
          "badgeColor": "blue",
          "points": [
            "LRU 算法",
            "回收不活跃页面",
            "kswapd 后台回收"
          ]
        },
        {
          "title": "Swap",
          "badge": "交换",
          "badgeColor": "amber",
          "points": [
            "匿名页面换出",
            "扩展可用内存",
            "swappiness 控制"
          ]
        },
        {
          "title": "OOM Killer",
          "badge": "保护",
          "badgeColor": "red",
          "points": [
            "内存耗尽时触发",
            "选择进程终止",
            "oom_score 评分"
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "Swap 管理",
      "language": "bash",
      "code": "# 查看 Swap\nswapon --show\nfree -h\n\n# 创建 Swap 文件\ndd if=/dev/zero of=/swapfile bs=1G count=4\nchmod 600 /swapfile\nmkswap /swapfile\nswapon /swapfile\n\n# 永久挂载 (/etc/fstab)\n/swapfile none swap sw 0 0\n\n# 调整 swappiness (0-100)\nsysctl vm.swappiness=10\necho 'vm.swappiness=10' >> /etc/sysctl.conf"
    },
    {
      "type": "codeBlock",
      "title": "OOM 相关配置",
      "language": "bash",
      "code": "# 查看进程 OOM 分数\ncat /proc/<pid>/oom_score\ncat /proc/<pid>/oom_score_adj   # 调整值 (-1000 到 1000)\n\n# 保护重要进程 (降低被杀概率)\necho -1000 > /proc/<pid>/oom_score_adj\n\n# 查看 OOM 日志\ndmesg | grep -i 'oom\\|killed'\njournalctl -k | grep -i oom\n\n# 内存过量使用策略\n# 0: 启发式 (默认), 1: 总是允许, 2: 严格限制\nsysctl vm.overcommit_memory"
    },
    {
      "type": "table",
      "title": "内存调优参数",
      "highlightFirst": true,
      "headers": ["参数", "默认", "说明"],
      "rows": [
        ["vm.swappiness", "60", "Swap 使用倾向 (0-100)"],
        ["vm.dirty_ratio", "20", "脏页占比阈值，触发同步写"],
        ["vm.dirty_background_ratio", "10", "后台写回阈值"],
        ["vm.vfs_cache_pressure", "100", "缓存回收倾向"],
        ["vm.min_free_kbytes", "varies", "保留最小空闲内存"]
      ]
    },
    {
      "type": "list",
      "title": "内存优化建议",
      "style": "check",
      "items": [
        { "label": "监控 MemAvailable", "description": "比 MemFree 更准确反映可用内存" },
        { "label": "合理设置 Swap", "description": "SSD 上可设置较小 Swap" },
        { "label": "调整 swappiness", "description": "数据库服务器建议设为 10" },
        { "label": "保护关键进程", "description": "设置 oom_score_adj=-1000" },
        { "label": "使用大页", "description": "HugePages 减少 TLB 缓存压力" }
      ]
    }
  ],
  "relatedTopics": ["Linux 内核", "进程管理", "性能调优"]
}
