{
  "meta": {
    "title": "JWT",
    "description": "令牌结构、签名与安全使用",
    "order": 2,
    "tags": ["JWT", "令牌", "认证"]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "核心概念",
      "items": [
        "JWT = Header.Payload.Signature 三部分组成",
        "自包含：令牌本身携带用户信息",
        "无状态：服务端不需存储会话",
        "签名保证完整性，但不加密内容"
      ]
    },
    {
      "type": "codeBlock",
      "title": "JWT 结构解析",
      "language": "text",
      "code": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.\neyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4iLCJpYXQiOjE1MTYyMzkwMjJ9.\nSflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c\n\n┌─────────────────────────────────────────────────────────────┐\n│ Header (算法和类型)                                          │\n├─────────────────────────────────────────────────────────────┤\n│ {                                                           │\n│   \"alg\": \"HS256\",    // 签名算法                            │\n│   \"typ\": \"JWT\"       // 令牌类型                            │\n│ }                                                           │\n├─────────────────────────────────────────────────────────────┤\n│ Payload (声明/Claims)                                        │\n├─────────────────────────────────────────────────────────────┤\n│ {                                                           │\n│   \"sub\": \"1234567890\",  // 主题（用户ID）                   │\n│   \"name\": \"John\",       // 自定义声明                       │\n│   \"iat\": 1516239022,    // 签发时间                         │\n│   \"exp\": 1516242622,    // 过期时间                         │\n│   \"iss\": \"auth.example.com\"  // 签发者                      │\n│ }                                                           │\n├─────────────────────────────────────────────────────────────┤\n│ Signature                                                   │\n├─────────────────────────────────────────────────────────────┤\n│ HMACSHA256(                                                 │\n│   base64UrlEncode(header) + \".\" + base64UrlEncode(payload), │\n│   secret                                                    │\n│ )                                                           │\n└─────────────────────────────────────────────────────────────┘"
    },
    {
      "type": "comparison",
      "title": "对称签名 vs 非对称签名",
      "columns": [
        {
          "title": "HS256 (HMAC)",
          "color": "from-blue-500 to-indigo-500",
          "items": [
            { "label": "密钥", "description": "共享密钥" },
            { "label": "签名/验证", "description": "同一密钥" },
            { "label": "适用", "description": "单服务、内部系统" }
          ]
        },
        {
          "title": "RS256 (RSA)",
          "color": "from-green-500 to-teal-500",
          "items": [
            { "label": "密钥", "description": "公私钥对" },
            { "label": "签名/验证", "description": "私钥签名/公钥验证" },
            { "label": "适用", "description": "分布式、微服务" }
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "JWT 签发与验证",
      "language": "typescript",
      "code": "import jwt from 'jsonwebtoken';\n\nconst SECRET = process.env.JWT_SECRET!;\nconst EXPIRES_IN = '15m';\n\n// 签发 Access Token\nfunction signAccessToken(user: User): string {\n  return jwt.sign(\n    {\n      sub: user.id,\n      email: user.email,\n      roles: user.roles,\n    },\n    SECRET,\n    {\n      expiresIn: EXPIRES_IN,\n      issuer: 'auth.example.com',\n      audience: 'api.example.com',\n    }\n  );\n}\n\n// 验证 Token\nfunction verifyToken(token: string): JwtPayload {\n  try {\n    return jwt.verify(token, SECRET, {\n      issuer: 'auth.example.com',\n      audience: 'api.example.com',\n    }) as JwtPayload;\n  } catch (error) {\n    if (error instanceof jwt.TokenExpiredError) {\n      throw new AuthError('Token expired');\n    }\n    if (error instanceof jwt.JsonWebTokenError) {\n      throw new AuthError('Invalid token');\n    }\n    throw error;\n  }\n}\n\n// Express 中间件\nfunction authMiddleware(req: Request, res: Response, next: NextFunction) {\n  const authHeader = req.headers.authorization;\n  if (!authHeader?.startsWith('Bearer ')) {\n    return res.status(401).json({ error: 'No token provided' });\n  }\n  \n  const token = authHeader.slice(7);\n  try {\n    req.user = verifyToken(token);\n    next();\n  } catch (error) {\n    return res.status(401).json({ error: error.message });\n  }\n}"
    },
    {
      "type": "table",
      "title": "标准声明 (Registered Claims)",
      "highlightFirst": true,
      "headers": ["声明", "名称", "说明"],
      "rows": [
        ["iss", "Issuer", "签发者"],
        ["sub", "Subject", "主题（通常是用户ID）"],
        ["aud", "Audience", "受众（API 标识）"],
        ["exp", "Expiration", "过期时间"],
        ["nbf", "Not Before", "生效时间"],
        ["iat", "Issued At", "签发时间"],
        ["jti", "JWT ID", "唯一标识（防重放）"]
      ]
    },
    {
      "type": "list",
      "title": "安全注意事项",
      "style": "check",
      "items": [
        { "label": "不存敏感信息", "description": "Payload 只是 Base64，任何人可解码" },
        { "label": "设置短过期时间", "description": "Access Token 建议 15分钟以内" },
        { "label": "验证所有声明", "description": "iss、aud、exp 都要验证" },
        { "label": "使用强密钥", "description": "HS256 至少 256 位，RS256 至少 2048 位" },
        { "label": "HTTPS 传输", "description": "JWT 可能被截获，必须加密传输" }
      ]
    }
  ],
  "relatedTopics": ["OAuth", "Session", "刷新令牌"]
}
