{
  "meta": {
    "title": "ELK 全栈",
    "description": "Elasticsearch + Logstash + Kibana 日志分析平台",
    "order": 4,
    "tags": ["ELK", "Elasticsearch", "Logstash", "Kibana", "日志"]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "核心概念",
      "items": [
        "ELK 是开源的日志收集、存储、分析和可视化平台",
        "Elasticsearch 负责存储和搜索",
        "Logstash 负责日志收集和处理",
        "Kibana 提供可视化界面"
      ]
    },
    {
      "type": "flow",
      "title": "数据流向",
      "direction": "horizontal",
      "steps": [
        { "label": "数据源", "description": "应用/系统日志", "color": "bg-gray-500" },
        { "label": "Beats", "description": "轻量采集器", "color": "bg-blue-500" },
        { "label": "Logstash", "description": "处理转换", "color": "bg-yellow-500" },
        { "label": "Elasticsearch", "description": "存储索引", "color": "bg-green-500" },
        { "label": "Kibana", "description": "可视化", "color": "bg-purple-500" }
      ]
    },
    {
      "type": "cards",
      "title": "核心组件",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "Elasticsearch",
          "badge": "存储",
          "badgeColor": "green",
          "points": [
            "分布式搜索引擎",
            "倒排索引，全文检索",
            "RESTful API",
            "水平扩展"
          ]
        },
        {
          "title": "Logstash",
          "badge": "处理",
          "badgeColor": "yellow",
          "points": [
            "数据收集管道",
            "Input → Filter → Output",
            "丰富的插件生态",
            "数据转换清洗"
          ]
        },
        {
          "title": "Kibana",
          "badge": "可视化",
          "badgeColor": "purple",
          "points": [
            "数据可视化平台",
            "Dashboard 仪表盘",
            "Discover 日志探索",
            "Lens 拖拽图表"
          ]
        },
        {
          "title": "Beats",
          "badge": "采集",
          "badgeColor": "blue",
          "points": [
            "轻量级数据采集器",
            "Filebeat 文件日志",
            "Metricbeat 指标",
            "Packetbeat 网络"
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "Docker Compose 部署",
      "language": "yaml",
      "code": "version: '3.8'\nservices:\n  elasticsearch:\n    image: elasticsearch:8.11.0\n    environment:\n      - discovery.type=single-node\n      - xpack.security.enabled=false\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\n    ports:\n      - \"9200:9200\"\n    volumes:\n      - es-data:/usr/share/elasticsearch/data\n\n  logstash:\n    image: logstash:8.11.0\n    volumes:\n      - ./logstash.conf:/usr/share/logstash/pipeline/logstash.conf\n    depends_on:\n      - elasticsearch\n\n  kibana:\n    image: kibana:8.11.0\n    ports:\n      - \"5601:5601\"\n    environment:\n      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200\n    depends_on:\n      - elasticsearch\n\nvolumes:\n  es-data:"
    },
    {
      "type": "codeBlock",
      "title": "Logstash 配置",
      "language": "ruby",
      "code": "input {\n  beats {\n    port => 5044\n  }\n  # 或者直接读取文件\n  file {\n    path => \"/var/log/app/*.log\"\n    start_position => \"beginning\"\n  }\n}\n\nfilter {\n  # 解析 JSON 日志\n  json {\n    source => \"message\"\n  }\n  # 解析时间戳\n  date {\n    match => [\"timestamp\", \"ISO8601\"]\n    target => \"@timestamp\"\n  }\n  # Grok 解析非结构化日志\n  grok {\n    match => { \"message\" => \"%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{GREEDYDATA:msg}\" }\n  }\n  # 添加地理位置\n  geoip {\n    source => \"client_ip\"\n  }\n}\n\noutput {\n  elasticsearch {\n    hosts => [\"elasticsearch:9200\"]\n    index => \"logs-%{+YYYY.MM.dd}\"\n  }\n}"
    },
    {
      "type": "codeBlock",
      "title": "Filebeat 配置",
      "language": "yaml",
      "code": "filebeat.inputs:\n  - type: log\n    enabled: true\n    paths:\n      - /var/log/app/*.log\n    json.keys_under_root: true\n    json.add_error_key: true\n\n  - type: container\n    paths:\n      - /var/lib/docker/containers/*/*.log\n    processors:\n      - add_docker_metadata: ~\n\noutput.elasticsearch:\n  hosts: [\"elasticsearch:9200\"]\n  index: \"filebeat-%{+yyyy.MM.dd}\"\n\n# 或输出到 Logstash\noutput.logstash:\n  hosts: [\"logstash:5044\"]"
    },
    {
      "type": "codeBlock",
      "title": "Elasticsearch 查询",
      "language": "json",
      "code": "// 搜索日志\nGET /logs-*/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        { \"match\": { \"level\": \"ERROR\" } },\n        { \"range\": { \"@timestamp\": { \"gte\": \"now-1h\" } } }\n      ]\n    }\n  },\n  \"sort\": [{ \"@timestamp\": \"desc\" }],\n  \"size\": 100\n}\n\n// 聚合统计\nGET /logs-*/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"errors_over_time\": {\n      \"date_histogram\": {\n        \"field\": \"@timestamp\",\n        \"fixed_interval\": \"5m\"\n      },\n      \"aggs\": {\n        \"error_count\": {\n          \"filter\": { \"term\": { \"level\": \"ERROR\" } }\n        }\n      }\n    }\n  }\n}"
    },
    {
      "type": "table",
      "title": "Beats 家族",
      "highlightFirst": true,
      "headers": ["Beat", "用途", "数据源"],
      "rows": [
        ["Filebeat", "日志文件", "文件、容器日志"],
        ["Metricbeat", "系统指标", "CPU、内存、磁盘"],
        ["Packetbeat", "网络数据", "HTTP、MySQL、Redis"],
        ["Heartbeat", "可用性监控", "URL、TCP、ICMP"],
        ["Auditbeat", "审计数据", "系统审计日志"]
      ]
    },
    {
      "type": "comparison",
      "title": "索引生命周期",
      "columns": [
        {
          "title": "Hot",
          "color": "from-red-500 to-orange-500",
          "items": [
            { "label": "用途", "description": "活跃写入查询" },
            { "label": "存储", "description": "SSD 高性能" },
            { "label": "保留", "description": "1-7 天" }
          ]
        },
        {
          "title": "Warm",
          "color": "from-amber-500 to-yellow-500",
          "items": [
            { "label": "用途", "description": "偶尔查询" },
            { "label": "存储", "description": "HDD" },
            { "label": "保留", "description": "7-30 天" }
          ]
        },
        {
          "title": "Cold/Delete",
          "color": "from-blue-500 to-cyan-500",
          "items": [
            { "label": "用途", "description": "归档/删除" },
            { "label": "存储", "description": "对象存储" },
            { "label": "保留", "description": ">30 天" }
          ]
        }
      ]
    },
    {
      "type": "list",
      "title": "最佳实践",
      "style": "check",
      "items": [
        { "label": "索引模板", "description": "定义 mapping 和 settings 模板" },
        { "label": "ILM 策略", "description": "索引生命周期管理，自动滚动删除" },
        { "label": "分片规划", "description": "单分片 10-50GB，避免过多分片" },
        { "label": "结构化日志", "description": "使用 JSON 格式便于解析" },
        { "label": "安全加固", "description": "启用 TLS 和 RBAC 认证" }
      ]
    }
  ],
  "relatedTopics": ["Prometheus", "Grafana", "日志管理", "可观测性"]
}
