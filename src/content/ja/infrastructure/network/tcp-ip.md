---
title: TCP/IP プロトコル基礎
description: ネットワーク通信の核心プロトコルスタックを理解する
order: 1
tags:
  - network
  - tcp
  - ip
  - protocol
---

# TCP/IP プロトコル基礎

## ネットワーク階層モデル

### OSI 7層 vs TCP/IP 4層

```
OSI モデル            TCP/IP モデル        プロトコル例
┌─────────────┐      ┌─────────────┐
│ アプリケーション層│      │             │       HTTP, FTP, DNS
├─────────────┤      │アプリケーション層│       SMTP, SSH, HTTPS
│ プレゼンテーション層│      │             │
├─────────────┤      ├─────────────┤
│  セッション層  │      │             │
├─────────────┤      ├─────────────┤
│  トランスポート層 │      │トランスポート層│       TCP, UDP
├─────────────┤      ├─────────────┤
│  ネットワーク層  │      │ネットワーク層 │       IP, ICMP, ARP
├─────────────┤      ├─────────────┤
│ データリンク層  │      │             │       Ethernet, Wi-Fi
├─────────────┤      │ネットワークインターフェース層│
│   物理層     │      │             │
└─────────────┘      └─────────────┘
```

## IP プロトコル

### IPv4 アドレス

```
32 ビットアドレス、ドット区切り10進数表記

192.168.1.100

┌────────┬────────┬────────┬────────┐
│   192  │   168  │    1   │   100  │
├────────┴────────┴────────┴────────┤
│  11000000.10101000.00000001.01100100
└───────────────────────────────────┘
```

### IP アドレス分類

| クラス | 範囲 | デフォルトマスク | 用途 |
|--------|------|-----------------|------|
| A | 1.0.0.0 - 126.255.255.255 | 255.0.0.0 | 大規模ネットワーク |
| B | 128.0.0.0 - 191.255.255.255 | 255.255.0.0 | 中規模ネットワーク |
| C | 192.0.0.0 - 223.255.255.255 | 255.255.255.0 | 小規模ネットワーク |

### プライベートアドレス

```
10.0.0.0    - 10.255.255.255   (クラス A)
172.16.0.0  - 172.31.255.255   (クラス B)
192.168.0.0 - 192.168.255.255  (クラス C)
```

### サブネット分割

```bash
# CIDR 表記
192.168.1.0/24

# サブネットマスク
255.255.255.0

# 計算
ネットワークアドレス: 192.168.1.0
ブロードキャストアドレス: 192.168.1.255
使用可能ホスト: 192.168.1.1 - 192.168.1.254 (254 個)
```

## TCP プロトコル

### TCP の特徴

- **コネクション指向**: 通信前に接続を確立
- **信頼性のある伝送**: データの完全性と順序を保証
- **フロー制御**: 送信速度を調整
- **輻輳制御**: ネットワーク状況に適応

### 3ウェイハンドシェイク

```
クライアント                      サーバー
   │                              │
   │  ─────── SYN (seq=x) ──────> │  1. クライアントが接続開始
   │                              │
   │  <── SYN+ACK (seq=y,ack=x+1) │  2. サーバーが確認と同期
   │                              │
   │  ─────── ACK (ack=y+1) ────> │  3. クライアントが確認
   │                              │
   │        接続確立               │
```

### 4ウェイハンドシェイク

```
クライアント                      サーバー
   │                              │
   │  ─────── FIN (seq=u) ──────> │  1. クライアントが切断要求
   │                              │
   │  <────── ACK (ack=u+1) ───── │  2. サーバーが確認
   │                              │
   │  <────── FIN (seq=v) ─────── │  3. サーバーが切断要求
   │                              │
   │  ─────── ACK (ack=v+1) ────> │  4. クライアントが確認
   │                              │
   │        接続終了               │
```

### TCP ヘッダー

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
├─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┤
│         送信元ポート (16 bit)    │       宛先ポート (16 bit)     │
├───────────────────────────────┴───────────────────────────────┤
│                      シーケンス番号 (32 bit)                    │
├───────────────────────────────────────────────────────────────┤
│                        確認応答番号 (32 bit)                    │
├───────┬───────┬─┬─┬─┬─┬─┬─┬───────────────────────────────────┤
│ヘッダ長│ 予約  │U│A│P│R│S│F│       ウィンドウサイズ (16 bit)   │
├───────┴───────┴─┴─┴─┴─┴─┴─┴───────────────────────────────────┤
│        チェックサム (16 bit)     │      緊急ポインタ (16 bit)    │
└───────────────────────────────┴───────────────────────────────┘
```

### よく使うポート

| ポート | プロトコル | サービス |
|--------|-----------|----------|
| 20/21 | TCP | FTP |
| 22 | TCP | SSH |
| 23 | TCP | Telnet |
| 25 | TCP | SMTP |
| 53 | TCP/UDP | DNS |
| 80 | TCP | HTTP |
| 443 | TCP | HTTPS |
| 3306 | TCP | MySQL |
| 6379 | TCP | Redis |

## UDP プロトコル

### UDP vs TCP

| 特性 | TCP | UDP |
|------|-----|-----|
| 接続 | コネクション指向 | コネクションレス |
| 信頼性 | 信頼性あり | 信頼性なし |
| 順序 | 順序保証 | 順序保証なし |
| 速度 | 遅め | 速い |
| 用途 | ファイル転送、Web | 動画ストリーミング、ゲーム |

### UDP ヘッダー

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
├─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┤
│         送信元ポート (16 bit)    │       宛先ポート (16 bit)     │
├───────────────────────────────┼───────────────────────────────┤
│          長さ (16 bit)          │      チェックサム (16 bit)    │
└───────────────────────────────┴───────────────────────────────┘
```

## ネットワーク診断ツール

### ping

```bash
# 疎通確認
ping 8.8.8.8
ping -c 4 google.com    # 4 パケット送信
```

### traceroute

```bash
# ルート経路を追跡
traceroute google.com
tracepath google.com
```

### netstat

```bash
# ネットワーク接続を確認
netstat -tuln          # TCP/UDP リスニングポート
netstat -anp           # すべての接続とプロセス
```

### ss

```bash
# 現代的な netstat 代替
ss -tuln               # リスニングポート
ss -s                  # 統計情報
```

### tcpdump

```bash
# パケットキャプチャ
tcpdump -i eth0                    # インターフェース指定
tcpdump -i eth0 port 80            # ポート指定
tcpdump -i eth0 host 192.168.1.1   # ホスト指定
tcpdump -w capture.pcap            # ファイルに保存
```

### curl

```bash
# HTTP リクエストテスト
curl http://example.com
curl -I http://example.com         # ヘッダーのみ
curl -X POST -d "data" http://api  # POST リクエスト
```

## まとめ

TCP/IP はインターネットの基盤です：

1. **IP** はアドレッシングとルーティングを担当
2. **TCP** は信頼性のあるエンドツーエンド伝送を提供
3. **UDP** は高速だが信頼性のない伝送を提供
4. 階層モデルの理解はネットワーク問題の切り分けに役立つ

よく使う診断ツールをマスターすれば、ネットワーク障害を素早く特定できます。
