{
  "meta": {
    "title": "スケジューリング戦略",
    "description": "Kubernetes スケジューリング：Label/Selector、Affinity、Taint/Toleration",
    "order": 6,
    "tags": ["Kubernetes", "スケジューリング", "Affinity", "Taint", "Toleration"]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "コアコンセプト",
      "items": [
        "Label/Selector はリソースの分類と選択に使用",
        "Node Affinity は Pod を特定のノードにスケジュール",
        "Pod Affinity/Anti-Affinity は Pod 間の親和性を制御",
        "Taint/Toleration は Pod のノードへのスケジューリングを阻止または許可"
      ]
    },
    {
      "type": "cards",
      "title": "スケジューリングメカニズム",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "Label & Selector",
          "badge": "基本",
          "badgeColor": "blue",
          "points": [
            "キーバリューペアラベル",
            "リソースの分類とフィルタリング",
            "Service の Pod 選択",
            "Deployment の Pod 管理"
          ]
        },
        {
          "title": "Node Affinity",
          "badge": "ノード親和性",
          "badgeColor": "green",
          "points": [
            "Pod を特定のノードにスケジュール",
            "required: 必須条件",
            "preferred: 優先条件",
            "nodeSelector の後継"
          ]
        },
        {
          "title": "Pod Affinity",
          "badge": "Pod 親和性",
          "badgeColor": "amber",
          "points": [
            "Pod 間の親和性",
            "同じノード/ゾーンにデプロイ",
            "Anti-Affinity で分散デプロイ",
            "高可用性とパフォーマンス最適化"
          ]
        },
        {
          "title": "Taint & Toleration",
          "badge": "Taint 許容",
          "badgeColor": "red",
          "points": [
            "ノードが Pod を拒否",
            "Toleration でスケジューリングを許可",
            "専用ノードの分離",
            "GPU/SSD ノードの保護"
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "Label と Selector",
      "language": "yaml",
      "code": "# ノードに Label を追加\n# kubectl label nodes node-1 disktype=ssd\n# kubectl label nodes node-2 gpu=nvidia\n\n# Pod で nodeSelector を使用（シンプルな方法）\napiVersion: v1\nkind: Pod\nmetadata:\n  name: gpu-pod\nspec:\n  nodeSelector:\n    gpu: nvidia\n  containers:\n  - name: cuda-app\n    image: cuda-app:v1\n---\n# Service で Selector を使用\napiVersion: v1\nkind: Service\nmetadata:\n  name: web-service\nspec:\n  selector:\n    app: web\n    tier: frontend\n  ports:\n  - port: 80"
    },
    {
      "type": "codeBlock",
      "title": "Node Affinity",
      "language": "yaml",
      "code": "apiVersion: v1\nkind: Pod\nmetadata:\n  name: nginx\nspec:\n  affinity:\n    nodeAffinity:\n      # 必須条件\n      requiredDuringSchedulingIgnoredDuringExecution:\n        nodeSelectorTerms:\n        - matchExpressions:\n          - key: disktype\n            operator: In\n            values:\n            - ssd\n            - nvme\n      # 優先条件\n      preferredDuringSchedulingIgnoredDuringExecution:\n      - weight: 80\n        preference:\n          matchExpressions:\n          - key: zone\n            operator: In\n            values:\n            - zone-a\n      - weight: 20\n        preference:\n          matchExpressions:\n          - key: zone\n            operator: In\n            values:\n            - zone-b\n  containers:\n  - name: nginx\n    image: nginx\n\n# 演算子: In, NotIn, Exists, DoesNotExist, Gt, Lt"
    },
    {
      "type": "codeBlock",
      "title": "Pod Affinity / Anti-Affinity",
      "language": "yaml",
      "code": "apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: web-server\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: web\n  template:\n    metadata:\n      labels:\n        app: web\n    spec:\n      affinity:\n        # Pod 親和性: cache Pod と同じノードにデプロイ\n        podAffinity:\n          requiredDuringSchedulingIgnoredDuringExecution:\n          - labelSelector:\n              matchLabels:\n                app: cache\n            topologyKey: kubernetes.io/hostname\n        # Pod 反親和性: web Pod が同じノードに配置されないように\n        podAntiAffinity:\n          preferredDuringSchedulingIgnoredDuringExecution:\n          - weight: 100\n            podAffinityTerm:\n              labelSelector:\n                matchLabels:\n                  app: web\n              topologyKey: kubernetes.io/hostname\n      containers:\n      - name: web\n        image: nginx\n\n# topologyKey の一般的な値:\n# kubernetes.io/hostname  - ノードレベル\n# topology.kubernetes.io/zone - アベイラビリティゾーンレベル\n# topology.kubernetes.io/region - リージョンレベル"
    },
    {
      "type": "codeBlock",
      "title": "Taint と Toleration",
      "language": "yaml",
      "code": "# ノードに Taint を追加\n# kubectl taint nodes node-1 dedicated=gpu:NoSchedule\n# kubectl taint nodes node-2 maintenance=true:NoExecute\n\n# Taint 効果:\n# NoSchedule     - 新しい Pod をスケジュールしない\n# PreferNoSchedule - できるだけスケジュールしない\n# NoExecute      - 既存の Pod を退避\n\n# Pod に Toleration を追加\napiVersion: v1\nkind: Pod\nmetadata:\n  name: gpu-pod\nspec:\n  tolerations:\n  - key: \"dedicated\"\n    operator: \"Equal\"\n    value: \"gpu\"\n    effect: \"NoSchedule\"\n  # すべての NoSchedule を許容\n  - operator: \"Exists\"\n    effect: \"NoSchedule\"\n  # NoExecute を許容し、許容時間を設定\n  - key: \"maintenance\"\n    operator: \"Exists\"\n    effect: \"NoExecute\"\n    tolerationSeconds: 3600  # 1時間後に退避\n  containers:\n  - name: cuda-app\n    image: cuda-app:v1\n\n# Taint を削除\n# kubectl taint nodes node-1 dedicated=gpu:NoSchedule-"
    },
    {
      "type": "table",
      "title": "Taint Effect の効果",
      "highlightFirst": true,
      "headers": ["Effect", "説明", "ユースケース"],
      "rows": [
        ["NoSchedule", "新しい Pod のスケジューリングを禁止", "専用ノード (GPU/SSD)"],
        ["PreferNoSchedule", "できるだけスケジューリングを避ける", "非クリティカルな分離"],
        ["NoExecute", "実行中の Pod を退避", "ノードメンテナンス/障害"]
      ]
    },
    {
      "type": "codeBlock",
      "title": "トポロジー分散制約",
      "language": "yaml",
      "code": "# Pod を異なるゾーン/ノードに均等に分散\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: web\nspec:\n  replicas: 6\n  selector:\n    matchLabels:\n      app: web\n  template:\n    metadata:\n      labels:\n        app: web\n    spec:\n      topologySpreadConstraints:\n      - maxSkew: 1  # 最大不均衡数\n        topologyKey: topology.kubernetes.io/zone\n        whenUnsatisfiable: DoNotSchedule\n        labelSelector:\n          matchLabels:\n            app: web\n      - maxSkew: 1\n        topologyKey: kubernetes.io/hostname\n        whenUnsatisfiable: ScheduleAnyway\n        labelSelector:\n          matchLabels:\n            app: web\n      containers:\n      - name: web\n        image: nginx"
    },
    {
      "type": "list",
      "title": "スケジューリングベストプラクティス",
      "style": "check",
      "items": [
        { "label": "Anti-Affinity を使用", "description": "高可用性サービスを異なるノード/ゾーンに分散デプロイ" },
        { "label": "GPU ノードには Taint を使用", "description": "通常の Pod が GPU リソースを占有するのを防止" },
        { "label": "本番環境では requiredDuring を使用", "description": "重要なスケジューリングルールにはハード制約を使用" },
        { "label": "weight を適切に使用", "description": "preferredDuring で優先度の重みを設定" },
        { "label": "トポロジー分散制約", "description": "ゾーン間で高可用性デプロイ" }
      ]
    }
  ],
  "relatedTopics": ["Pod", "ノード管理", "高可用性", "リソース管理"]
}
