{
  "meta": {
    "title": "Service とネットワーク",
    "description": "Kubernetes ネットワーク：Service、Ingress と NetworkPolicy",
    "order": 2,
    "tags": ["Kubernetes", "Service", "Ingress", "NetworkPolicy"]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "コアコンセプト",
      "items": [
        "Service は安定したアクセスエンドポイントとロードバランシングを提供",
        "Ingress は HTTP/HTTPS ルーティングと TLS 終端を実現",
        "NetworkPolicy は Pod 間のネットワークトラフィックを制御",
        "CoreDNS はクラスター内サービスディスカバリを提供"
      ]
    },
    {
      "type": "comparison",
      "title": "Service タイプ",
      "columns": [
        {
          "title": "ClusterIP",
          "color": "from-blue-500 to-cyan-500",
          "items": [
            { "label": "範囲", "description": "クラスター内部アクセス" },
            { "label": "IP", "description": "仮想 ClusterIP" },
            { "label": "ユースケース", "description": "内部サービス通信" }
          ]
        },
        {
          "title": "NodePort",
          "color": "from-green-500 to-emerald-500",
          "items": [
            { "label": "範囲", "description": "ノード IP + ポート" },
            { "label": "ポート", "description": "30000-32767" },
            { "label": "ユースケース", "description": "開発テスト環境" }
          ]
        },
        {
          "title": "LoadBalancer",
          "color": "from-purple-500 to-pink-500",
          "items": [
            { "label": "範囲", "description": "外部ロードバランサー" },
            { "label": "IP", "description": "クラウドプロバイダーが割り当て" },
            { "label": "ユースケース", "description": "本番環境でのサービス公開" }
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "Service 設定例",
      "language": "yaml",
      "code": "# ClusterIP（デフォルト）\napiVersion: v1\nkind: Service\nmetadata:\n  name: web-service\nspec:\n  type: ClusterIP\n  selector:\n    app: web\n  ports:\n  - name: http\n    port: 80          # Service ポート\n    targetPort: 8080  # Pod ポート\n---\n# Headless Service（StatefulSet 用）\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql\nspec:\n  clusterIP: None  # Headless\n  selector:\n    app: mysql\n  ports:\n  - port: 3306\n# DNS: mysql-0.mysql.namespace.svc.cluster.local\n---\n# ExternalName（外部サービスプロキシ）\napiVersion: v1\nkind: Service\nmetadata:\n  name: external-db\nspec:\n  type: ExternalName\n  externalName: db.example.com"
    },
    {
      "type": "codeBlock",
      "title": "Ingress 設定",
      "language": "yaml",
      "code": "# Ingress Controller のインストールが必要（nginx/traefik など）\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: app-ingress\n  annotations:\n    nginx.ingress.kubernetes.io/ssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io/proxy-body-size: \"50m\"\nspec:\n  ingressClassName: nginx\n  tls:\n  - hosts:\n    - api.example.com\n    - web.example.com\n    secretName: tls-secret\n  rules:\n  # Host ベースルーティング\n  - host: api.example.com\n    http:\n      paths:\n      - path: /\n        pathType: Prefix\n        backend:\n          service:\n            name: api-service\n            port:\n              number: 80\n  - host: web.example.com\n    http:\n      paths:\n      # Path ベースルーティング\n      - path: /api\n        pathType: Prefix\n        backend:\n          service:\n            name: api-service\n            port:\n              number: 80\n      - path: /\n        pathType: Prefix\n        backend:\n          service:\n            name: frontend\n            port:\n              number: 80"
    },
    {
      "type": "table",
      "title": "Ingress Path タイプ",
      "highlightFirst": true,
      "headers": ["タイプ", "マッチングルール", "例"],
      "rows": [
        ["Exact", "完全一致", "/api は /api のみにマッチ"],
        ["Prefix", "前方一致", "/api は /api, /api/v1 にマッチ"],
        ["ImplementationSpecific", "コントローラー固有", "Ingress 実装に依存"]
      ]
    },
    {
      "type": "codeBlock",
      "title": "NetworkPolicy ネットワークポリシー",
      "language": "yaml",
      "code": "# デフォルトですべてのインバウンドトラフィックを拒否\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: default-deny-ingress\n  namespace: production\nspec:\n  podSelector: {}  # すべての Pod を選択\n  policyTypes:\n  - Ingress\n---\n# 特定のトラフィックを許可\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: api-policy\n  namespace: production\nspec:\n  podSelector:\n    matchLabels:\n      app: api\n  policyTypes:\n  - Ingress\n  - Egress\n  ingress:\n  # frontend からのトラフィックを許可\n  - from:\n    - podSelector:\n        matchLabels:\n          app: frontend\n    ports:\n    - protocol: TCP\n      port: 8080\n  # monitoring 名前空間からを許可\n  - from:\n    - namespaceSelector:\n        matchLabels:\n          name: monitoring\n  egress:\n  # データベースへのアクセスを許可\n  - to:\n    - podSelector:\n        matchLabels:\n          app: database\n    ports:\n    - protocol: TCP\n      port: 5432\n  # DNS クエリを許可\n  - to:\n    - namespaceSelector: {}\n    ports:\n    - protocol: UDP\n      port: 53"
    },
    {
      "type": "cards",
      "title": "ネットワーク機能",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "サービスディスカバリ (DNS)",
          "badge": "CoreDNS",
          "badgeColor": "blue",
          "points": [
            "<service>.<ns>.svc.cluster.local",
            "<pod-ip>.<ns>.pod.cluster.local",
            "自動 A/AAAA/SRV レコード"
          ]
        },
        {
          "title": "ロードバランシング",
          "badge": "kube-proxy",
          "badgeColor": "green",
          "points": [
            "iptables モード（デフォルト）",
            "IPVS モード（高性能）",
            "ラウンドロビン/最小接続数などの戦略"
          ]
        },
        {
          "title": "Ingress Controller",
          "badge": "HTTP",
          "badgeColor": "amber",
          "points": [
            "Nginx Ingress（最も人気）",
            "Traefik（クラウドネイティブ）",
            "AWS ALB / GCE"
          ]
        },
        {
          "title": "CNI ネットワークプラグイン",
          "badge": "CNI",
          "badgeColor": "purple",
          "points": [
            "Calico (NetworkPolicy)",
            "Cilium (eBPF)",
            "Flannel（シンプル）"
          ]
        }
      ]
    },
    {
      "type": "flow",
      "title": "トラフィックパス",
      "direction": "horizontal",
      "steps": [
        { "label": "Client", "description": "外部リクエスト", "color": "bg-gray-500" },
        { "label": "Ingress", "description": "HTTP ルーティング", "color": "bg-blue-500" },
        { "label": "Service", "description": "ロードバランシング", "color": "bg-cyan-500" },
        { "label": "Pod", "description": "ターゲットコンテナ", "color": "bg-green-500" }
      ]
    },
    {
      "type": "codeBlock",
      "title": "ネットワークデバッグ",
      "language": "bash",
      "code": "# Service を確認\nkubectl get svc\nkubectl describe svc <service-name>\nkubectl get endpoints <service-name>\n\n# Ingress を確認\nkubectl get ingress\nkubectl describe ingress <ingress-name>\n\n# NetworkPolicy を確認\nkubectl get networkpolicy -A\n\n# DNS デバッグ\nkubectl run tmp --image=busybox -it --rm -- nslookup <service-name>\n\n# ネットワーク接続性テスト\nkubectl run tmp --image=curlimages/curl -it --rm -- curl <service-name>:80"
    },
    {
      "type": "list",
      "title": "ネットワークベストプラクティス",
      "style": "check",
      "items": [
        { "label": "Ingress を使用", "description": "HTTP ルーティングを統一管理し、LoadBalancer コストを削減" },
        { "label": "NetworkPolicy を有効化", "description": "ゼロトラストネットワークを実装し、Pod 間通信を制限" },
        { "label": "Headless Service", "description": "StatefulSet シナリオでは clusterIP: None を使用" },
        { "label": "TLS 終端", "description": "Ingress レイヤーで TLS 証明書を統一管理" },
        { "label": "NetworkPolicy 対応 CNI を使用", "description": "Calico/Cilium など" }
      ]
    }
  ],
  "relatedTopics": ["Pod", "Ingress Controller", "Service Mesh", "セキュリティ"]
}
