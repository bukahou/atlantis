{
  "meta": {
    "title": "ワークロード",
    "description": "Kubernetes ワークロード：StatefulSet、DaemonSet、Job と CronJob",
    "order": 3,
    "tags": ["Kubernetes", "ワークロード", "StatefulSet", "DaemonSet", "Job"]
  },
  "sections": [
    {
      "type": "keyPoints",
      "title": "コアコンセプト",
      "items": [
        "Deployment はステートレスアプリケーションに最適",
        "StatefulSet は安定したネットワーク識別と永続ストレージを提供",
        "DaemonSet は各ノードで Pod を1つずつ実行",
        "Job/CronJob はバッチ処理と定期タスクに使用"
      ]
    },
    {
      "type": "cards",
      "title": "ワークロードタイプ",
      "layout": "grid",
      "columns": 2,
      "items": [
        {
          "title": "Deployment",
          "badge": "ステートレス",
          "badgeColor": "blue",
          "points": [
            "ステートレスアプリケーションのデプロイ",
            "ローリングアップデート/ロールバック",
            "Pod は任意に置き換え可能",
            "Web サービス、API に最適"
          ]
        },
        {
          "title": "StatefulSet",
          "badge": "ステートフル",
          "badgeColor": "green",
          "points": [
            "安定したネットワーク識別 (pod-0, pod-1)",
            "安定した永続ストレージ",
            "順序付きデプロイ/スケーリング",
            "データベース、メッセージキューに最適"
          ]
        },
        {
          "title": "DaemonSet",
          "badge": "ノードレベル",
          "badgeColor": "amber",
          "points": [
            "各ノードで Pod を1つ実行",
            "新しいノードに自動デプロイ",
            "ログ収集、監視エージェントに最適",
            "ノードレベルのシステムサービス"
          ]
        },
        {
          "title": "Job/CronJob",
          "badge": "バッチ処理",
          "badgeColor": "purple",
          "points": [
            "ワンタイムタスク (Job)",
            "定期タスク (CronJob)",
            "成功完了後に終了",
            "データ処理、バックアップに最適"
          ]
        }
      ]
    },
    {
      "type": "codeBlock",
      "title": "StatefulSet 例",
      "language": "yaml",
      "code": "apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: mysql\nspec:\n  serviceName: mysql  # Headless Service 名\n  replicas: 3\n  selector:\n    matchLabels:\n      app: mysql\n  template:\n    metadata:\n      labels:\n        app: mysql\n    spec:\n      containers:\n      - name: mysql\n        image: mysql:8.0\n        ports:\n        - containerPort: 3306\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql-secret\n              key: password\n        volumeMounts:\n        - name: data\n          mountPath: /var/lib/mysql\n  volumeClaimTemplates:  # 各 Pod に独立した PVC\n  - metadata:\n      name: data\n    spec:\n      accessModes: [\"ReadWriteOnce\"]\n      storageClassName: standard\n      resources:\n        requests:\n          storage: 10Gi\n---\n# Headless Service (clusterIP: None)\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql\nspec:\n  clusterIP: None\n  selector:\n    app: mysql\n  ports:\n  - port: 3306\n# Pod DNS: mysql-0.mysql.namespace.svc.cluster.local"
    },
    {
      "type": "table",
      "title": "Deployment vs StatefulSet",
      "highlightFirst": true,
      "headers": ["特性", "Deployment", "StatefulSet"],
      "rows": [
        ["Pod 名", "ランダムサフィックス (app-xyz)", "順序番号 (app-0, app-1)"],
        ["Pod 置き換え", "任意に置き換え可能", "同じ識別を維持"],
        ["ストレージ", "共有またはなし", "Pod ごとに独立した PVC"],
        ["スケーリング", "並列", "順序付き（1つずつ）"],
        ["更新戦略", "ローリングアップデート", "順序付き更新"],
        ["ユースケース", "ステートレスアプリケーション", "データベース/分散システム"]
      ]
    },
    {
      "type": "codeBlock",
      "title": "DaemonSet 例",
      "language": "yaml",
      "code": "apiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: fluentd\n  namespace: kube-system\nspec:\n  selector:\n    matchLabels:\n      name: fluentd\n  template:\n    metadata:\n      labels:\n        name: fluentd\n    spec:\n      tolerations:  # master ノードでの実行を許可\n      - key: node-role.kubernetes.io/control-plane\n        effect: NoSchedule\n      containers:\n      - name: fluentd\n        image: fluentd:v1.14\n        resources:\n          limits:\n            memory: 200Mi\n          requests:\n            cpu: 100m\n            memory: 200Mi\n        volumeMounts:\n        - name: varlog\n          mountPath: /var/log\n        - name: containers\n          mountPath: /var/lib/docker/containers\n          readOnly: true\n      volumes:\n      - name: varlog\n        hostPath:\n          path: /var/log\n      - name: containers\n        hostPath:\n          path: /var/lib/docker/containers"
    },
    {
      "type": "codeBlock",
      "title": "Job 例",
      "language": "yaml",
      "code": "apiVersion: batch/v1\nkind: Job\nmetadata:\n  name: data-migration\nspec:\n  ttlSecondsAfterFinished: 3600  # 完了後1時間でクリーンアップ\n  backoffLimit: 3                 # 最大リトライ回数\n  activeDeadlineSeconds: 600      # タイムアウト時間\n  template:\n    spec:\n      restartPolicy: Never        # Job は Never または OnFailure 必須\n      containers:\n      - name: migrate\n        image: myapp/migrate:v1\n        command: [\"./migrate.sh\"]\n        env:\n        - name: DATABASE_URL\n          valueFrom:\n            secretKeyRef:\n              name: db-secret\n              key: url\n---\n# 並列 Job\napiVersion: batch/v1\nkind: Job\nmetadata:\n  name: parallel-job\nspec:\n  completions: 10     # 成功完了が必要な Pod 数\n  parallelism: 3      # 並列実行する Pod 数\n  template:\n    spec:\n      restartPolicy: Never\n      containers:\n      - name: worker\n        image: myapp/worker:v1"
    },
    {
      "type": "codeBlock",
      "title": "CronJob 例",
      "language": "yaml",
      "code": "apiVersion: batch/v1\nkind: CronJob\nmetadata:\n  name: daily-backup\nspec:\n  schedule: \"0 2 * * *\"  # 毎日午前2時\n  timeZone: \"Asia/Tokyo\"  # タイムゾーン設定\n  concurrencyPolicy: Forbid  # 同時実行を禁止\n  successfulJobsHistoryLimit: 3\n  failedJobsHistoryLimit: 1\n  jobTemplate:\n    spec:\n      template:\n        spec:\n          restartPolicy: OnFailure\n          containers:\n          - name: backup\n            image: myapp/backup:v1\n            command: [\"/backup.sh\"]\n\n# schedule 形式: 分 時 日 月 曜日\n# */5 * * * *   5分ごと\n# 0 */2 * * *   2時間ごと\n# 0 0 * * 0     毎週日曜日午前0時"
    },
    {
      "type": "table",
      "title": "CronJob 同時実行ポリシー",
      "highlightFirst": true,
      "headers": ["ポリシー", "説明"],
      "rows": [
        ["Allow", "同時実行を許可（デフォルト）"],
        ["Forbid", "同時実行を禁止、新しいタスクをスキップ"],
        ["Replace", "実行中のタスクをキャンセルし、新しいタスクを開始"]
      ]
    },
    {
      "type": "list",
      "title": "ワークロード選択ガイド",
      "style": "check",
      "items": [
        { "label": "Web/API サービス", "description": "Deployment を使用" },
        { "label": "データベース/キャッシュ", "description": "StatefulSet + Headless Service を使用" },
        { "label": "ログ/監視エージェント", "description": "DaemonSet を使用" },
        { "label": "データ移行/ETL", "description": "Job を使用" },
        { "label": "定期バックアップ/クリーンアップ", "description": "CronJob を使用" }
      ]
    }
  ],
  "relatedTopics": ["Pod", "Deployment", "永続ストレージ", "スケジューリング"]
}
